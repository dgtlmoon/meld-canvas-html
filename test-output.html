<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meld Web Port - Diff Viewer</title>
    <style>
        :root {
            --line-height: 20px;
            --font-size: 13px;
            --font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size);
            overflow: hidden;
            background: #2e2e2e;
        }

        .header {
            background: #1e1e1e;
            color: #fff;
            padding: 10px 20px;
            border-bottom: 2px solid #0d7377;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: normal;
            margin: 0;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .controls label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            cursor: pointer;
        }

        .controls input[type="checkbox"] {
            cursor: pointer;
        }

        .diff-container {
            display: grid;
            grid-template-columns: 1fr 100px 1fr;
            height: calc(100vh - 50px);
            overflow: hidden;
        }

        .file-pane {
            overflow-y: auto;
            overflow-x: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: var(--font-family);
            font-size: var(--font-size);
            position: relative;
            scroll-behavior: auto; /* Override to allow manual smooth scrolling */
        }

        .file-pane .line {
            display: flex;
            line-height: var(--line-height);
            height: var(--line-height);
            white-space: pre;
        }

        .file-pane .line:hover {
            background: #2a2a2a;
        }

        .file-pane .line-num {
            display: inline-block;
            width: 50px;
            padding: 0 8px;
            text-align: right;
            color: #858585;
            user-select: none;
            flex-shrink: 0;
            border-right: 1px solid #3e3e3e;
        }

        .file-pane .line-content {
            padding: 0 8px;
            flex: 1;
        }

        /* Inline character-level diff highlighting */
        .inline-diff {
            background: rgba(255, 200, 100, 0.4);
            border-radius: 2px;
            padding: 0 1px;
        }

        /* Insert/delete markers using border-bottom on lines */
        .line.insert-marker-after {
            border-bottom: 1px solid rgba(140, 200, 140, 0.9);
            box-shadow: 0 1px 2px rgba(140, 200, 140, 0.5);
        }

        .line.delete-marker-after {
            border-bottom: 1px solid rgba(240, 140, 140, 0.9);
            box-shadow: 0 1px 2px rgba(240, 140, 140, 0.5);
        }

        /* Chunk highlighting */
        .chunk-insert {
            background: rgba(140, 200, 140, 0.2);
        }

        .chunk-delete {
            background: rgba(240, 140, 140, 0.2);
        }

        .chunk-replace {
            background: rgba(140, 180, 240, 0.2);
        }

        /* Hover and highlight states */
        .chunk-highlight {
            background: rgba(255, 255, 100, 0.3) !important;
        }

        .link-map {
            width: 100%;
            height: 100%;
            background: #2e2e2e;
            border-left: 1px solid #3e3e3e;
            border-right: 1px solid #3e3e3e;
        }

        .link-map path {
            cursor: pointer;
            transition: fill 0.15s ease, stroke 0.15s ease;
        }

        .link-map path:hover {
            fill-opacity: 0.6;
            stroke-width: 2;
        }

        .link-map path.highlighted {
            fill-opacity: 0.7;
            stroke-width: 2;
            filter: brightness(1.3);
        }

        .stats {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Meld Web Port - Diff Viewer (Proof of Concept)</h1>
        <div class="controls">
            <label>
                <input type="checkbox" id="use-webgl" checked>
                Use WebGL Rendering (faster for large diffs)
            </label>
        </div>
    </div>

    <div class="diff-container">
        <div class="file-pane" id="left-pane">
<div class="line chunk-replace" data-line="0"><span class="line-num">1</span><span class="line-content"># E-commerce System - Version <span class="inline-diff">1</span>.0</span></div>
<div class="line chunk-replace" data-line="1"><span class="line-num">2</span><span class="line-content"># <span class="inline-diff">B</span>a<span class="inline-diff">si</span>c implementation o<span class="inline-diff">f </span>s<span class="inline-diff">hopping cart</span> and <span class="inline-diff">ord</span>er <span class="inline-diff">pr</span>o<span class="inline-diff">cessi</span>n<span class="inline-diff">g</span></span></div>
<div class="line chunk-replace" data-line="2"><span class="line-num">3</span><span class="line-content"># Thi<span class="inline-diff">s</span> lin<span class="inline-diff">e will be DELETED in version 2.0</span></span></div>
<div class="line chunk-replace" data-line="3"><span class="line-num">4</span><span class="line-content"># <span class="inline-diff">An</span>oth<span class="inline-diff">er l</span>in<span class="inline-diff">e</span> th<span class="inline-diff">a</span>t<span class="inline-diff"> will be DELETED</span></span></div>
<div class="line chunk-replace" data-line="4"><span class="line-num">5</span><span class="line-content"># Yet another DELETED line for testing</span></div>
<div class="line " data-line="5"><span class="line-num">6</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="6"><span class="line-num">7</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="7"><span class="line-num">8</span><span class="line-content">import logging</span></div>
<div class="line " data-line="8"><span class="line-num">9</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line " data-line="9"><span class="line-num">10</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="10"><span class="line-num">11</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line chunk-delete" data-line="11"><span class="line-num">12</span><span class="line-content"># OLD logging level - will be DELETED</span></div>
<div class="line chunk-delete" data-line="12"><span class="line-num">13</span><span class="line-content"># debug_mode = True - DELETED LINE</span></div>
<div class="line " data-line="13"><span class="line-num">14</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="14"><span class="line-num">15</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="15"><span class="line-num">16</span><span class="line-content">    def __init__(self, id, name, price, category):</span></div>
<div class="line " data-line="16"><span class="line-num">17</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="17"><span class="line-num">18</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="18"><span class="line-num">19</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="19"><span class="line-num">20</span><span class="line-content">        self.category = category</span></div>
<div class="line " data-line="20"><span class="line-num">21</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-replace" data-line="21"><span class="line-num">22</span><span class="line-content">        <span class="inline-diff"># old_fi</span>el<span class="inline-diff">d</span> = <span class="inline-diff">None </span>-<span class="inline-diff"> DELETED LINE</span></span></div>
<div class="line " data-line="22"><span class="line-num">23</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="23"><span class="line-num">24</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line " data-line="24"><span class="line-num">25</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="25"><span class="line-num">26</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="26"><span class="line-num">27</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="27"><span class="line-num">28</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="28"><span class="line-num">29</span><span class="line-content">        return f&quot;{self.name} - ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="29"><span class="line-num">30</span><span class="line-content">        # old_method_logic - DELETED</span></div>
<div class="line " data-line="30"><span class="line-num">31</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="31"><span class="line-num">32</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="32"><span class="line-num">33</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line " data-line="33"><span class="line-num">34</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="34"><span class="line-num">35</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line chunk-delete" data-line="35"><span class="line-num">36</span><span class="line-content">        # deprecated_field - DELETED LINE</span></div>
<div class="line " data-line="36"><span class="line-num">37</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="37"><span class="line-num">38</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="38"><span class="line-num">39</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="39"><span class="line-num">40</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="40"><span class="line-num">41</span><span class="line-content">def <span class="inline-diff">calc</span>u<span class="inline-diff">l</span>ate_t<span class="inline-diff">otal(</span>ite<span class="inline-diff">ms</span>):</span></div>
<div class="line chunk-replace" data-line="41"><span class="line-num">42</span><span class="line-content">    t<span class="inline-diff">o</span>t<span class="inline-diff">al</span> = <span class="inline-diff">Decimal(&#x27;</span>0<span class="inline-diff">&#x27;)</span></span></div>
<div class="line " data-line="42"><span class="line-num">43</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="43"><span class="line-num">44</span><span class="line-content">        total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="44"><span class="line-num">45</span><span class="line-content">    return total</span></div>
<div class="line " data-line="45"><span class="line-num">46</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="46"><span class="line-num">47</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="47"><span class="line-num">48</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="48"><span class="line-num">49</span><span class="line-content">    total = calculate_total(items)</span></div>
<div class="line chunk-replace" data-line="49"><span class="line-num">50</span><span class="line-content">    # OLD COMMENT: legacy tax calculation - DELETED</span></div>
<div class="line " data-line="50"><span class="line-num">51</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="51"><span class="line-num">52</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="52"><span class="line-num">53</span><span class="line-content">        discount<span class="inline-diff"> = </span>total<span class="inline-diff"> *</span> Decimal(&#x27;0.1&#x27;)</span></div>
<div class="line chunk-replace" data-line="53"><span class="line-num">54</span><span class="line-content">        total = total - discount</span></div>
<div class="line " data-line="54"><span class="line-num">55</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="55"><span class="line-num">56</span><span class="line-content">    return total</span></div>
<div class="line " data-line="56"><span class="line-num">57</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="57"><span class="line-num">58</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="58"><span class="line-num">59</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="59"><span class="line-num">60</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="60"><span class="line-num">61</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-replace" data-line="61"><span class="line-num">62</span><span class="line-content">        <span class="inline-diff"># o</span>ld_<span class="inline-diff">c</span>a<span class="inline-diff">r</span>t<span class="inline-diff">_id</span> = <span class="inline-diff">Non</span>e<span class="inline-diff"> - DELETED LINE</span></span></div>
<div class="line " data-line="62"><span class="line-num">63</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="63"><span class="line-num">64</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line " data-line="64"><span class="line-num">65</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="65"><span class="line-num">66</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line " data-line="66"><span class="line-num">67</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="67"><span class="line-num">68</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="68"><span class="line-num">69</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line " data-line="69"><span class="line-num">70</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="70"><span class="line-num">71</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="71"><span class="line-num">72</span><span class="line-content">        return calculate_total(self.items)</span></div>
<div class="line " data-line="72"><span class="line-num">73</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="73"><span class="line-num">74</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="74"><span class="line-num">75</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="75"><span class="line-num">76</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="76"><span class="line-num">77</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="77"><span class="line-num">78</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="78"><span class="line-num">79</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="79"><span class="line-num">80</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="80"><span class="line-num">81</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="81"><span class="line-num">82</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line " data-line="82"><span class="line-num">83</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="83"><span class="line-num">84</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="84"><span class="line-num">85</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="85"><span class="line-num">86</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="86"><span class="line-num">87</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="87"><span class="line-num">88</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="88"><span class="line-num">89</span><span class="line-content">        <span class="inline-diff">logger.info(f&quot;Order confirmed for {</span>self.cu<span class="inline-diff">sto</span>mer<span class="inline-diff">}&quot;</span>)</span></div>
<div class="line " data-line="89"><span class="line-num">90</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="90"><span class="line-num">91</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="91"><span class="line-num">92</span><span class="line-content">    def __init__(self, name, email):</span></div>
<div class="line " data-line="92"><span class="line-num">93</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="93"><span class="line-num">94</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="94"><span class="line-num">95</span><span class="line-content">        self.o<span class="inline-diff">rd</span>e<span class="inline-diff">rs</span> = <span class="inline-diff">[]</span></span></div>
<div class="line " data-line="95"><span class="line-num">96</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="96"><span class="line-num">97</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line " data-line="97"><span class="line-num">98</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="98"><span class="line-num">99</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="99"><span class="line-num">100</span><span class="line-content">        return order</span></div>
<div class="line " data-line="100"><span class="line-num">101</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="101"><span class="line-num">102</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="102"><span class="line-num">103</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="103"><span class="line-num">104</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="104"><span class="line-num">105</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="105"><span class="line-num">106</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="106"><span class="line-num">107</span><span class="line-content">    <span class="inline-diff">re</span>t<span class="inline-diff">urn &quot;@&quot; in</span> email<span class="inline-diff"> and &quot;.&quot; in email</span></span></div>
<div class="line chunk-replace" data-line="107"><span class="line-num">108</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="108"><span class="line-num">109</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="109"><span class="line-num">110</span><span class="line-content"># SECTION 2: Additional Helper Functions</span></div>
<div class="line chunk-replace" data-line="110"><span class="line-num">111</span><span class="line-content"># <span class="inline-diff">These lines will be DELETED or MODIFIED</span></span></div>
<div class="line chunk-replace" data-line="111"><span class="line-num">112</span><span class="line-content"># <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="112"><span class="line-num">113</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="113"><span class="line-num">114</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">calculate_shipping(weight, distance):</span></span></div>
<div class="line chunk-replace" data-line="114"><span class="line-num">115</span><span class="line-content">    # OLD shipping calculation - DELETED</span></div>
<div class="line chunk-replace" data-line="115"><span class="line-num">116</span><span class="line-content"> <span class="inline-diff">   b</span>a<span class="inline-diff">se_r</span>ate =<span class="inline-diff"> 5.00</span></span></div>
<div class="line chunk-replace" data-line="116"><span class="line-num">117</span><span class="line-content">    ret<span class="inline-diff">ur</span>n<span class="inline-diff"> base_rate + (weight * 0.5)</span></span></div>
<div class="line chunk-replace" data-line="117"><span class="line-num">118</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="118"><span class="line-num">119</span><span class="line-content"><span class="inline-diff">d</span>e<span class="inline-diff">f apply_</span>t<span class="inline-diff">ax(amount, tax</span>_rate=0.0<span class="inline-diff">7):</span></span></div>
<div class="line chunk-replace" data-line="119"><span class="line-num">120</span><span class="line-content">    <span class="inline-diff">#</span> <span class="inline-diff">S</span>im<span class="inline-diff">ple tax c</span>al<span class="inline-diff">culation - will be REPLACED</span></span></div>
<div class="line chunk-replace" data-line="120"><span class="line-num">121</span><span class="line-content">    return amount * (1 + tax_rate)</span></div>
<div class="line chunk-replace" data-line="121"><span class="line-num">122</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="122"><span class="line-num">123</span><span class="line-content"># OLD function - will be DELETED</span></div>
<div class="line chunk-replace" data-line="123"><span class="line-num">124</span><span class="line-content"><span class="inline-diff">de</span>f <span class="inline-diff">l</span>e<span class="inline-diff">gacy_di</span>s<span class="inline-diff">count(amount)</span>:</span></div>
<div class="line chunk-replace" data-line="124"><span class="line-num">125</span><span class="line-content">    i<span class="inline-diff">f </span>a<span class="inline-diff">mount &gt; </span>5<span class="inline-diff">0:</span></span></div>
<div class="line chunk-replace" data-line="125"><span class="line-num">126</span><span class="line-content">        return amount * 0.95</span></div>
<div class="line chunk-replace" data-line="126"><span class="line-num">127</span><span class="line-content">    return a<span class="inline-diff">mount</span></span></div>
<div class="line " data-line="127"><span class="line-num">128</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="128"><span class="line-num">129</span><span class="line-content">class PaymentProcessor:</span></div>
<div class="line chunk-replace" data-line="129"><span class="line-num">130</span><span class="line-content">    <span class="inline-diff">#</span> <span class="inline-diff">OLD</span> payment s<span class="inline-diff">y</span>s<span class="inline-diff">tem - many l</span>in<span class="inline-diff">es</span> will<span class="inline-diff"> b</span>e <span class="inline-diff">DELETED</span></span></div>
<div class="line chunk-replace" data-line="130"><span class="line-num">131</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="131"><span class="line-num">132</span><span class="line-content">        self.<span class="inline-diff">a</span>pi<span class="inline-diff">_k</span>e<span class="inline-diff">y</span> = <span class="inline-diff">&quot;</span>o<span class="inline-diff">l</span>d<span class="inline-diff">_api_k</span>e<span class="inline-diff">y&quot;</span></span></div>
<div class="line chunk-replace" data-line="132"><span class="line-num">133</span><span class="line-content">        self.e<span class="inline-diff">ndpoint</span> = <span class="inline-diff">&quot;h</span>t<span class="inline-diff">tps://old-payment-</span>api<span class="inline-diff">.</span>e<span class="inline-diff">xam</span>p<span class="inline-diff">l</span>e<span class="inline-diff">.com&quot;</span></span></div>
<div class="line chunk-replace" data-line="133"><span class="line-num">134</span><span class="line-content">        <span class="inline-diff"># deprecated_fi</span>eld = <span class="inline-diff">N</span>one<span class="inline-diff"> - DELETED</span></span></div>
<div class="line chunk-replace" data-line="134"><span class="line-num">135</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="135"><span class="line-num">136</span><span class="line-content">    def p<span class="inline-diff">roc</span>e<span class="inline-diff">ss_pa</span>y<span class="inline-diff">ment</span>(self, <span class="inline-diff">am</span>o<span class="inline-diff">unt, car</span>d<span class="inline-diff">_numb</span>er):</span></div>
<div class="line chunk-replace" data-line="136"><span class="line-num">137</span><span class="line-content">        <span class="inline-diff">#</span> <span class="inline-diff">Old</span> <span class="inline-diff">implementation - will be REPLACED</span></span></div>
<div class="line chunk-replace" data-line="137"><span class="line-num">138</span><span class="line-content">        <span class="inline-diff">return</span> <span class="inline-diff">{</span>&quot;st<span class="inline-diff">atus</span>&quot;: &quot;s<span class="inline-diff">ucc</span>es<span class="inline-diff">s</span>&quot;,<span class="inline-diff"> &quot;transaction_id&quot;: &quot;12345&quot;}</span></span></div>
<div class="line chunk-replace" data-line="138"><span class="line-num">139</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="139"><span class="line-num">140</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">refund(self,</span> <span class="inline-diff">transaction_id):</span></span></div>
<div class="line chunk-replace" data-line="140"><span class="line-num">141</span><span class="line-content">        <span class="inline-diff"># Old </span>refu<span class="inline-diff">nd </span>l<span class="inline-diff">ogic - DELETED</span></span></div>
<div class="line chunk-replace" data-line="141"><span class="line-num">142</span><span class="line-content">        return True</span></div>
<div class="line chunk-replace" data-line="142"><span class="line-num">143</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="143"><span class="line-num">144</span><span class="line-content"><span class="inline-diff">#</span> =<span class="inline-diff">===========================================</span></span></div>
<div class="line chunk-replace" data-line="144"><span class="line-num">145</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">SECTION</span> <span class="inline-diff">3</span>: <span class="inline-diff">In</span>v<span class="inline-diff">entory Management</span></span></div>
<div class="line chunk-replace" data-line="145"><span class="line-num">146</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">M</span>i<span class="inline-diff">x </span>o<span class="inline-diff">f DELETIONS</span>,<span class="inline-diff"> INSERTIONS, and REPLACEMENTS</span></span></div>
<div class="line " data-line="146"><span class="line-num">147</span><span class="line-content"># ============================================</span></div>
<div class="line " data-line="147"><span class="line-num">148</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="148"><span class="line-num">149</span><span class="line-content">class Inventory:</span></div>
<div class="line chunk-replace" data-line="149"><span class="line-num">150</span><span class="line-content">    d<span class="inline-diff">ef</span> <span class="inline-diff">__</span>init<span class="inline-diff">__(</span>se<span class="inline-diff">lf):</span></span></div>
<div class="line " data-line="150"><span class="line-num">151</span><span class="line-content">        self.items = {}</span></div>
<div class="line chunk-replace" data-line="151"><span class="line-num">152</span><span class="line-content">        <span class="inline-diff"># </span>o<span class="inline-diff">ld_tracking</span>_id = <span class="inline-diff">N</span>o<span class="inline-diff">n</span>e <span class="inline-diff">-</span> DEL<span class="inline-diff">E</span>T<span class="inline-diff">ED</span></span></div>
<div class="line " data-line="152"><span class="line-num">153</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="153"><span class="line-num">154</span><span class="line-content">    def add_product(self, product_id, quantity):</span></div>
<div class="line " data-line="154"><span class="line-num">155</span><span class="line-content">        if product_id in self.items:</span></div>
<div class="line " data-line="155"><span class="line-num">156</span><span class="line-content">            self.items[product_id] += quantity</span></div>
<div class="line " data-line="156"><span class="line-num">157</span><span class="line-content">        else:</span></div>
<div class="line " data-line="157"><span class="line-num">158</span><span class="line-content">            self.items[product_id] = quantity</span></div>
<div class="line " data-line="158"><span class="line-num">159</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="159"><span class="line-num">160</span><span class="line-content">    def remove_product(self, product_id, quantity):</span></div>
<div class="line chunk-replace" data-line="160"><span class="line-num">161</span><span class="line-content">        if product_id in self.items:</span></div>
<div class="line chunk-replace" data-line="161"><span class="line-num">162</span><span class="line-content">            se<span class="inline-diff">l</span>f<span class="inline-diff">.i</span>t<span class="inline-diff">ems[</span>product_id<span class="inline-diff">]</span> <span class="inline-diff">-=</span> <span class="inline-diff">q</span>u<span class="inline-diff">a</span>n<span class="inline-diff">tity</span></span></div>
<div class="line chunk-replace" data-line="162"><span class="line-num">163</span><span class="line-content">            if self.items[product_id] &lt;= 0:</span></div>
<div class="line chunk-replace" data-line="163"><span class="line-num">164</span><span class="line-content">        <span class="inline-diff">        del</span> self.items[product_id]</span></div>
<div class="line chunk-replace" data-line="164"><span class="line-num">165</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="165"><span class="line-num">166</span><span class="line-content">    def check_availability(self, product_id):</span></div>
<div class="line chunk-replace" data-line="166"><span class="line-num">167</span><span class="line-content">       <span class="inline-diff"> return</span> self.items<span class="inline-diff">.get(</span>product_id<span class="inline-diff">,</span> <span class="inline-diff">0)</span></span></div>
<div class="line chunk-replace" data-line="167"><span class="line-num">168</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="168"><span class="line-num">169</span><span class="line-content">    <span class="inline-diff">#</span> <span class="inline-diff">OLD</span> m<span class="inline-diff">eth</span>od <span class="inline-diff">-</span> <span class="inline-diff">will be DELETED</span></span></div>
<div class="line chunk-replace" data-line="169"><span class="line-num">170</span><span class="line-content">    de<span class="inline-diff">f</span> <span class="inline-diff">legacy_stock_report(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="170"><span class="line-num">171</span><span class="line-content">        for pid, qty in self.items.items():</span></div>
<div class="line chunk-replace" data-line="171"><span class="line-num">172</span><span class="line-content">        <span class="inline-diff">    p</span>rin<span class="inline-diff">t</span>(f&quot;<span class="inline-diff">Pr</span>od<span class="inline-diff">uct {pid}:</span> {qty} units&quot;)</span></div>
<div class="line chunk-replace" data-line="172"><span class="line-num">173</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="173"><span class="line-num">174</span><span class="line-content"><span class="inline-diff">#</span> =<span class="inline-diff">===========================================</span></span></div>
<div class="line chunk-replace" data-line="174"><span class="line-num">175</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">S</span>E<span class="inline-diff">CTION 4</span>: <span class="inline-diff">D</span>is<span class="inline-diff">count</span> a<span class="inline-diff">nd Promot</span>i<span class="inline-diff">on Syst</span>e<span class="inline-diff">m</span></span></div>
<div class="line chunk-replace" data-line="175"><span class="line-num">176</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">H</span>e<span class="inline-diff">avy</span> mod<span class="inline-diff">ifications expe</span>ct<span class="inline-diff">e</span>d <span class="inline-diff">here</span></span></div>
<div class="line " data-line="176"><span class="line-num">177</span><span class="line-content"># ============================================</span></div>
<div class="line " data-line="177"><span class="line-num">178</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="178"><span class="line-num">179</span><span class="line-content">class DiscountCode:</span></div>
<div class="line chunk-replace" data-line="179"><span class="line-num">180</span><span class="line-content">    <span class="inline-diff">#</span> <span class="inline-diff">OLD</span> discount system <span class="inline-diff">-</span> <span class="inline-diff">DELETED</span></span></div>
<div class="line chunk-replace" data-line="180"><span class="line-num">181</span><span class="line-content">    def __init__(self, code, amount):</span></div>
<div class="line " data-line="181"><span class="line-num">182</span><span class="line-content">        self.code = code</span></div>
<div class="line chunk-replace" data-line="182"><span class="line-num">183</span><span class="line-content">        self.amount = amount</span></div>
<div class="line chunk-replace" data-line="183"><span class="line-num">184</span><span class="line-content">        self.u<span class="inline-diff">s</span>e<span class="inline-diff">d</span> = <span class="inline-diff">Fal</span>se</span></div>
<div class="line " data-line="184"><span class="line-num">185</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="185"><span class="line-num">186</span><span class="line-content">    def apply(self, total):</span></div>
<div class="line chunk-replace" data-line="186"><span class="line-num">187</span><span class="line-content">        <span class="inline-diff">#</span> <span class="inline-diff">Sim</span>pl<span class="inline-diff">e percentage</span> discount <span class="inline-diff">-</span> <span class="inline-diff">REPLACED</span></span></div>
<div class="line chunk-replace" data-line="187"><span class="line-num">188</span><span class="line-content">        if not self.<span class="inline-diff">u</span>s<span class="inline-diff">e</span>d:</span></div>
<div class="line chunk-replace" data-line="188"><span class="line-num">189</span><span class="line-content">            sel<span class="inline-diff">f.</span>used <span class="inline-diff">=</span> <span class="inline-diff">Tr</span>ue</span></div>
<div class="line chunk-replace" data-line="189"><span class="line-num">190</span><span class="line-content">            return total * (1 - self.amount)</span></div>
<div class="line " data-line="190"><span class="line-num">191</span><span class="line-content">        return total</span></div>
<div class="line " data-line="191"><span class="line-num">192</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="192"><span class="line-num">193</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">OLD p</span>romotion<span class="inline-diff">al class - D</span>E<span class="inline-diff">LETED</span></span></div>
<div class="line chunk-replace" data-line="193"><span class="line-num">194</span><span class="line-content"><span class="inline-diff">class</span> <span class="inline-diff">S</span>e<span class="inline-diff">aso</span>nal<span class="inline-diff">P</span>romotion<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="194"><span class="line-num">195</span><span class="line-content">    def __init__(self<span class="inline-diff">, name, discount_rate</span>):</span></div>
<div class="line chunk-replace" data-line="195"><span class="line-num">196</span><span class="line-content">        self.n<span class="inline-diff">ame</span> = <span class="inline-diff">name</span></span></div>
<div class="line chunk-replace" data-line="196"><span class="line-num">197</span><span class="line-content">        self.discount_rate = discount_rate</span></div>
<div class="line chunk-replace" data-line="197"><span class="line-num">198</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="198"><span class="line-num">199</span><span class="line-content">    <span class="inline-diff">d</span>ef<span class="inline-diff"> is_</span>active<span class="inline-diff">(</span>se<span class="inline-diff">lf):</span></span></div>
<div class="line chunk-replace" data-line="199"><span class="line-num">200</span><span class="line-content">        # Check if promotion is currently active</span></div>
<div class="line chunk-replace" data-line="200"><span class="line-num">201</span><span class="line-content">     <span class="inline-diff">   r</span>et<span class="inline-diff">u</span>rn <span class="inline-diff">True</span></span></div>
<div class="line chunk-replace" data-line="201"><span class="line-num">202</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="202"><span class="line-num">203</span><span class="line-content"><span class="inline-diff">#</span> =<span class="inline-diff">===========================================</span></span></div>
<div class="line chunk-replace" data-line="203"><span class="line-num">204</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">SECTIO</span>N<span class="inline-diff"> 5: R</span>e<span class="inline-diff">porting and Analytics</span></span></div>
<div class="line chunk-replace" data-line="204"><span class="line-num">205</span><span class="line-content"># Some functions will be DELETED, others MODIFIED</span></div>
<div class="line chunk-replace" data-line="205"><span class="line-num">206</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="206"><span class="line-num">207</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="207"><span class="line-num">208</span><span class="line-content">d<span class="inline-diff">ef ge</span>n<span class="inline-diff">era</span>te<span class="inline-diff">_s</span>al<span class="inline-diff">es_report(start_date, end_date</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="208"><span class="line-num">209</span><span class="line-content">    <span class="inline-diff">#</span> <span class="inline-diff">OLD</span> <span class="inline-diff">rep</span>o<span class="inline-diff">r</span>t<span class="inline-diff">i</span>n<span class="inline-diff">g</span> l<span class="inline-diff">ogic</span> - <span class="inline-diff">w</span>i<span class="inline-diff">ll b</span>e<span class="inline-diff"> REPLACED</span></span></div>
<div class="line chunk-replace" data-line="209"><span class="line-num">210</span><span class="line-content">    <span class="inline-diff">pr</span>int<span class="inline-diff">(f&quot;S</span>a<span class="inline-diff">l</span>es<span class="inline-diff"> report from {star</span>t_d<span class="inline-diff">a</span>t<span class="inline-diff">e} to {end_date}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="210"><span class="line-num">211</span><span class="line-content">    <span class="inline-diff">return</span> <span class="inline-diff">{&quot;total_sal</span>es<span class="inline-diff">&quot;:</span> <span class="inline-diff">1000,</span> <span class="inline-diff">&quot;</span>tot<span class="inline-diff">al_orders&quot;: 50}</span></span></div>
<div class="line chunk-replace" data-line="211"><span class="line-num">212</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="212"><span class="line-num">213</span><span class="line-content">def calculate_revenue(orders):</span></div>
<div class="line chunk-replace" data-line="213"><span class="line-num">214</span><span class="line-content">    tot<span class="inline-diff">al = 0</span></span></div>
<div class="line " data-line="214"><span class="line-num">215</span><span class="line-content">    for order in orders:</span></div>
<div class="line chunk-replace" data-line="215"><span class="line-num">216</span><span class="line-content">        total <span class="inline-diff">+</span>= order.get_total()</span></div>
<div class="line " data-line="216"><span class="line-num">217</span><span class="line-content">    return total</span></div>
<div class="line " data-line="217"><span class="line-num">218</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="218"><span class="line-num">219</span><span class="line-content"><span class="inline-diff"># OLD</span> analyti<span class="inline-diff">cs funct</span>io<span class="inline-diff">n - DELETED</span></span></div>
<div class="line chunk-replace" data-line="219"><span class="line-num">220</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">track_</span>user<span class="inline-diff">_</span>behavior<span class="inline-diff">(user_id,</span> a<span class="inline-diff">c</span>ti<span class="inline-diff">on):</span></span></div>
<div class="line chunk-replace" data-line="220"><span class="line-num">221</span><span class="line-content">    <span class="inline-diff">p</span>r<span class="inline-diff">i</span>n<span class="inline-diff">t(f&quot;User</span> {<span class="inline-diff">user_id} performed {action}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="221"><span class="line-num">222</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="222"><span class="line-num">223</span><span class="line-content">d<span class="inline-diff">ef export</span>_dat<span class="inline-diff">a(f</span>o<span class="inline-diff">rmat=&quot;csv&quot;):</span></span></div>
<div class="line chunk-replace" data-line="223"><span class="line-num">224</span><span class="line-content">    <span class="inline-diff">#</span> <span class="inline-diff">OLD</span> <span class="inline-diff">exp</span>or<span class="inline-diff">t</span> <span class="inline-diff">logic - will be MODIFIED</span></span></div>
<div class="line chunk-replace" data-line="224"><span class="line-num">225</span><span class="line-content">    i<span class="inline-diff">f for</span>ma<span class="inline-diff">t == &quot;csv&quot;:</span></span></div>
<div class="line chunk-replace" data-line="225"><span class="line-num">226</span><span class="line-content">        re<span class="inline-diff">t</span>u<span class="inline-diff">rn</span> <span class="inline-diff">&quot;d</span>a<span class="inline-diff">ta</span>.<span class="inline-diff">csv&quot;</span></span></div>
<div class="line chunk-replace" data-line="226"><span class="line-num">227</span><span class="line-content">    ret<span class="inline-diff">u</span>rn &quot;<span class="inline-diff">data.j</span>s<span class="inline-diff">on</span>&quot;</span></div>
<div class="line chunk-replace" data-line="227"><span class="line-num">228</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="228"><span class="line-num">229</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-replace" data-line="229"><span class="line-num">230</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">SECTION 6: Us</span>er<span class="inline-diff"> Au</span>t<span class="inline-diff">hentic</span>at<span class="inline-diff">i</span>on</span></div>
<div class="line chunk-replace" data-line="230"><span class="line-num">231</span><span class="line-content"><span class="inline-diff">#</span> Wil<span class="inline-diff">l be com</span>plet<span class="inline-diff">ely REPLACED in v2</span></span></div>
<div class="line chunk-replace" data-line="231"><span class="line-num">232</span><span class="line-content"><span class="inline-diff">#</span> =<span class="inline-diff">===========================================</span></span></div>
<div class="line " data-line="232"><span class="line-num">233</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="233"><span class="line-num">234</span><span class="line-content">class User:</span></div>
<div class="line chunk-replace" data-line="234"><span class="line-num">235</span><span class="line-content">    <span class="inline-diff">#</span> <span class="inline-diff">OLD</span> user model <span class="inline-diff">-</span> <span class="inline-diff">DELETED</span> <span class="inline-diff">f</span>i<span class="inline-diff">elds</span></span></div>
<div class="line chunk-replace" data-line="235"><span class="line-num">236</span><span class="line-content">    def __init__(self, username, password):</span></div>
<div class="line " data-line="236"><span class="line-num">237</span><span class="line-content">        self.username = username</span></div>
<div class="line chunk-replace" data-line="237"><span class="line-num">238</span><span class="line-content">        self.<span class="inline-diff">p</span>a<span class="inline-diff">ssword</span> = <span class="inline-diff">p</span>a<span class="inline-diff">ssword</span></span></div>
<div class="line " data-line="238"><span class="line-num">239</span><span class="line-content">        self.is_active = True</span></div>
<div class="line chunk-replace" data-line="239"><span class="line-num">240</span><span class="line-content">        <span class="inline-diff"># o</span>ld_<span class="inline-diff">session_id</span> = <span class="inline-diff">N</span>o<span class="inline-diff">ne - DELETED</span></span></div>
<div class="line " data-line="240"><span class="line-num">241</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="241"><span class="line-num">242</span><span class="line-content">    def authenticate(self, password):</span></div>
<div class="line chunk-replace" data-line="242"><span class="line-num">243</span><span class="line-content">        <span class="inline-diff">#</span> S<span class="inline-diff">impl</span>e password c<span class="inline-diff">heck - INSECURE, w</span>i<span class="inline-diff">ll be REPLACED</span></span></div>
<div class="line chunk-replace" data-line="243"><span class="line-num">244</span><span class="line-content">       <span class="inline-diff"> return self.password ==</span> password</span></div>
<div class="line chunk-replace" data-line="244"><span class="line-num">245</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="245"><span class="line-num">246</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">reset_password(</span>self<span class="inline-diff">, new_p</span>as<span class="inline-diff">s</span>w<span class="inline-diff">ord</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="246"><span class="line-num">247</span><span class="line-content">        <span class="inline-diff">s</span>e<span class="inline-diff">lf.passwo</span>r<span class="inline-diff">d</span> <span class="inline-diff">= n</span>e<span class="inline-diff">w_password</span></span></div>
<div class="line chunk-replace" data-line="247"><span class="line-num">248</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="248"><span class="line-num">249</span><span class="line-content"># OLD session management - DELETED</span></div>
<div class="line chunk-replace" data-line="249"><span class="line-num">250</span><span class="line-content">def <span class="inline-diff">c</span>re<span class="inline-diff">ate_</span>sess<span class="inline-diff">i</span>o<span class="inline-diff">n</span>(<span class="inline-diff">u</span>ser):</span></div>
<div class="line chunk-replace" data-line="250"><span class="line-num">251</span><span class="line-content">    <span class="inline-diff">return</span> <span class="inline-diff">{</span>&quot;<span class="inline-diff">user_id</span>&quot;: <span class="inline-diff">u</span>s<span class="inline-diff">e</span>r<span class="inline-diff">.username,</span> <span class="inline-diff">&quot;expi</span>res&quot;<span class="inline-diff">: </span>&quot;<span class="inline-diff">2024-12-31</span>&quot;<span class="inline-diff">}</span></span></div>
<div class="line chunk-replace" data-line="251"><span class="line-num">252</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="252"><span class="line-num">253</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="253"><span class="line-num">254</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">SECTION</span> <span class="inline-diff">7:</span> <span class="inline-diff">No</span>t<span class="inline-diff">ificatio</span>n <span class="inline-diff">Syst</span>e<span class="inline-diff">m</span></span></div>
<div class="line chunk-replace" data-line="254"><span class="line-num">255</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">Mix</span> <span class="inline-diff">of</span> <span class="inline-diff">ch</span>a<span class="inline-diff">ng</span>e<span class="inline-diff">s</span></span></div>
<div class="line chunk-replace" data-line="255"><span class="line-num">256</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-replace" data-line="256"><span class="line-num">257</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="257"><span class="line-num">258</span><span class="line-content"><span class="inline-diff">d</span>e<span class="inline-diff">f </span>sen<span class="inline-diff">d_em</span>ai<span class="inline-diff">l(t</span>o<span class="inline-diff">, subject, body):</span></span></div>
<div class="line chunk-replace" data-line="258"><span class="line-num">259</span><span class="line-content">    <span class="inline-diff">#</span> <span class="inline-diff">OLD</span> email<span class="inline-diff"> </span>se<span class="inline-diff">nd</span>i<span class="inline-diff">ng - DELETED</span></span></div>
<div class="line chunk-replace" data-line="259"><span class="line-num">260</span><span class="line-content">    <span class="inline-diff">p</span>r<span class="inline-diff">i</span>n<span class="inline-diff">t(f&quot;Sending email to</span> {<span class="inline-diff">to}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="260"><span class="line-num">261</span><span class="line-content">    <span class="inline-diff">p</span>ri<span class="inline-diff">nt(f</span>&quot;<span class="inline-diff">Subject</span>: <span class="inline-diff">{</span>su<span class="inline-diff">bj</span>e<span class="inline-diff">ct}&quot;)</span></span></div>
<div class="line " data-line="261"><span class="line-num">262</span><span class="line-content">    return True</span></div>
<div class="line " data-line="262"><span class="line-num">263</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="263"><span class="line-num">264</span><span class="line-content">def send_sms(phone, message):</span></div>
<div class="line chunk-delete" data-line="264"><span class="line-num">265</span><span class="line-content">    # OLD SMS service - will be REPLACED</span></div>
<div class="line chunk-delete" data-line="265"><span class="line-num">266</span><span class="line-content">    print(f&quot;SMS to {phone}: {message}&quot;)</span></div>
<div class="line chunk-delete" data-line="266"><span class="line-num">267</span><span class="line-content">    return True</span></div>
<div class="line chunk-delete" data-line="267"><span class="line-num">268</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="268"><span class="line-num">269</span><span class="line-content"># OLD notification class - DELETED</span></div>
<div class="line chunk-delete" data-line="269"><span class="line-num">270</span><span class="line-content">class NotificationManager:</span></div>
<div class="line chunk-delete" data-line="270"><span class="line-num">271</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-delete" data-line="271"><span class="line-num">272</span><span class="line-content">        self.pending = []</span></div>
<div class="line chunk-delete" data-line="272"><span class="line-num">273</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="273"><span class="line-num">274</span><span class="line-content">    def queue_notification(self, recipient, message):</span></div>
<div class="line chunk-delete" data-line="274"><span class="line-num">275</span><span class="line-content">        self.pending.append({&quot;to&quot;: recipient, &quot;msg&quot;: message})</span></div>
<div class="line chunk-delete" data-line="275"><span class="line-num">276</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="276"><span class="line-num">277</span><span class="line-content">    def send_all(self):</span></div>
<div class="line chunk-delete" data-line="277"><span class="line-num">278</span><span class="line-content">        for notif in self.pending:</span></div>
<div class="line chunk-delete" data-line="278"><span class="line-num">279</span><span class="line-content">            print(f&quot;Sending: {notif}&quot;)</span></div>
<div class="line chunk-delete" data-line="279"><span class="line-num">280</span><span class="line-content">        self.pending = []</span></div>
<div class="line chunk-delete" data-line="280"><span class="line-num">281</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="281"><span class="line-num">282</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-delete" data-line="282"><span class="line-num">283</span><span class="line-content"># SECTION 8: Configuration and Settings</span></div>
<div class="line chunk-delete" data-line="283"><span class="line-num">284</span><span class="line-content"># Will have DELETIONS</span></div>
<div class="line chunk-delete" data-line="284"><span class="line-num">285</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-delete" data-line="285"><span class="line-num">286</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="286"><span class="line-num">287</span><span class="line-content"># Global configuration - OLD values, will be DELETED</span></div>
<div class="line chunk-delete" data-line="287"><span class="line-num">288</span><span class="line-content">CONFIG = {</span></div>
<div class="line chunk-delete" data-line="288"><span class="line-num">289</span><span class="line-content">    &quot;app_name&quot;: &quot;E-commerce v1.0&quot;,</span></div>
<div class="line chunk-delete" data-line="289"><span class="line-num">290</span><span class="line-content">    &quot;debug_mode&quot;: True,</span></div>
<div class="line chunk-delete" data-line="290"><span class="line-num">291</span><span class="line-content">    &quot;max_cart_items&quot;: 100,</span></div>
<div class="line chunk-delete" data-line="291"><span class="line-num">292</span><span class="line-content">    &quot;session_timeout&quot;: 3600,</span></div>
<div class="line chunk-delete" data-line="292"><span class="line-num">293</span><span class="line-content">    # old_api_endpoint - DELETED</span></div>
<div class="line chunk-delete" data-line="293"><span class="line-num">294</span><span class="line-content">}</span></div>
<div class="line chunk-delete" data-line="294"><span class="line-num">295</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="295"><span class="line-num">296</span><span class="line-content">def get_config(key):</span></div>
<div class="line chunk-delete" data-line="296"><span class="line-num">297</span><span class="line-content">    return CONFIG.get(key)</span></div>
<div class="line chunk-delete" data-line="297"><span class="line-num">298</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="298"><span class="line-num">299</span><span class="line-content">def set_config(key, value):</span></div>
<div class="line chunk-delete" data-line="299"><span class="line-num">300</span><span class="line-content">    CONFIG[key] = value</span></div>
<div class="line chunk-delete" data-line="300"><span class="line-num">301</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="301"><span class="line-num">302</span><span class="line-content"># OLD initialization - DELETED</span></div>
<div class="line chunk-delete" data-line="302"><span class="line-num">303</span><span class="line-content">def initialize_app():</span></div>
<div class="line chunk-delete" data-line="303"><span class="line-num">304</span><span class="line-content">    print(&quot;Initializing application v1.0&quot;)</span></div>
<div class="line chunk-delete" data-line="304"><span class="line-num">305</span><span class="line-content">    return True</span></div>
<div class="line chunk-delete" data-line="305"><span class="line-num">306</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="306"><span class="line-num">307</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-delete" data-line="307"><span class="line-num">308</span><span class="line-content"># SECTION 9: Error Handling</span></div>
<div class="line chunk-delete" data-line="308"><span class="line-num">309</span><span class="line-content"># Some error classes will be DELETED</span></div>
<div class="line chunk-delete" data-line="309"><span class="line-num">310</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-delete" data-line="310"><span class="line-num">311</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="311"><span class="line-num">312</span><span class="line-content">class PaymentError(Exception):</span></div>
<div class="line chunk-delete" data-line="312"><span class="line-num">313</span><span class="line-content">    pass</span></div>
<div class="line chunk-delete" data-line="313"><span class="line-num">314</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="314"><span class="line-num">315</span><span class="line-content">class InventoryError(Exception):</span></div>
<div class="line chunk-delete" data-line="315"><span class="line-num">316</span><span class="line-content">    pass</span></div>
<div class="line chunk-delete" data-line="316"><span class="line-num">317</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="317"><span class="line-num">318</span><span class="line-content"># OLD error class - DELETED</span></div>
<div class="line chunk-delete" data-line="318"><span class="line-num">319</span><span class="line-content">class LegacyError(Exception):</span></div>
<div class="line chunk-delete" data-line="319"><span class="line-num">320</span><span class="line-content">    pass</span></div>
<div class="line chunk-delete" data-line="320"><span class="line-num">321</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="321"><span class="line-num">322</span><span class="line-content">def handle_error(error):</span></div>
<div class="line chunk-delete" data-line="322"><span class="line-num">323</span><span class="line-content">    # OLD error handling - will be REPLACED</span></div>
<div class="line chunk-delete" data-line="323"><span class="line-num">324</span><span class="line-content">    print(f&quot;Error occurred: {error}&quot;)</span></div>
<div class="line chunk-delete" data-line="324"><span class="line-num">325</span><span class="line-content">    return False</span></div>
<div class="line chunk-delete" data-line="325"><span class="line-num">326</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-delete" data-line="326"><span class="line-num">327</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-delete" data-line="327"><span class="line-num">328</span><span class="line-content"># SECTION 10: Main Application Logic</span></div>
<div class="line chunk-delete" data-line="328"><span class="line-num">329</span><span class="line-content"># Final section with various changes</span></div>
<div class="line chunk-delete" data-line="329"><span class="line-num">330</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-delete" data-line="330"><span class="line-num">331</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="331"><span class="line-num">332</span><span class="line-content">def main():</span></div>
<div class="line chunk-replace" data-line="332"><span class="line-num">333</span><span class="line-content">    print<span class="inline-diff">(</span>&quot;<span class="inline-diff">E-commerce System v1.0</span>&quot;<span class="inline-diff">)</span></span></div>
<div class="line chunk-replace" data-line="333"><span class="line-num">334</span><span class="line-content">    <span class="inline-diff"># OLD </span>in<span class="inline-diff">i</span>t<span class="inline-diff">ialization</span> <span class="inline-diff">code</span> <span class="inline-diff">- DELETED</span></span></div>
<div class="line chunk-replace" data-line="334"><span class="line-num">335</span><span class="line-content">    print(&quot;System <span class="inline-diff">ready</span>&quot;)</span></div>
<div class="line " data-line="335"><span class="line-num">336</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="336"><span class="line-num">337</span><span class="line-content">if __name__ == &quot;__main__&quot;:</span></div>
<div class="line " data-line="337"><span class="line-num">338</span><span class="line-content">    main()</span></div>
<div class="line " data-line="338"><span class="line-num">339</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="339"><span class="line-num">340</span><span class="line-content"># END OF FILE - Version <span class="inline-diff">1</span>.0</span></div>
<div class="line chunk-replace" data-line="340"><span class="line-num">341</span><span class="line-content"># Total lines: ~300</span></div>
        </div>

        <svg id="linkmap" class="link-map" style="display: none;"></svg>
        <canvas id="linkmap-canvas" class="link-map"></canvas>

        <div class="file-pane" id="right-pane">
<div class="line chunk-replace" data-line="0"><span class="line-num">1</span><span class="line-content"># E-commerce System - Version <span class="inline-diff">2</span>.0</span></div>
<div class="line chunk-replace" data-line="1"><span class="line-num">2</span><span class="line-content"># <span class="inline-diff">Enh</span>a<span class="inline-diff">n</span>c<span class="inline-diff">ed</span> implementation <span class="inline-diff">w</span>it<span class="inline-diff">h tax, discounts,</span> and <span class="inline-diff">bett</span>er <span class="inline-diff">val</span>i<span class="inline-diff">datio</span>n</span></div>
<div class="line chunk-replace" data-line="2"><span class="line-num">3</span><span class="line-content"># <span class="inline-diff">N</span>E<span class="inline-diff">W </span>L<span class="inline-diff">IN</span>E<span class="inline-diff"> INSER</span>TED<span class="inline-diff">:</span> <span class="inline-diff">Add</span>in<span class="inline-diff">g</span> <span class="inline-diff">mo</span>r<span class="inline-diff">e comprehen</span>si<span class="inline-diff">ve</span> <span class="inline-diff">error handling</span></span></div>
<div class="line chunk-replace" data-line="3"><span class="line-num">4</span><span class="line-content"># <span class="inline-diff">N</span>E<span class="inline-diff">W </span>L<span class="inline-diff">IN</span>E<span class="inline-diff"> INSER</span>TED<span class="inline-diff">: Improved type hints throughout</span></span></div>
<div class="line " data-line="4"><span class="line-num">5</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="5"><span class="line-num">6</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="6"><span class="line-num">7</span><span class="line-content">import logging</span></div>
<div class="line " data-line="7"><span class="line-num">8</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line chunk-insert" data-line="8"><span class="line-num">9</span><span class="line-content">from typing import List, Optional</span></div>
<div class="line " data-line="9"><span class="line-num">10</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="10"><span class="line-num">11</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="11"><span class="line-num">12</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="12"><span class="line-num">13</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="13"><span class="line-num">14</span><span class="line-content">    def __init__(self, id, name, price, category<span class="inline-diff">, description=&quot;&quot;</span>):</span></div>
<div class="line " data-line="14"><span class="line-num">15</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="15"><span class="line-num">16</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="16"><span class="line-num">17</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="17"><span class="line-num">18</span><span class="line-content">        self.category = category</span></div>
<div class="line chunk-insert" data-line="18"><span class="line-num">19</span><span class="line-content">        self.description = description</span></div>
<div class="line " data-line="19"><span class="line-num">20</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-replace" data-line="20"><span class="line-num">21</span><span class="line-content">        <span class="inline-diff">s</span>el<span class="inline-diff">f.sku</span> = <span class="inline-diff">f&quot;SKU</span>-<span class="inline-diff">{id}&quot;</span></span></div>
<div class="line " data-line="21"><span class="line-num">22</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="22"><span class="line-num">23</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line chunk-insert" data-line="23"><span class="line-num">24</span><span class="line-content">        if self.stock + quantity &lt; 0:</span></div>
<div class="line chunk-insert" data-line="24"><span class="line-num">25</span><span class="line-content">            raise ValueError(&quot;Insufficient stock&quot;)</span></div>
<div class="line " data-line="25"><span class="line-num">26</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="26"><span class="line-num">27</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="27"><span class="line-num">28</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="28"><span class="line-num">29</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="29"><span class="line-num">30</span><span class="line-content">        return f&quot;{self.name} <span class="inline-diff">({self.sku}) </span>- ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="30"><span class="line-num">31</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="31"><span class="line-num">32</span><span class="line-content">    def is_available(self):</span></div>
<div class="line chunk-replace" data-line="32"><span class="line-num">33</span><span class="line-content"> <span class="inline-diff">       </span>re<span class="inline-diff">turn self.stock &gt; 0</span></span></div>
<div class="line " data-line="33"><span class="line-num">34</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="34"><span class="line-num">35</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="35"><span class="line-num">36</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="36"><span class="line-num">37</span><span class="line-content">        if quantity &lt;= 0:</span></div>
<div class="line chunk-insert" data-line="37"><span class="line-num">38</span><span class="line-content">            raise ValueError(&quot;Quantity must be positive&quot;)</span></div>
<div class="line " data-line="38"><span class="line-num">39</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="39"><span class="line-num">40</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="40"><span class="line-num">41</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="41"><span class="line-num">42</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="42"><span class="line-num">43</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="43"><span class="line-num">44</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="44"><span class="line-num">45</span><span class="line-content"><span class="inline-diff">    </span>def u<span class="inline-diff">pd</span>ate_<span class="inline-diff">qu</span>a<span class="inline-diff">nt</span>it<span class="inline-diff">y(</span>s<span class="inline-diff">elf, new_quantity</span>):</span></div>
<div class="line chunk-replace" data-line="45"><span class="line-num">46</span><span class="line-content">     <span class="inline-diff">   if new_quantity &lt;</span>= 0<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="46"><span class="line-num">47</span><span class="line-content">    <span class="inline-diff">        raise ValueErr</span>or<span class="inline-diff">(&quot;Quant</span>it<span class="inline-diff">y</span> <span class="inline-diff">must</span> <span class="inline-diff">be pos</span>it<span class="inline-diff">iv</span>e<span class="inline-diff">&quot;)</span></span></div>
<div class="line chunk-replace" data-line="47"><span class="line-num">48</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.quant</span>it<span class="inline-diff">y = n</span>e<span class="inline-diff">w</span>_<span class="inline-diff">q</span>ua<span class="inline-diff">ntity</span></span></div>
<div class="line chunk-replace" data-line="48"><span class="line-num">49</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="49"><span class="line-num">50</span><span class="line-content">def calculate_total(items, tax_rate=Decimal(&#x27;0.0&#x27;)):</span></div>
<div class="line chunk-replace" data-line="50"><span class="line-num">51</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Calculat</span>e<span class="inline-diff"> total</span> pr<span class="inline-diff">i</span>ce<span class="inline-diff"> inclu</span>d<span class="inline-diff">ing tax&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="51"><span class="line-num">52</span><span class="line-content">    s<span class="inline-diff">ubtotal</span> = <span class="inline-diff">D</span>e<span class="inline-diff">c</span>im<span class="inline-diff">al</span>(<span class="inline-diff">&#x27;0&#x27;</span>)</span></div>
<div class="line " data-line="52"><span class="line-num">53</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="53"><span class="line-num">54</span><span class="line-content">        <span class="inline-diff">sub</span>total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="54"><span class="line-num">55</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="55"><span class="line-num">56</span><span class="line-content">    tax = subtotal * tax_rate</span></div>
<div class="line chunk-replace" data-line="56"><span class="line-num">57</span><span class="line-content"> <span class="inline-diff">   </span>re<span class="inline-diff">tu</span>r<span class="inline-diff">n subt</span>o<span class="inline-diff">tal + tax</span></span></div>
<div class="line " data-line="57"><span class="line-num">58</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="58"><span class="line-num">59</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="59"><span class="line-num">60</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="60"><span class="line-num">61</span><span class="line-content">    total = calculate_total(items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="61"><span class="line-num">62</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="62"><span class="line-num">63</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="63"><span class="line-num">64</span><span class="line-content">        <span class="inline-diff">total = apply_</span>discount<span class="inline-diff">(</span>total<span class="inline-diff">,</span> Decimal(&#x27;0.1&#x27;)<span class="inline-diff">)</span></span></div>
<div class="line chunk-replace" data-line="64"><span class="line-num">65</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="65"><span class="line-num">66</span><span class="line-content">    # Apply coupon if available</span></div>
<div class="line chunk-replace" data-line="66"><span class="line-num">67</span><span class="line-content">    <span class="inline-diff">if</span> o<span class="inline-diff">rder.coupon_code:</span></span></div>
<div class="line chunk-replace" data-line="67"><span class="line-num">68</span><span class="line-content">        total = apply_coupon(total, order.coupon_code)</span></div>
<div class="line chunk-replace" data-line="68"><span class="line-num">69</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="69"><span class="line-num">70</span><span class="line-content">    <span class="inline-diff"># Log the or</span>de<span class="inline-diff">r</span></span></div>
<div class="line chunk-replace" data-line="70"><span class="line-num">71</span><span class="line-content">    l<span class="inline-diff">ogger</span>.i<span class="inline-diff">nfo(f&quot;Ord</span>e<span class="inline-diff">r</span> <span class="inline-diff">processed:</span> <span class="inline-diff">${total:.2f}&quot;)</span></span></div>
<div class="line " data-line="71"><span class="line-num">72</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="72"><span class="line-num">73</span><span class="line-content">    return total</span></div>
<div class="line " data-line="73"><span class="line-num">74</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="74"><span class="line-num">75</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="75"><span class="line-num">76</span><span class="line-content">    def __init__(self<span class="inline-diff">, customer=None</span>):</span></div>
<div class="line chunk-replace" data-line="76"><span class="line-num">77</span><span class="line-content">        self.items<span class="inline-diff">: List[CartItem]</span> = []</span></div>
<div class="line chunk-replace" data-line="77"><span class="line-num">78</span><span class="line-content">        self.c<span class="inline-diff">us</span>t<span class="inline-diff">om</span>e<span class="inline-diff">r</span> = <span class="inline-diff">cus</span>t<span class="inline-diff">o</span>me<span class="inline-diff">r</span></span></div>
<div class="line " data-line="78"><span class="line-num">79</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-replace" data-line="79"><span class="line-num">80</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.update</span>d_at = <span class="inline-diff">s</span>e<span class="inline-diff">lf.created_at</span></span></div>
<div class="line " data-line="80"><span class="line-num">81</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="81"><span class="line-num">82</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="82"><span class="line-num">83</span><span class="line-content">        if not product.is_available():</span></div>
<div class="line chunk-insert" data-line="83"><span class="line-num">84</span><span class="line-content">            raise ValueError(&quot;Product not available&quot;)</span></div>
<div class="line chunk-insert" data-line="84"><span class="line-num">85</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="85"><span class="line-num">86</span><span class="line-content">        # Check if product already in cart</span></div>
<div class="line chunk-insert" data-line="86"><span class="line-num">87</span><span class="line-content">        for item in self.items:</span></div>
<div class="line chunk-insert" data-line="87"><span class="line-num">88</span><span class="line-content">            if item.product.id == product.id:</span></div>
<div class="line chunk-insert" data-line="88"><span class="line-num">89</span><span class="line-content">                item.update_quantity(item.quantity + quantity)</span></div>
<div class="line chunk-insert" data-line="89"><span class="line-num">90</span><span class="line-content">                self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="90"><span class="line-num">91</span><span class="line-content">                return</span></div>
<div class="line chunk-insert" data-line="91"><span class="line-num">92</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="92"><span class="line-num">93</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="93"><span class="line-num">94</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line chunk-insert" data-line="94"><span class="line-num">95</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="95"><span class="line-num">96</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="96"><span class="line-num">97</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="97"><span class="line-num">98</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line chunk-insert" data-line="98"><span class="line-num">99</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="99"><span class="line-num">100</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="100"><span class="line-num">101</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="101"><span class="line-num">102</span><span class="line-content">        return calculate_total(self.items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="102"><span class="line-num">103</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="103"><span class="line-num">104</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="104"><span class="line-num">105</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-insert" data-line="105"><span class="line-num">106</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="106"><span class="line-num">107</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="107"><span class="line-num">108</span><span class="line-content">    def get_item_count(self):</span></div>
<div class="line chunk-insert" data-line="108"><span class="line-num">109</span><span class="line-content">        return sum(item.quantity for item in self.items)</span></div>
<div class="line " data-line="109"><span class="line-num">110</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="110"><span class="line-num">111</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="111"><span class="line-num">112</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="112"><span class="line-num">113</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="113"><span class="line-num">114</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="114"><span class="line-num">115</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="115"><span class="line-num">116</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line chunk-insert" data-line="116"><span class="line-num">117</span><span class="line-content">        self.coupon_code = None</span></div>
<div class="line chunk-insert" data-line="117"><span class="line-num">118</span><span class="line-content">        self.tracking_number = None</span></div>
<div class="line " data-line="118"><span class="line-num">119</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="119"><span class="line-num">120</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="120"><span class="line-num">121</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="121"><span class="line-num">122</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="122"><span class="line-num">123</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="123"><span class="line-num">124</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="124"><span class="line-num">125</span><span class="line-content">        self.t<span class="inline-diff">racking_nu</span>m<span class="inline-diff">b</span>er<span class="inline-diff"> = self._generate_tracking_number(</span>)</span></div>
<div class="line chunk-replace" data-line="125"><span class="line-num">126</span><span class="line-content">        logger.info(f&quot;Order confirmed for {self.customer.name}&quot;)</span></div>
<div class="line chunk-replace" data-line="126"><span class="line-num">127</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="127"><span class="line-num">128</span><span class="line-content">    def _<span class="inline-diff">generate</span>_<span class="inline-diff">track</span>in<span class="inline-diff">g</span>_<span class="inline-diff">number</span>(self):</span></div>
<div class="line chunk-replace" data-line="128"><span class="line-num">129</span><span class="line-content">        <span class="inline-diff">return f&quot;TRK{</span>self.<span class="inline-diff">order_d</span>a<span class="inline-diff">te.ti</span>me<span class="inline-diff">st</span>am<span class="inline-diff">p()}&quot;</span></span></div>
<div class="line chunk-replace" data-line="129"><span class="line-num">130</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="130"><span class="line-num">131</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">cancel(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="131"><span class="line-num">132</span><span class="line-content">        if self.status == &quot;shipped&quot;:</span></div>
<div class="line chunk-replace" data-line="132"><span class="line-num">133</span><span class="line-content">     <span class="inline-diff">       r</span>a<span class="inline-diff">ise ValueError(&quot;Cannot can</span>ce<span class="inline-diff">l shipped </span>order<span class="inline-diff">&quot;</span>)</span></div>
<div class="line chunk-replace" data-line="133"><span class="line-num">134</span><span class="line-content">        self<span class="inline-diff">.status = &quot;cancelled&quot;</span></span></div>
<div class="line " data-line="134"><span class="line-num">135</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="135"><span class="line-num">136</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="136"><span class="line-num">137</span><span class="line-content">    def __init__(self, name, email<span class="inline-diff">, phone=&quot;&quot;</span>):</span></div>
<div class="line " data-line="137"><span class="line-num">138</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="138"><span class="line-num">139</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="139"><span class="line-num">140</span><span class="line-content">        self.<span class="inline-diff">ph</span>o<span class="inline-diff">n</span>e = <span class="inline-diff">phone</span></span></div>
<div class="line chunk-replace" data-line="140"><span class="line-num">141</span><span class="line-content">        self.orders: List[Order] = []</span></div>
<div class="line chunk-replace" data-line="141"><span class="line-num">142</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.loy</span>a<span class="inline-diff">l</span>t<span class="inline-diff">y_points = 0</span></span></div>
<div class="line " data-line="142"><span class="line-num">143</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="143"><span class="line-num">144</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line chunk-insert" data-line="144"><span class="line-num">145</span><span class="line-content">        if not self.email:</span></div>
<div class="line chunk-insert" data-line="145"><span class="line-num">146</span><span class="line-content">            raise ValueError(&quot;Customer email required&quot;)</span></div>
<div class="line " data-line="146"><span class="line-num">147</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="147"><span class="line-num">148</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="148"><span class="line-num">149</span><span class="line-content">        return order</span></div>
<div class="line " data-line="149"><span class="line-num">150</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="150"><span class="line-num">151</span><span class="line-content">    def add_loyalty_points(self, points):</span></div>
<div class="line chunk-insert" data-line="151"><span class="line-num">152</span><span class="line-content">        self.loyalty_points += points</span></div>
<div class="line chunk-insert" data-line="152"><span class="line-num">153</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="153"><span class="line-num">154</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="154"><span class="line-num">155</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="155"><span class="line-num">156</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="156"><span class="line-num">157</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="157"><span class="line-num">158</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="158"><span class="line-num">159</span><span class="line-content">    i<span class="inline-diff">f </span>n<span class="inline-diff">ot</span> email<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="159"><span class="line-num">160</span><span class="line-content">        return False</span></div>
<div class="line chunk-replace" data-line="160"><span class="line-num">161</span><span class="line-content"> <span class="inline-diff">   return &quot;@&quot; in email and &quot;.&quot; in email and len(email) &gt; 5</span></span></div>
<div class="line chunk-replace" data-line="161"><span class="line-num">162</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="162"><span class="line-num">163</span><span class="line-content"># <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="163"><span class="line-num">164</span><span class="line-content"># <span class="inline-diff">SECTION 2: Enhanced Helper Functions</span></span></div>
<div class="line chunk-replace" data-line="164"><span class="line-num">165</span><span class="line-content"># NEW: Improved implementations with better error handling</span></div>
<div class="line chunk-replace" data-line="165"><span class="line-num">166</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="166"><span class="line-num">167</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="167"><span class="line-num">168</span><span class="line-content"><span class="inline-diff">d</span>e<span class="inline-diff">f calcul</span>ate<span class="inline-diff">_shipping(weight,</span> <span class="inline-diff">distance,</span> <span class="inline-diff">express=False):</span></span></div>
<div class="line chunk-replace" data-line="168"><span class="line-num">169</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Enh</span>a<span class="inline-diff">nc</span>e<span class="inline-diff">d shipping calcul</span>ati<span class="inline-diff">on</span> <span class="inline-diff">with</span> <span class="inline-diff">express option&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="169"><span class="line-num">170</span><span class="line-content">    base_rate = Decimal(&#x27;5.00&#x27;)</span></div>
<div class="line chunk-replace" data-line="170"><span class="line-num">171</span><span class="line-content">  <span class="inline-diff">  weigh</span>t_rate<span class="inline-diff"> </span>=<span class="inline-diff"> Decimal(&#x27;</span>0.7<span class="inline-diff">5&#x27;</span>)<span class="inline-diff">  # Increased from 0.5</span></span></div>
<div class="line chunk-replace" data-line="171"><span class="line-num">172</span><span class="line-content">    <span class="inline-diff">d</span>i<span class="inline-diff">s</span>ta<span class="inline-diff">n</span>c<span class="inline-diff">e_r</span>ate <span class="inline-diff">= </span>D<span class="inline-diff">ecimal(&#x27;0.1&#x27;)</span></span></div>
<div class="line chunk-replace" data-line="172"><span class="line-num">173</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="173"><span class="line-num">174</span><span class="line-content">    total = base_rate + (Decimal(str(weight)) * weight_rate) + (Decimal(str(distance)) * distance_rate)</span></div>
<div class="line chunk-replace" data-line="174"><span class="line-num">175</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="175"><span class="line-num">176</span><span class="line-content"><span class="inline-diff">    i</span>f e<span class="inline-diff">xpre</span>s<span class="inline-diff">s</span>:</span></div>
<div class="line chunk-replace" data-line="176"><span class="line-num">177</span><span class="line-content">       <span class="inline-diff"> total *= Decimal(&#x27;1.</span>5<span class="inline-diff">&#x27;)</span></span></div>
<div class="line chunk-replace" data-line="177"><span class="line-num">178</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="178"><span class="line-num">179</span><span class="line-content">    return t<span class="inline-diff">otal</span></span></div>
<div class="line chunk-replace" data-line="179"><span class="line-num">180</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="180"><span class="line-num">181</span><span class="line-content"><span class="inline-diff">d</span>e<span class="inline-diff">f apply_tax(amou</span>nt<span class="inline-diff">, tax_</span>r<span class="inline-diff">at</span>e<span class="inline-diff">=Decimal(&#x27;0.08&#x27;), </span>r<span class="inline-diff">egion=&quot;US&quot;)</span>:</span></div>
<div class="line chunk-replace" data-line="181"><span class="line-num">182</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">T</span>a<span class="inline-diff">x</span> <span class="inline-diff">c</span>al<span class="inline-diff">culat</span>i<span class="inline-diff">o</span>n wi<span class="inline-diff">th regiona</span>l <span class="inline-diff">support&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="182"><span class="line-num">183</span><span class="line-content">    <span class="inline-diff">r</span>e<span class="inline-diff">g</span>i<span class="inline-diff">o</span>n<span class="inline-diff">a</span>l<span class="inline-diff">_rates = {</span></span></div>
<div class="line chunk-replace" data-line="183"><span class="line-num">184</span><span class="line-content">        &quot;<span class="inline-diff">US</span>&quot;<span class="inline-diff">: Decimal(&#x27;0.08&#x27;),</span></span></div>
<div class="line chunk-replace" data-line="184"><span class="line-num">185</span><span class="line-content">        &quot;<span class="inline-diff">CA</span>&quot;<span class="inline-diff">: Decimal(&#x27;0.13&#x27;),</span></span></div>
<div class="line chunk-replace" data-line="185"><span class="line-num">186</span><span class="line-content">        <span class="inline-diff">&quot;UK&quot;:</span> D<span class="inline-diff">ecimal(&#x27;0.20&#x27;),</span></span></div>
<div class="line chunk-replace" data-line="186"><span class="line-num">187</span><span class="line-content">    }</span></div>
<div class="line chunk-replace" data-line="187"><span class="line-num">188</span><span class="line-content">    r<span class="inline-diff">ate = regi</span>o<span class="inline-diff">nal_rat</span>es<span class="inline-diff">.g</span>et(<span class="inline-diff">r</span>e<span class="inline-diff">gion</span>, ta<span class="inline-diff">x</span>_r<span class="inline-diff">ate</span>)</span></div>
<div class="line chunk-replace" data-line="188"><span class="line-num">189</span><span class="line-content">    <span class="inline-diff">r</span>et<span class="inline-diff">ur</span>n <span class="inline-diff">amount</span> <span class="inline-diff">*</span> <span class="inline-diff">(</span>D<span class="inline-diff">ecimal(&#x27;1&#x27;) + rate)</span></span></div>
<div class="line chunk-replace" data-line="189"><span class="line-num">190</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="190"><span class="line-num">191</span><span class="line-content">def apply_discount(total, discount_rate):</span></div>
<div class="line chunk-replace" data-line="191"><span class="line-num">192</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Apply disco</span>un<span class="inline-diff">t</span> t<span class="inline-diff">o tot</span>a<span class="inline-diff">l with v</span>a<span class="inline-diff">lida</span>tion<span class="inline-diff">&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="192"><span class="line-num">193</span><span class="line-content">    <span class="inline-diff">i</span>f<span class="inline-diff"> disco</span>un<span class="inline-diff">t_rate</span> <span class="inline-diff">&lt;</span> <span class="inline-diff">0</span> <span class="inline-diff">or discount_rate &gt; 1:</span></span></div>
<div class="line chunk-replace" data-line="193"><span class="line-num">194</span><span class="line-content">        r<span class="inline-diff">ais</span>e <span class="inline-diff">Val</span>ue<span class="inline-diff">Error(&quot;Discount rate must be between 0 and 1&quot;)</span></span></div>
<div class="line chunk-replace" data-line="194"><span class="line-num">195</span><span class="line-content">    return total * (Decimal(&#x27;1&#x27;) - discount_rate)</span></div>
<div class="line chunk-replace" data-line="195"><span class="line-num">196</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="196"><span class="line-num">197</span><span class="line-content"><span class="inline-diff">d</span>e<span class="inline-diff">f apply_coupo</span>n<span class="inline-diff">(</span>tot<span class="inline-diff">al, coupon_code):</span></span></div>
<div class="line chunk-replace" data-line="197"><span class="line-num">198</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;</span>NE<span class="inline-diff">W:</span> <span class="inline-diff">Enh</span>an<span class="inline-diff">ce</span>d <span class="inline-diff">coupon system with multiple codes&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="198"><span class="line-num">199</span><span class="line-content"><span class="inline-diff">    coupons</span> =<span class="inline-diff"> {</span></span></div>
<div class="line chunk-replace" data-line="199"><span class="line-num">200</span><span class="line-content">        &quot;SAVE10&quot;: Decimal(&#x27;0.1&#x27;),</span></div>
<div class="line chunk-replace" data-line="200"><span class="line-num">201</span><span class="line-content"> <span class="inline-diff">       &quot;SAVE20&quot;</span>:<span class="inline-diff"> Decimal(&#x27;0.2&#x27;),</span></span></div>
<div class="line chunk-replace" data-line="201"><span class="line-num">202</span><span class="line-content">     <span class="inline-diff">   &quot;WELCOME&quot;</span>:<span class="inline-diff"> Decimal(&#x27;0.15&#x27;),</span></span></div>
<div class="line chunk-replace" data-line="202"><span class="line-num">203</span><span class="line-content">    }</span></div>
<div class="line chunk-replace" data-line="203"><span class="line-num">204</span><span class="line-content">    i<span class="inline-diff">f</span> <span class="inline-diff">coup</span>on<span class="inline-diff">_cod</span>e <span class="inline-diff">in</span> <span class="inline-diff">coupons:</span></span></div>
<div class="line chunk-replace" data-line="204"><span class="line-num">205</span><span class="line-content">        return total * (Decimal(&#x27;1&#x27;) - coupons[coupon_code])</span></div>
<div class="line chunk-replace" data-line="205"><span class="line-num">206</span><span class="line-content">    retu<span class="inline-diff">r</span>n<span class="inline-diff"> </span>t<span class="inline-diff">o</span>t<span class="inline-diff">al</span></span></div>
<div class="line " data-line="206"><span class="line-num">207</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="207"><span class="line-num">208</span><span class="line-content">class PaymentProcessor:</span></div>
<div class="line chunk-replace" data-line="208"><span class="line-num">209</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Modern</span> payment <span class="inline-diff">proc</span>es<span class="inline-diff">sing</span> wi<span class="inline-diff">th</span> <span class="inline-diff">multipl</span>e <span class="inline-diff">providers&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="209"><span class="line-num">210</span><span class="line-content">    def __init__(self<span class="inline-diff">, provider=&quot;stripe&quot;</span>):</span></div>
<div class="line chunk-replace" data-line="210"><span class="line-num">211</span><span class="line-content">        self.p<span class="inline-diff">rov</span>i<span class="inline-diff">d</span>e<span class="inline-diff">r</span> = p<span class="inline-diff">rov</span>i<span class="inline-diff">d</span>e<span class="inline-diff">r</span></span></div>
<div class="line chunk-replace" data-line="211"><span class="line-num">212</span><span class="line-content">        self.api<span class="inline-diff">_k</span>e<span class="inline-diff">y = s</span>e<span class="inline-diff">lf</span>.<span class="inline-diff">_get_api_key(pr</span>o<span class="inline-diff">vider)</span></span></div>
<div class="line chunk-replace" data-line="212"><span class="line-num">213</span><span class="line-content">        <span class="inline-diff">s</span>el<span class="inline-diff">f.en</span>d<span class="inline-diff">point</span> = <span class="inline-diff">s</span>e<span class="inline-diff">lf._get_endpoint(provider)</span></span></div>
<div class="line chunk-replace" data-line="213"><span class="line-num">214</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="214"><span class="line-num">215</span><span class="line-content">    def _<span class="inline-diff">g</span>et<span class="inline-diff">_api_key</span>(self, <span class="inline-diff">p</span>r<span class="inline-diff">ovi</span>der):</span></div>
<div class="line chunk-replace" data-line="215"><span class="line-num">216</span><span class="line-content">        <span class="inline-diff">k</span>e<span class="inline-diff">ys</span> <span class="inline-diff">=</span> <span class="inline-diff">{</span></span></div>
<div class="line chunk-replace" data-line="216"><span class="line-num">217</span><span class="line-content">         <span class="inline-diff">   </span>&quot;st<span class="inline-diff">ripe</span>&quot;: &quot;s<span class="inline-diff">k_liv</span>e<span class="inline-diff">_new_</span>stri<span class="inline-diff">pe</span>_<span class="inline-diff">key</span>&quot;<span class="inline-diff">,</span></span></div>
<div class="line chunk-replace" data-line="217"><span class="line-num">218</span><span class="line-content">            &quot;paypal&quot;: &quot;paypal_api_key&quot;,</span></div>
<div class="line chunk-replace" data-line="218"><span class="line-num">219</span><span class="line-content">      <span class="inline-diff">  }</span></span></div>
<div class="line chunk-replace" data-line="219"><span class="line-num">220</span><span class="line-content">        re<span class="inline-diff">t</span>u<span class="inline-diff">r</span>n <span class="inline-diff">keys.</span>g<span class="inline-diff">et(prov</span>i<span class="inline-diff">der,</span> <span class="inline-diff">&quot;default_key&quot;)</span></span></div>
<div class="line chunk-replace" data-line="220"><span class="line-num">221</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="221"><span class="line-num">222</span><span class="line-content">    def _get_endpoint(self, provider):</span></div>
<div class="line chunk-replace" data-line="222"><span class="line-num">223</span><span class="line-content"><span class="inline-diff">        endpoints</span> =<span class="inline-diff"> {</span></span></div>
<div class="line chunk-replace" data-line="223"><span class="line-num">224</span><span class="line-content">  <span class="inline-diff">          &quot;stripe&quot;</span>: <span class="inline-diff">&quot;h</span>tt<span class="inline-diff">ps://api.stripe.com/v1&quot;,</span></span></div>
<div class="line chunk-replace" data-line="224"><span class="line-num">225</span><span class="line-content">      <span class="inline-diff">      &quot;paypal&quot;: &quot;https://api.paypal.com/v2&quot;,</span></span></div>
<div class="line chunk-replace" data-line="225"><span class="line-num">226</span><span class="line-content"> <span class="inline-diff">       }</span></span></div>
<div class="line chunk-replace" data-line="226"><span class="line-num">227</span><span class="line-content">        return endpoints.get(provider, &quot;https://payment-api.example.com&quot;)</span></div>
<div class="line chunk-replace" data-line="227"><span class="line-num">228</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="228"><span class="line-num">229</span><span class="line-content">    def <span class="inline-diff">process</span>_<span class="inline-diff">payme</span>nt(self<span class="inline-diff">, amount, payment_method</span>):</span></div>
<div class="line chunk-replace" data-line="229"><span class="line-num">230</span><span class="line-content">        <span class="inline-diff">&quot;&quot;&quot;NEW: Enhanc</span>e<span class="inline-diff">d payment processing w</span>it<span class="inline-diff">h</span> <span class="inline-diff">validation&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="230"><span class="line-num">231</span><span class="line-content">        i<span class="inline-diff">f</span> <span class="inline-diff">amount &lt;</span>= <span class="inline-diff">0:</span></span></div>
<div class="line chunk-replace" data-line="231"><span class="line-num">232</span><span class="line-content">            raise ValueError(&quot;Payment amount must be positive&quot;)</span></div>
<div class="line chunk-replace" data-line="232"><span class="line-num">233</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="233"><span class="line-num">234</span><span class="line-content">        r<span class="inline-diff">e</span>t<span class="inline-diff">ur</span>n <span class="inline-diff">{</span></span></div>
<div class="line chunk-replace" data-line="234"><span class="line-num">235</span><span class="line-content">            <span class="inline-diff">&quot;</span>st<span class="inline-diff">atu</span>s<span class="inline-diff">&quot;: &quot;s</span>uc<span class="inline-diff">cess&quot;,</span></span></div>
<div class="line chunk-replace" data-line="235"><span class="line-num">236</span><span class="line-content">        <span class="inline-diff">    &quot;tran</span>s<span class="inline-diff">action_id&quot;</span>:<span class="inline-diff"> f&quot;TXN-{datetime.datetime.now().timestamp()}&quot;,</span></span></div>
<div class="line chunk-replace" data-line="236"><span class="line-num">237</span><span class="line-content">            <span class="inline-diff">&quot;</span>a<span class="inline-diff">mou</span>nt<span class="inline-diff">&quot;: s</span>t<span class="inline-diff">r(amount),</span></span></div>
<div class="line chunk-replace" data-line="237"><span class="line-num">238</span><span class="line-content">            &quot;provider&quot;: self.provider</span></div>
<div class="line chunk-replace" data-line="238"><span class="line-num">239</span><span class="line-content">       <span class="inline-diff"> }</span></span></div>
<div class="line chunk-replace" data-line="239"><span class="line-num">240</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="240"><span class="line-num">241</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">refund(</span>self<span class="inline-diff">, </span>tr<span class="inline-diff">ansa</span>ct<span class="inline-diff">ion</span>_id<span class="inline-diff">,</span> a<span class="inline-diff">mou</span>nt<span class="inline-diff">=None):</span></span></div>
<div class="line chunk-replace" data-line="241"><span class="line-num">242</span><span class="line-content">        <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">I</span>mpro<span class="inline-diff">ve</span>d <span class="inline-diff">refund</span> <span class="inline-diff">with partial refund support&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="242"><span class="line-num">243</span><span class="line-content">        i<span class="inline-diff">f n</span>o<span class="inline-diff">t transa</span>ct<span class="inline-diff">ion</span>_id<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="243"><span class="line-num">244</span><span class="line-content">            raise ValueError(&quot;Transaction ID required&quot;)</span></div>
<div class="line chunk-replace" data-line="244"><span class="line-num">245</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="245"><span class="line-num">246</span><span class="line-content">        return <span class="inline-diff">{</span></span></div>
<div class="line chunk-replace" data-line="246"><span class="line-num">247</span><span class="line-content">            &quot;status&quot;: &quot;refunded&quot;,</span></div>
<div class="line chunk-replace" data-line="247"><span class="line-num">248</span><span class="line-content">          <span class="inline-diff">  &quot;transaction_id&quot;: transaction_id,</span></span></div>
<div class="line chunk-replace" data-line="248"><span class="line-num">249</span><span class="line-content">     <span class="inline-diff">       &quot;</span>a<span class="inline-diff">mount&quot;: </span>str(<span class="inline-diff">amount) if amount </span>el<span class="inline-diff">se &quot;</span>f<span class="inline-diff">ull&quot;</span></span></div>
<div class="line chunk-replace" data-line="249"><span class="line-num">250</span><span class="line-content">        <span class="inline-diff">}</span></span></div>
<div class="line chunk-replace" data-line="250"><span class="line-num">251</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="251"><span class="line-num">252</span><span class="line-content">    def validate_payment_method(self, payment_method):</span></div>
<div class="line chunk-replace" data-line="252"><span class="line-num">253</span><span class="line-content"> <span class="inline-diff">       &quot;&quot;&quot;NEW: Validate payment method before processing&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="253"><span class="line-num">254</span><span class="line-content">      <span class="inline-diff">  r</span>e<span class="inline-diff">quired_fields = [&quot;type&quot;, &quot;nu</span>m<span class="inline-diff">ber&quot;]</span></span></div>
<div class="line chunk-replace" data-line="254"><span class="line-num">255</span><span class="line-content">    <span class="inline-diff">    </span>re<span class="inline-diff">turn all(field in payment_method for field in required_fields)</span></span></div>
<div class="line chunk-replace" data-line="255"><span class="line-num">256</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="256"><span class="line-num">257</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-replace" data-line="257"><span class="line-num">258</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">SECTION 3: Enhan</span>c<span class="inline-diff">ed Inve</span>nto<span class="inline-diff">ry Manag</span>e<span class="inline-diff">ment</span></span></div>
<div class="line chunk-replace" data-line="258"><span class="line-num">259</span><span class="line-content"># <span class="inline-diff">NEW:</span> <span class="inline-diff">A</span>d<span class="inline-diff">va</span>n<span class="inline-diff">ced</span> <span class="inline-diff">feature</span>s<span class="inline-diff"> with bet</span>te<span class="inline-diff">r</span> <span class="inline-diff">tracking</span></span></div>
<div class="line " data-line="259"><span class="line-num">260</span><span class="line-content"># ============================================</span></div>
<div class="line " data-line="260"><span class="line-num">261</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="261"><span class="line-num">262</span><span class="line-content">class Inventory:</span></div>
<div class="line chunk-replace" data-line="262"><span class="line-num">263</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Enhanced </span>in<span class="inline-diff">ventory w</span>it<span class="inline-diff">h </span>l<span class="inline-diff">ow stock alerts&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="263"><span class="line-num">264</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">__init__(</span>self<span class="inline-diff">,</span> <span class="inline-diff">warehouse_id</span>=<span class="inline-diff">None):</span></span></div>
<div class="line " data-line="264"><span class="line-num">265</span><span class="line-content">        self.items = {}</span></div>
<div class="line chunk-replace" data-line="265"><span class="line-num">266</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.w</span>a<span class="inline-diff">rehouse</span>_id = <span class="inline-diff">war</span>e<span class="inline-diff">house_id</span> <span class="inline-diff">or</span> <span class="inline-diff">&quot;</span>DE<span class="inline-diff">FAU</span>LT<span class="inline-diff">&quot;</span></span></div>
<div class="line chunk-replace" data-line="266"><span class="line-num">267</span><span class="line-content">        self.low_stock_threshold = 10</span></div>
<div class="line " data-line="267"><span class="line-num">268</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="268"><span class="line-num">269</span><span class="line-content">    def add_product(self, product_id, quantity):</span></div>
<div class="line chunk-insert" data-line="269"><span class="line-num">270</span><span class="line-content">        if quantity &lt;= 0:</span></div>
<div class="line chunk-insert" data-line="270"><span class="line-num">271</span><span class="line-content">            raise ValueError(&quot;Quantity must be positive&quot;)</span></div>
<div class="line chunk-insert" data-line="271"><span class="line-num">272</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="272"><span class="line-num">273</span><span class="line-content">        if product_id in self.items:</span></div>
<div class="line " data-line="273"><span class="line-num">274</span><span class="line-content">            self.items[product_id] += quantity</span></div>
<div class="line " data-line="274"><span class="line-num">275</span><span class="line-content">        else:</span></div>
<div class="line " data-line="275"><span class="line-num">276</span><span class="line-content">            self.items[product_id] = quantity</span></div>
<div class="line " data-line="276"><span class="line-num">277</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="277"><span class="line-num">278</span><span class="line-content">        logger.info(f&quot;Added {quantity} units of {product_id}&quot;)</span></div>
<div class="line chunk-insert" data-line="278"><span class="line-num">279</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="279"><span class="line-num">280</span><span class="line-content">    def remove_product(self, product_id, quantity):</span></div>
<div class="line chunk-replace" data-line="280"><span class="line-num">281</span><span class="line-content">        if product_id <span class="inline-diff">not </span>in self.items:</span></div>
<div class="line chunk-replace" data-line="281"><span class="line-num">282</span><span class="line-content">            <span class="inline-diff">rai</span>se<span class="inline-diff"> Inv</span>e<span class="inline-diff">ntoryError(f&quot;Product {</span>product_id<span class="inline-diff">}</span> n<span class="inline-diff">o</span>t<span class="inline-diff"> found&quot;)</span></span></div>
<div class="line chunk-replace" data-line="282"><span class="line-num">283</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="283"><span class="line-num">284</span><span class="line-content">        <span class="inline-diff">if</span> self.items[product_id]<span class="inline-diff"> &lt; quantity:</span></span></div>
<div class="line chunk-replace" data-line="284"><span class="line-num">285</span><span class="line-content">            raise InventoryError(&quot;Insufficient inventory&quot;)</span></div>
<div class="line chunk-replace" data-line="285"><span class="line-num">286</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="286"><span class="line-num">287</span><span class="line-content">        self.items<span class="inline-diff">[</span>product_id<span class="inline-diff">]</span> <span class="inline-diff">-= quantity</span></span></div>
<div class="line chunk-replace" data-line="287"><span class="line-num">288</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="288"><span class="line-num">289</span><span class="line-content">      <span class="inline-diff">  if s</span>e<span class="inline-diff">lf.i</span>t<span class="inline-diff">ems[pr</span>od<span class="inline-diff">uct_</span>i<span class="inline-diff">d]</span> <span class="inline-diff">&lt;=</span> <span class="inline-diff">0:</span></span></div>
<div class="line chunk-replace" data-line="289"><span class="line-num">290</span><span class="line-content"><span class="inline-diff">        </span>    del<span class="inline-diff"> </span>self<span class="inline-diff">.items[product_id]</span></span></div>
<div class="line chunk-replace" data-line="290"><span class="line-num">291</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="291"><span class="line-num">292</span><span class="line-content">        <span class="inline-diff">logge</span>r<span class="inline-diff">.</span>in<span class="inline-diff">fo</span>(f&quot;<span class="inline-diff">Rem</span>o<span class="inline-diff">ve</span>d {q<span class="inline-diff">uanti</span>ty} units<span class="inline-diff"> of {product_id}</span>&quot;)</span></div>
<div class="line chunk-replace" data-line="292"><span class="line-num">293</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="293"><span class="line-num">294</span><span class="line-content"> <span class="inline-diff">   def check_availability(self, product_id, quantity</span>=<span class="inline-diff">1):</span></span></div>
<div class="line chunk-replace" data-line="294"><span class="line-num">295</span><span class="line-content">  <span class="inline-diff">      &quot;&quot;&quot;NEW</span>: <span class="inline-diff">Che</span>c<span class="inline-diff">k</span> <span class="inline-diff">if specific qu</span>antit<span class="inline-diff">y is availabl</span>e<span class="inline-diff">&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="295"><span class="line-num">296</span><span class="line-content">    <span class="inline-diff">    cur</span>re<span class="inline-diff">nt = self.items.get(product_id, 0)</span></span></div>
<div class="line chunk-replace" data-line="296"><span class="line-num">297</span><span class="line-content"> <span class="inline-diff">       return current &gt;</span>=<span class="inline-diff"> quantity</span></span></div>
<div class="line chunk-replace" data-line="297"><span class="line-num">298</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="298"><span class="line-num">299</span><span class="line-content"> <span class="inline-diff">   </span>de<span class="inline-diff">f get_low_stock_items(self)</span>:</span></div>
<div class="line chunk-replace" data-line="299"><span class="line-num">300</span><span class="line-content">      <span class="inline-diff">  &quot;&quot;&quot;NEW: Ge</span>t <span class="inline-diff">i</span>tem<span class="inline-diff">s</span> <span class="inline-diff">below</span> <span class="inline-diff">threshold&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="300"><span class="line-num">301</span><span class="line-content">       <span class="inline-diff"> re</span>t<span class="inline-diff">urn {</span></span></div>
<div class="line chunk-replace" data-line="301"><span class="line-num">302</span><span class="line-content">        <span class="inline-diff">    pid: qty for pid, qty in </span>self.<span class="inline-diff">it</span>e<span class="inline-diff">ms.it</span>e<span class="inline-diff">ms()</span></span></div>
<div class="line chunk-replace" data-line="302"><span class="line-num">303</span><span class="line-content">        <span class="inline-diff">    if qty &lt;= </span>self.<span class="inline-diff">l</span>o<span class="inline-diff">w_s</span>to<span class="inline-diff">ck_</span>t<span class="inline-diff">hreshold</span></span></div>
<div class="line chunk-replace" data-line="303"><span class="line-num">304</span><span class="line-content">        <span class="inline-diff">}</span></span></div>
<div class="line chunk-replace" data-line="304"><span class="line-num">305</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="305"><span class="line-num">306</span><span class="line-content">    def <span class="inline-diff">gener</span>a<span class="inline-diff">te_stock_re</span>p<span class="inline-diff">ort</span>(self):</span></div>
<div class="line chunk-replace" data-line="306"><span class="line-num">307</span><span class="line-content">        <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">G</span>en<span class="inline-diff">er</span>a<span class="inline-diff">t</span>e d<span class="inline-diff">e</span>t<span class="inline-diff">ailed</span> <span class="inline-diff">stock</span> <span class="inline-diff">report&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="307"><span class="line-num">308</span><span class="line-content">        <span class="inline-diff">rep</span>o<span class="inline-diff">r</span>t <span class="inline-diff">= {</span></span></div>
<div class="line chunk-replace" data-line="308"><span class="line-num">309</span><span class="line-content">            <span class="inline-diff">&quot;warehouse_id&quot;: </span>self.<span class="inline-diff">wareho</span>use<span class="inline-diff">_i</span>d<span class="inline-diff">,</span></span></div>
<div class="line chunk-replace" data-line="309"><span class="line-num">310</span><span class="line-content">            <span class="inline-diff">&quot;</span>total<span class="inline-diff">_items&quot;:</span> <span class="inline-diff">len</span>(self.<span class="inline-diff">i</span>t<span class="inline-diff">ems</span>)<span class="inline-diff">,</span></span></div>
<div class="line chunk-replace" data-line="310"><span class="line-num">311</span><span class="line-content">         <span class="inline-diff">   &quot;</span>total<span class="inline-diff">_units&quot;: sum(self.items.values()),</span></span></div>
<div class="line chunk-replace" data-line="311"><span class="line-num">312</span><span class="line-content">            &quot;low_stock_items&quot;: len(self.get_low_stock_items()),</span></div>
<div class="line chunk-replace" data-line="312"><span class="line-num">313</span><span class="line-content">     <span class="inline-diff">       &quot;items&quot;: dict(self.items)</span></span></div>
<div class="line chunk-replace" data-line="313"><span class="line-num">314</span><span class="line-content"> <span class="inline-diff">       }</span></span></div>
<div class="line chunk-replace" data-line="314"><span class="line-num">315</span><span class="line-content">       <span class="inline-diff"> </span>re<span class="inline-diff">turn report</span></span></div>
<div class="line chunk-replace" data-line="315"><span class="line-num">316</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="316"><span class="line-num">317</span><span class="line-content"><span class="inline-diff">#</span> =<span class="inline-diff">===========================================</span></span></div>
<div class="line chunk-replace" data-line="317"><span class="line-num">318</span><span class="line-content"># SECTION 4: Modern Discount System</span></div>
<div class="line chunk-replace" data-line="318"><span class="line-num">319</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">NEW:</span> <span class="inline-diff">Fl</span>e<span class="inline-diff">x</span>i<span class="inline-diff">ble promo</span>ti<span class="inline-diff">on </span>e<span class="inline-diff">ngin</span>e</span></div>
<div class="line " data-line="319"><span class="line-num">320</span><span class="line-content"># ============================================</span></div>
<div class="line " data-line="320"><span class="line-num">321</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="321"><span class="line-num">322</span><span class="line-content">class DiscountCode:</span></div>
<div class="line chunk-replace" data-line="322"><span class="line-num">323</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Advanced</span> discount system <span class="inline-diff">with</span> <span class="inline-diff">expiration&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="323"><span class="line-num">324</span><span class="line-content">    def __init__(self, code, amount<span class="inline-diff">, discount_type=&quot;percentage&quot;, expiry=None</span>):</span></div>
<div class="line " data-line="324"><span class="line-num">325</span><span class="line-content">        self.code = code</span></div>
<div class="line chunk-replace" data-line="325"><span class="line-num">326</span><span class="line-content">        self.amount = <span class="inline-diff">Decimal(str(</span>amount<span class="inline-diff">))</span></span></div>
<div class="line chunk-replace" data-line="326"><span class="line-num">327</span><span class="line-content">        self.d<span class="inline-diff">iscount_type</span> = <span class="inline-diff">di</span>s<span class="inline-diff">count_typ</span>e</span></div>
<div class="line chunk-replace" data-line="327"><span class="line-num">328</span><span class="line-content">        self.expiry = expiry</span></div>
<div class="line chunk-replace" data-line="328"><span class="line-num">329</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.us</span>a<span class="inline-diff">ge_count = 0</span></span></div>
<div class="line chunk-replace" data-line="329"><span class="line-num">330</span><span class="line-content">        <span class="inline-diff">s</span>e<span class="inline-diff">lf.max_us</span>age <span class="inline-diff">=</span> <span class="inline-diff">None</span></span></div>
<div class="line chunk-replace" data-line="330"><span class="line-num">331</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="331"><span class="line-num">332</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">is_valid(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="332"><span class="line-num">333</span><span class="line-content">        <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Ch</span>e<span class="inline-diff">ck</span> <span class="inline-diff">i</span>f<span class="inline-diff"> disc</span>ount<span class="inline-diff"> is still valid&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="333"><span class="line-num">334</span><span class="line-content">        <span class="inline-diff">if self.expi</span>r<span class="inline-diff">y and dat</span>et<span class="inline-diff">ime.d</span>a<span class="inline-diff">tetime.now() &gt; se</span>l<span class="inline-diff">f.expiry:</span></span></div>
<div class="line chunk-replace" data-line="334"><span class="line-num">335</span><span class="line-content">            return False</span></div>
<div class="line chunk-replace" data-line="335"><span class="line-num">336</span><span class="line-content">     <span class="inline-diff">   if self.max_usage and self.usage_count &gt;= self.max_usage:</span></span></div>
<div class="line chunk-replace" data-line="336"><span class="line-num">337</span><span class="line-content"> <span class="inline-diff">           r</span>e<span class="inline-diff">tur</span>n<span class="inline-diff"> F</span>al<span class="inline-diff">se</span></span></div>
<div class="line chunk-replace" data-line="337"><span class="line-num">338</span><span class="line-content">       <span class="inline-diff"> </span>re<span class="inline-diff">turn True</span></span></div>
<div class="line " data-line="338"><span class="line-num">339</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="339"><span class="line-num">340</span><span class="line-content">    def apply(self, total):</span></div>
<div class="line chunk-replace" data-line="340"><span class="line-num">341</span><span class="line-content">        <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Ap</span>pl<span class="inline-diff">y</span> discount <span class="inline-diff">with</span> <span class="inline-diff">type support&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="341"><span class="line-num">342</span><span class="line-content">        if not self.<span class="inline-diff">i</span>s<span class="inline-diff">_vali</span>d<span class="inline-diff">()</span>:</span></div>
<div class="line chunk-replace" data-line="342"><span class="line-num">343</span><span class="line-content">            <span class="inline-diff">rai</span>se<span class="inline-diff"> Va</span>lu<span class="inline-diff">eError(&quot;Di</span>s<span class="inline-diff">count code is expir</span>ed <span class="inline-diff">o</span>r<span class="inline-diff"> </span>e<span class="inline-diff">xhausted&quot;)</span></span></div>
<div class="line chunk-replace" data-line="343"><span class="line-num">344</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="344"><span class="line-num">345</span><span class="line-content">        <span class="inline-diff">s</span>el<span class="inline-diff">f.usage_count += 1</span></span></div>
<div class="line chunk-replace" data-line="345"><span class="line-num">346</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="346"><span class="line-num">347</span><span class="line-content">     <span class="inline-diff">   if self.discount_type == &quot;percentage&quot;:</span></span></div>
<div class="line chunk-replace" data-line="347"><span class="line-num">348</span><span class="line-content"> <span class="inline-diff">           </span>r<span class="inline-diff">eturn t</span>ot<span class="inline-diff">al * (Dec</span>i<span class="inline-diff">mal(&#x27;1&#x27;) - self.am</span>o<span class="inline-diff">u</span>n<span class="inline-diff">t)</span></span></div>
<div class="line chunk-replace" data-line="348"><span class="line-num">349</span><span class="line-content">    <span class="inline-diff">    </span>e<span class="inline-diff">li</span>f self<span class="inline-diff">.</span>discount_t<span class="inline-diff">yp</span>e<span class="inline-diff"> == &quot;fixed&quot;</span>:</span></div>
<div class="line chunk-replace" data-line="349"><span class="line-num">350</span><span class="line-content">        <span class="inline-diff">    return max(total - </span>self.am<span class="inline-diff">ou</span>n<span class="inline-diff">t, D</span>e<span class="inline-diff">cimal(&#x27;0&#x27;))</span></span></div>
<div class="line chunk-replace" data-line="350"><span class="line-num">351</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="351"><span class="line-num">352</span><span class="line-content">        return total</span></div>
<div class="line " data-line="352"><span class="line-num">353</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="353"><span class="line-num">354</span><span class="line-content"><span class="inline-diff">class</span> <span class="inline-diff">P</span>romotionE<span class="inline-diff">ngine:</span></span></div>
<div class="line chunk-replace" data-line="354"><span class="line-num">355</span><span class="line-content"> <span class="inline-diff">   &quot;&quot;&quot;NEW: C</span>en<span class="inline-diff">tr</span>al<span class="inline-diff">ized p</span>romotion<span class="inline-diff"> management&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="355"><span class="line-num">356</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="356"><span class="line-num">357</span><span class="line-content">        self.a<span class="inline-diff">ctiv</span>e<span class="inline-diff">_promotions</span> = <span class="inline-diff">{}</span></span></div>
<div class="line chunk-replace" data-line="357"><span class="line-num">358</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="358"><span class="line-num">359</span><span class="line-content">    def add_promotion(self, name, discount_code):</span></div>
<div class="line chunk-replace" data-line="359"><span class="line-num">360</span><span class="line-content">     <span class="inline-diff">   </span>s<span class="inline-diff">elf.</span>active<span class="inline-diff">_promotion</span>s<span class="inline-diff">[nam</span>e<span class="inline-diff">] = discount_code</span></span></div>
<div class="line chunk-replace" data-line="360"><span class="line-num">361</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="361"><span class="line-num">362</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">g</span>et<span class="inline-diff">_b</span>e<span class="inline-diff">st_promotion(self, total):</span></span></div>
<div class="line chunk-replace" data-line="362"><span class="line-num">363</span><span class="line-content">        &quot;&quot;&quot;NEW: Find best applicable promotion&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="363"><span class="line-num">364</span><span class="line-content"><span class="inline-diff">        best_discount</span> =<span class="inline-diff"> Decimal(&#x27;0&#x27;)</span></span></div>
<div class="line chunk-replace" data-line="364"><span class="line-num">365</span><span class="line-content">     <span class="inline-diff">   be</span>s<span class="inline-diff">t_promo = None</span></span></div>
<div class="line chunk-replace" data-line="365"><span class="line-num">366</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="366"><span class="line-num">367</span><span class="line-content"> <span class="inline-diff">       for name, promo in self.active_promotions.items():</span></span></div>
<div class="line chunk-replace" data-line="367"><span class="line-num">368</span><span class="line-content">            if promo.is_valid():</span></div>
<div class="line chunk-replace" data-line="368"><span class="line-num">369</span><span class="line-content"> <span class="inline-diff">               discou</span>nte<span class="inline-diff">d = </span>pr<span class="inline-diff">omo.apply</span>(<span class="inline-diff">to</span>ta<span class="inline-diff">l</span>)</span></div>
<div class="line chunk-replace" data-line="369"><span class="line-num">370</span><span class="line-content">       <span class="inline-diff">         d</span>i<span class="inline-diff">s</span>c<span class="inline-diff">ount_amount = total</span> - <span class="inline-diff">d</span>i<span class="inline-diff">scount</span>e<span class="inline-diff">d</span></span></div>
<div class="line chunk-replace" data-line="370"><span class="line-num">371</span><span class="line-content">    <span class="inline-diff">            </span>i<span class="inline-diff">f discou</span>nt<span class="inline-diff">_</span>a<span class="inline-diff">m</span>o<span class="inline-diff">un</span>t <span class="inline-diff">&gt;</span> <span class="inline-diff">be</span>st_d<span class="inline-diff">isc</span>o<span class="inline-diff">u</span>nt<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="371"><span class="line-num">372</span><span class="line-content">     <span class="inline-diff">               b</span>est_d<span class="inline-diff">i</span>s<span class="inline-diff">count</span> <span class="inline-diff">= discount_amount</span></span></div>
<div class="line chunk-replace" data-line="372"><span class="line-num">373</span><span class="line-content">                    best_promo = name</span></div>
<div class="line chunk-replace" data-line="373"><span class="line-num">374</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="374"><span class="line-num">375</span><span class="line-content">      <span class="inline-diff">  return best_promo, best_discount</span></span></div>
<div class="line chunk-replace" data-line="375"><span class="line-num">376</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="376"><span class="line-num">377</span><span class="line-content"><span class="inline-diff">#</span> =<span class="inline-diff">===========================================</span></span></div>
<div class="line chunk-replace" data-line="377"><span class="line-num">378</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">SECTION</span> <span class="inline-diff">5:</span> <span class="inline-diff">Adva</span>n<span class="inline-diff">ced</span> <span class="inline-diff">An</span>al<span class="inline-diff">ytics</span></span></div>
<div class="line chunk-replace" data-line="378"><span class="line-num">379</span><span class="line-content"># NEW: Comprehensive reporting system</span></div>
<div class="line chunk-replace" data-line="379"><span class="line-num">380</span><span class="line-content"># <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="380"><span class="line-num">381</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="381"><span class="line-num">382</span><span class="line-content"><span class="inline-diff">de</span>f<span class="inline-diff"> gen</span>er<span class="inline-diff">at</span>e_<span class="inline-diff">sal</span>e<span class="inline-diff">s_</span>r<span class="inline-diff">ep</span>ort<span class="inline-diff">(start_date, e</span>n<span class="inline-diff">d_date, include_details=True</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="382"><span class="line-num">383</span><span class="line-content">    &quot;&quot;&quot;NEW: Enhanced reporting with detailed breakdowns&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="383"><span class="line-num">384</span><span class="line-content"> <span class="inline-diff">   r</span>eport<span class="inline-diff"> </span>=<span class="inline-diff"> {</span></span></div>
<div class="line chunk-replace" data-line="384"><span class="line-num">385</span><span class="line-content">      <span class="inline-diff">  &quot;</span>p<span class="inline-diff">eri</span>o<span class="inline-diff">d&quot;: {&quot;sta</span>rt<span class="inline-diff">&quot;:</span> <span class="inline-diff">start_dat</span>e<span class="inline-diff">,</span> <span class="inline-diff">&quot;end&quot;: end_date},</span></span></div>
<div class="line chunk-replace" data-line="385"><span class="line-num">386</span><span class="line-content">      <span class="inline-diff"> </span> &quot;s<span class="inline-diff">ummary</span>&quot;:<span class="inline-diff"> {</span></span></div>
<div class="line chunk-replace" data-line="386"><span class="line-num">387</span><span class="line-content">        <span class="inline-diff">   </span> &quot;<span class="inline-diff">to</span>ta<span class="inline-diff">l_</span>s<span class="inline-diff">ales</span>&quot;<span class="inline-diff">: Decimal(&#x27;15000.00&#x27;),</span></span></div>
<div class="line chunk-replace" data-line="387"><span class="line-num">388</span><span class="line-content">    <span class="inline-diff">       </span> &quot;<span class="inline-diff">to</span>ta<span class="inline-diff">l_</span>o<span class="inline-diff">rders</span>&quot;<span class="inline-diff">: 150,</span></span></div>
<div class="line chunk-replace" data-line="388"><span class="line-num">389</span><span class="line-content">            &quot;average_order_value&quot;: Decimal(&#x27;100.00&#x27;)</span></div>
<div class="line chunk-replace" data-line="389"><span class="line-num">390</span><span class="line-content"> <span class="inline-diff">       }</span></span></div>
<div class="line chunk-replace" data-line="390"><span class="line-num">391</span><span class="line-content">    <span class="inline-diff">}</span></span></div>
<div class="line chunk-replace" data-line="391"><span class="line-num">392</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="392"><span class="line-num">393</span><span class="line-content"> <span class="inline-diff">   if include_details:</span></span></div>
<div class="line chunk-replace" data-line="393"><span class="line-num">394</span><span class="line-content">        report[&quot;details&quot;] = {</span></div>
<div class="line chunk-replace" data-line="394"><span class="line-num">395</span><span class="line-content"> <span class="inline-diff">           &quot;top_p</span>r<span class="inline-diff">oducts&quot;</span>:<span class="inline-diff"> [],</span></span></div>
<div class="line chunk-replace" data-line="395"><span class="line-num">396</span><span class="line-content">          <span class="inline-diff">  &quot;</span>s<span class="inline-diff">ales_by_day&quot;: {},</span></span></div>
<div class="line chunk-replace" data-line="396"><span class="line-num">397</span><span class="line-content">      <span class="inline-diff">      &quot;c</span>us<span class="inline-diff">to</span>mer<span class="inline-diff">_segments&quot;</span>:<span class="inline-diff"> {}</span></span></div>
<div class="line chunk-replace" data-line="397"><span class="line-num">398</span><span class="line-content">        <span class="inline-diff">}</span></span></div>
<div class="line chunk-replace" data-line="398"><span class="line-num">399</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="399"><span class="line-num">400</span><span class="line-content">    l<span class="inline-diff">ogger</span>.i<span class="inline-diff">nfo(f&quot;G</span>e<span class="inline-diff">n</span>e<span class="inline-diff">rated sales report for {start_date} to {end_date}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="400"><span class="line-num">401</span><span class="line-content">    <span class="inline-diff">r</span>e<span class="inline-diff">tur</span>n <span class="inline-diff">r</span>e<span class="inline-diff">port</span></span></div>
<div class="line chunk-replace" data-line="401"><span class="line-num">402</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="402"><span class="line-num">403</span><span class="line-content">def c<span class="inline-diff">alcul</span>ate<span class="inline-diff">_r</span>e<span class="inline-diff">venue(</span>ord<span class="inline-diff">ers, include_tax=True</span>):</span></div>
<div class="line chunk-replace" data-line="403"><span class="line-num">404</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Revenu</span>e c<span class="inline-diff">al</span>c<span class="inline-diff">ulation</span> wi<span class="inline-diff">th</span> <span class="inline-diff">tax</span> <span class="inline-diff">option&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="404"><span class="line-num">405</span><span class="line-content">    to<span class="inline-diff">tal</span> = <span class="inline-diff">Decim</span>a<span class="inline-diff">l(&#x27;0&#x27;)</span></span></div>
<div class="line " data-line="405"><span class="line-num">406</span><span class="line-content">    for order in orders:</span></div>
<div class="line chunk-replace" data-line="406"><span class="line-num">407</span><span class="line-content">        <span class="inline-diff">order_</span>total = order.get_total()</span></div>
<div class="line chunk-replace" data-line="407"><span class="line-num">408</span><span class="line-content">     <span class="inline-diff">   if n</span>ot<span class="inline-diff"> inc</span>l<span class="inline-diff">ude_tax:</span></span></div>
<div class="line chunk-replace" data-line="408"><span class="line-num">409</span><span class="line-content">            # Remove tax for net revenue</span></div>
<div class="line chunk-replace" data-line="409"><span class="line-num">410</span><span class="line-content">  <span class="inline-diff">          order_tot</span>al <span class="inline-diff">=</span> <span class="inline-diff">order_total /</span> D<span class="inline-diff">ecimal(&#x27;1.08&#x27;)</span></span></div>
<div class="line chunk-replace" data-line="410"><span class="line-num">411</span><span class="line-content"><span class="inline-diff">       </span> t<span class="inline-diff">ot</span>a<span class="inline-diff">l += ord</span>er_to<span class="inline-diff">tal</span></span></div>
<div class="line " data-line="411"><span class="line-num">412</span><span class="line-content">    return total</span></div>
<div class="line " data-line="412"><span class="line-num">413</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="413"><span class="line-num">414</span><span class="line-content"><span class="inline-diff">def</span> analy<span class="inline-diff">ze_</span>cu<span class="inline-diff">s</span>t<span class="inline-diff">omer_behav</span>io<span class="inline-diff">r(customer_id,</span> <span class="inline-diff">time_period=30):</span></span></div>
<div class="line chunk-replace" data-line="414"><span class="line-num">415</span><span class="line-content"> <span class="inline-diff">   &quot;&quot;&quot;NEW: C</span>us<span class="inline-diff">tom</span>er<span class="inline-diff"> </span>behavior a<span class="inline-diff">naly</span>ti<span class="inline-diff">cs&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="415"><span class="line-num">416</span><span class="line-content">    re<span class="inline-diff">tu</span>r<span class="inline-diff">n</span> {</span></div>
<div class="line chunk-replace" data-line="416"><span class="line-num">417</span><span class="line-content">        &quot;customer_id&quot;: customer_id,</span></div>
<div class="line chunk-replace" data-line="417"><span class="line-num">418</span><span class="line-content"> <span class="inline-diff">       &quot;</span>t<span class="inline-diff">ime_period</span>_da<span class="inline-diff">y</span>s&quot;:<span class="inline-diff"> time_period,</span></span></div>
<div class="line chunk-replace" data-line="418"><span class="line-num">419</span><span class="line-content">      <span class="inline-diff">  &quot;total_</span>or<span class="inline-diff">d</span>e<span class="inline-diff">rs&quot;:</span> <span class="inline-diff">5,</span></span></div>
<div class="line chunk-replace" data-line="419"><span class="line-num">420</span><span class="line-content">      <span class="inline-diff"> </span> &quot;<span class="inline-diff">total_</span>s<span class="inline-diff">pent</span>&quot;:<span class="inline-diff"> Decimal(&#x27;500.00&#x27;),</span></span></div>
<div class="line chunk-replace" data-line="420"><span class="line-num">421</span><span class="line-content">        &quot;av<span class="inline-diff">erage_order_value</span>&quot;<span class="inline-diff">: Decimal(&#x27;100.00&#x27;),</span></span></div>
<div class="line chunk-replace" data-line="421"><span class="line-num">422</span><span class="line-content">    <span class="inline-diff">   </span> &quot;<span class="inline-diff">preferre</span>d<span class="inline-diff">_c</span>at<span class="inline-diff">egorie</span>s<span class="inline-diff">&quot;: [&quot;Electr</span>on<span class="inline-diff">ics</span>&quot;<span class="inline-diff">, &quot;Books&quot;]</span></span></div>
<div class="line chunk-replace" data-line="422"><span class="line-num">423</span><span class="line-content">    }</span></div>
<div class="line chunk-replace" data-line="423"><span class="line-num">424</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="424"><span class="line-num">425</span><span class="line-content"><span class="inline-diff">d</span>e<span class="inline-diff">f</span> e<span class="inline-diff">xpor</span>t<span class="inline-diff">_d</span>at<span class="inline-diff">a(format=&quot;js</span>on<span class="inline-diff">&quot;, include_metadata=True):</span></span></div>
<div class="line chunk-replace" data-line="425"><span class="line-num">426</span><span class="line-content">   <span class="inline-diff"> &quot;&quot;&quot;NEW: Enhan</span>c<span class="inline-diff">ed exp</span>o<span class="inline-diff">rt with </span>m<span class="inline-diff">ulti</span>ple <span class="inline-diff">formats&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="426"><span class="line-num">427</span><span class="line-content"><span class="inline-diff">    supported_formats</span> =<span class="inline-diff"> [&quot;json&quot;, &quot;csv&quot;, &quot;xml&quot;, &quot;xlsx&quot;]</span></span></div>
<div class="line chunk-replace" data-line="427"><span class="line-num">428</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="428"><span class="line-num">429</span><span class="line-content"> <span class="inline-diff">   if fo</span>r<span class="inline-diff">mat not in supported_formats</span>:</span></div>
<div class="line chunk-replace" data-line="429"><span class="line-num">430</span><span class="line-content">      <span class="inline-diff">  rai</span>se <span class="inline-diff">Va</span>l<span class="inline-diff">ue</span>E<span class="inline-diff">rror(f&quot;Unsupported</span> f<span class="inline-diff">ormat. U</span>s<span class="inline-diff">e: {&#x27;, &#x27;.join(supported_formats)}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="430"><span class="line-num">431</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="431"><span class="line-num">432</span><span class="line-content">    me<span class="inline-diff">tadata</span> = <span class="inline-diff">{}</span></span></div>
<div class="line chunk-replace" data-line="432"><span class="line-num">433</span><span class="line-content">    <span class="inline-diff">i</span>f <span class="inline-diff">inclu</span>d<span class="inline-diff">e_metadata:</span></span></div>
<div class="line chunk-replace" data-line="433"><span class="line-num">434</span><span class="line-content">        <span class="inline-diff">m</span>et<span class="inline-diff">adata</span> = <span class="inline-diff">{</span></span></div>
<div class="line chunk-replace" data-line="434"><span class="line-num">435</span><span class="line-content">         <span class="inline-diff">   &quot;exp</span>o<span class="inline-diff">rte</span>d_<span class="inline-diff">at&quot;:</span> <span class="inline-diff">dat</span>e<span class="inline-diff">time.datetime.now().isoformat(),</span></span></div>
<div class="line chunk-replace" data-line="435"><span class="line-num">436</span><span class="line-content">            &quot;format&quot;: format,</span></div>
<div class="line chunk-replace" data-line="436"><span class="line-num">437</span><span class="line-content">      <span class="inline-diff">      &quot;ve</span>r<span class="inline-diff">sion&quot;</span>:<span class="inline-diff"> &quot;2.0&quot;</span></span></div>
<div class="line chunk-replace" data-line="437"><span class="line-num">438</span><span class="line-content">        <span class="inline-diff">}</span></span></div>
<div class="line chunk-replace" data-line="438"><span class="line-num">439</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="439"><span class="line-num">440</span><span class="line-content">    return f&quot;data_export.{format}&quot;, metadata</span></div>
<div class="line chunk-replace" data-line="440"><span class="line-num">441</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="441"><span class="line-num">442</span><span class="line-content"><span class="inline-diff">#</span> =<span class="inline-diff">===========================================</span></span></div>
<div class="line chunk-replace" data-line="442"><span class="line-num">443</span><span class="line-content"># SECTION 6: Secure Authentication</span></div>
<div class="line chunk-replace" data-line="443"><span class="line-num">444</span><span class="line-content"># <span class="inline-diff">NEW:</span> <span class="inline-diff">M</span>o<span class="inline-diff">der</span>n <span class="inline-diff">auth with hashing </span>an<span class="inline-diff">d tok</span>en<span class="inline-diff">s</span></span></div>
<div class="line chunk-replace" data-line="444"><span class="line-num">445</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="445"><span class="line-num">446</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="446"><span class="line-num">447</span><span class="line-content">import hashlib</span></div>
<div class="line " data-line="447"><span class="line-num">448</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="448"><span class="line-num">449</span><span class="line-content">class User:</span></div>
<div class="line chunk-replace" data-line="449"><span class="line-num">450</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Secure</span> user model <span class="inline-diff">w</span>i<span class="inline-diff">th pa</span>s<span class="inline-diff">sword hashing&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="450"><span class="line-num">451</span><span class="line-content">    def __init__(self, username, <span class="inline-diff">email, </span>password<span class="inline-diff">_hash=None</span>):</span></div>
<div class="line " data-line="451"><span class="line-num">452</span><span class="line-content">        self.username = username</span></div>
<div class="line chunk-replace" data-line="452"><span class="line-num">453</span><span class="line-content">        self.<span class="inline-diff">em</span>a<span class="inline-diff">il</span> = <span class="inline-diff">em</span>a<span class="inline-diff">il</span></span></div>
<div class="line chunk-replace" data-line="453"><span class="line-num">454</span><span class="line-content">        self.<span class="inline-diff">p</span>a<span class="inline-diff">ssword_hash</span> = <span class="inline-diff">passwo</span>r<span class="inline-diff">d_hash</span></span></div>
<div class="line " data-line="454"><span class="line-num">455</span><span class="line-content">        self.is_active = True</span></div>
<div class="line chunk-replace" data-line="455"><span class="line-num">456</span><span class="line-content">        se<span class="inline-diff">lf.create</span>d<span class="inline-diff">_at</span> = <span class="inline-diff">dat</span>e<span class="inline-diff">time.datetime.now()</span></span></div>
<div class="line chunk-replace" data-line="456"><span class="line-num">457</span><span class="line-content">        self.last_login = None</span></div>
<div class="line chunk-replace" data-line="457"><span class="line-num">458</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="458"><span class="line-num">459</span><span class="line-content">    <span class="inline-diff">d</span>e<span class="inline-diff">f set_password(self,</span> password<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="459"><span class="line-num">460</span><span class="line-content">        <span class="inline-diff">&quot;&quot;&quot;NEW: S</span>et password<span class="inline-diff"> with hashing&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="460"><span class="line-num">461</span><span class="line-content">        self.password_hash = hashlib.sha256(password.encode()).hexdigest()</span></div>
<div class="line " data-line="461"><span class="line-num">462</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="462"><span class="line-num">463</span><span class="line-content">    def authenticate(self, password):</span></div>
<div class="line chunk-replace" data-line="463"><span class="line-num">464</span><span class="line-content">        <span class="inline-diff">&quot;&quot;&quot;NEW:</span> S<span class="inline-diff">ecur</span>e password <span class="inline-diff">v</span>e<span class="inline-diff">r</span>i<span class="inline-diff">fication&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="464"><span class="line-num">465</span><span class="line-content">        password<span class="inline-diff">_hash = hashlib.sha256(password.encode()).hexdigest()</span></span></div>
<div class="line chunk-replace" data-line="465"><span class="line-num">466</span><span class="line-content">        if self.password_hash == password_hash:</span></div>
<div class="line chunk-replace" data-line="466"><span class="line-num">467</span><span class="line-content">     <span class="inline-diff">       </span>self<span class="inline-diff">.l</span>as<span class="inline-diff">t_l</span>o<span class="inline-diff">gin = </span>d<span class="inline-diff">atetime.datetime.now(</span>)</span></div>
<div class="line chunk-replace" data-line="467"><span class="line-num">468</span><span class="line-content">          <span class="inline-diff">  </span>r<span class="inline-diff">eturn True</span></span></div>
<div class="line chunk-replace" data-line="468"><span class="line-num">469</span><span class="line-content">        return False</span></div>
<div class="line chunk-replace" data-line="469"><span class="line-num">470</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="470"><span class="line-num">471</span><span class="line-content"><span class="inline-diff">    </span>def rese<span class="inline-diff">t_pa</span>ss<span class="inline-diff">w</span>o<span class="inline-diff">rd</span>(se<span class="inline-diff">lf, old_passwo</span>r<span class="inline-diff">d, new_password</span>):</span></div>
<div class="line chunk-replace" data-line="471"><span class="line-num">472</span><span class="line-content">      <span class="inline-diff"> </span> &quot;<span class="inline-diff">&quot;&quot;NEW: Password </span>res<span class="inline-diff">et</span> <span class="inline-diff">with verification</span>&quot;&quot;<span class="inline-diff">&quot;</span></span></div>
<div class="line chunk-replace" data-line="472"><span class="line-num">473</span><span class="line-content">        if self.authenticate(old_password):</span></div>
<div class="line chunk-replace" data-line="473"><span class="line-num">474</span><span class="line-content"> <span class="inline-diff">           self.set_password(new_password)</span></span></div>
<div class="line chunk-replace" data-line="474"><span class="line-num">475</span><span class="line-content">   <span class="inline-diff">         re</span>t<span class="inline-diff">ur</span>n <span class="inline-diff">Tru</span>e</span></div>
<div class="line chunk-replace" data-line="475"><span class="line-num">476</span><span class="line-content">   <span class="inline-diff">     r</span>e<span class="inline-diff">turn Fal</span>s<span class="inline-diff">e</span></span></div>
<div class="line chunk-replace" data-line="476"><span class="line-num">477</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="477"><span class="line-num">478</span><span class="line-content">def create_auth_token(user, expiry_hours=24):</span></div>
<div class="line chunk-replace" data-line="478"><span class="line-num">479</span><span class="line-content"> <span class="inline-diff">   &quot;&quot;&quot;NEW: Tok</span>en<span class="inline-diff">-</span>b<span class="inline-diff">as</span>ed<span class="inline-diff"> authentication&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="479"><span class="line-num">480</span><span class="line-content">    e<span class="inline-diff">xp</span>i<span class="inline-diff">ry</span> <span class="inline-diff">=</span> <span class="inline-diff">datetime.datetime.now()</span> <span class="inline-diff">+ datetime.timedelta(hours=expiry_hours)</span></span></div>
<div class="line chunk-replace" data-line="480"><span class="line-num">481</span><span class="line-content">    ret<span class="inline-diff">urn</span> {</span></div>
<div class="line chunk-replace" data-line="481"><span class="line-num">482</span><span class="line-content">    <span class="inline-diff">    </span>&quot;u<span class="inline-diff">s</span>e<span class="inline-diff">r_id&quot;</span>: u<span class="inline-diff">s</span>e<span class="inline-diff">r.username,</span></span></div>
<div class="line chunk-replace" data-line="482"><span class="line-num">483</span><span class="line-content">    <span class="inline-diff">    &quot;</span>t<span class="inline-diff">oken&quot;: hashlib.sha256(f&quot;{</span>u<span class="inline-diff">ser.use</span>rn<span class="inline-diff">am</span>e<span class="inline-diff">}{expiry}&quot;.encode()).hexdigest(),</span></span></div>
<div class="line chunk-replace" data-line="483"><span class="line-num">484</span><span class="line-content">        &quot;expires&quot;: expiry.isoformat()</span></div>
<div class="line chunk-replace" data-line="484"><span class="line-num">485</span><span class="line-content">  <span class="inline-diff">  }</span></span></div>
<div class="line chunk-replace" data-line="485"><span class="line-num">486</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="486"><span class="line-num">487</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="487"><span class="line-num">488</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">SEC</span>T<span class="inline-diff">ION 7: M</span>u<span class="inline-diff">lti-Chann</span>e<span class="inline-diff">l Notifications</span></span></div>
<div class="line chunk-replace" data-line="488"><span class="line-num">489</span><span class="line-content"># NEW: Enhanced notification system</span></div>
<div class="line chunk-replace" data-line="489"><span class="line-num">490</span><span class="line-content"># <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="490"><span class="line-num">491</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="491"><span class="line-num">492</span><span class="line-content"><span class="inline-diff">c</span>l<span class="inline-diff">ass Noti</span>f<span class="inline-diff">icationService</span>:</span></div>
<div class="line chunk-replace" data-line="492"><span class="line-num">493</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW:</span> <span class="inline-diff">Unified</span> <span class="inline-diff">notification</span> se<span class="inline-diff">rv</span>i<span class="inline-diff">ce&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="493"><span class="line-num">494</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="494"><span class="line-num">495</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.</span>p<span class="inline-diff">rov</span>i<span class="inline-diff">d</span>e<span class="inline-diff">r</span>s<span class="inline-diff"> = {</span></span></div>
<div class="line chunk-replace" data-line="495"><span class="line-num">496</span><span class="line-content">        <span class="inline-diff">    </span>&quot;<span class="inline-diff">email</span>&quot;: <span class="inline-diff">E</span>ma<span class="inline-diff">ilProvid</span>e<span class="inline-diff">r(</span>)<span class="inline-diff">,</span></span></div>
<div class="line chunk-replace" data-line="496"><span class="line-num">497</span><span class="line-content">            &quot;sms&quot;: SMSProvider(),</span></div>
<div class="line chunk-replace" data-line="497"><span class="line-num">498</span><span class="line-content">    <span class="inline-diff">        &quot;push&quot;: PushNotificationProvi</span>de<span class="inline-diff">r</span>()</span></div>
<div class="line chunk-replace" data-line="498"><span class="line-num">499</span><span class="line-content">        <span class="inline-diff">}</span></span></div>
<div class="line chunk-replace" data-line="499"><span class="line-num">500</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="500"><span class="line-num">501</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">send(</span>self<span class="inline-diff">, channel, reci</span>p<span class="inline-diff">i</span>en<span class="inline-diff">t,</span> <span class="inline-diff">message,</span> <span class="inline-diff">priority=&quot;normal&quot;):</span></span></div>
<div class="line chunk-replace" data-line="501"><span class="line-num">502</span><span class="line-content">        &quot;&quot;&quot;NEW: Send notification through specified channel&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="502"><span class="line-num">503</span><span class="line-content"> <span class="inline-diff">       if channel not in self.providers:</span></span></div>
<div class="line chunk-replace" data-line="503"><span class="line-num">504</span><span class="line-content">   <span class="inline-diff">         </span>rai<span class="inline-diff">se</span> <span class="inline-diff">V</span>a<span class="inline-diff">lueError(f&quot;U</span>n<span class="inline-diff">supporte</span>d <span class="inline-diff">cha</span>n<span class="inline-diff">nel: {channel}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="504"><span class="line-num">505</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="505"><span class="line-num">506</span><span class="line-content"><span class="inline-diff">        provider</span> =<span class="inline-diff"> self.providers[channel]</span></span></div>
<div class="line chunk-replace" data-line="506"><span class="line-num">507</span><span class="line-content">        return provider.send(recipient, message, priority)</span></div>
<div class="line chunk-replace" data-line="507"><span class="line-num">508</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="508"><span class="line-num">509</span><span class="line-content"><span class="inline-diff">class</span> <span class="inline-diff">EmailProvider:</span></span></div>
<div class="line chunk-replace" data-line="509"><span class="line-num">510</span><span class="line-content">    &quot;&quot;<span class="inline-diff">&quot;NEW</span>: Em<span class="inline-diff">ail s</span>er<span class="inline-diff">vi</span>ce <span class="inline-diff">pro</span>v<span class="inline-diff">ider</span>&quot;<span class="inline-diff">&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="510"><span class="line-num">511</span><span class="line-content">    de<span class="inline-diff">f</span> <span class="inline-diff">send(self, to, messag</span>e,<span class="inline-diff"> priority=&quot;normal&quot;):</span></span></div>
<div class="line chunk-replace" data-line="511"><span class="line-num">512</span><span class="line-content">    <span class="inline-diff">    logge</span>r<span class="inline-diff">.</span>i<span class="inline-diff">nfo(f&quot;Sending </span>em<span class="inline-diff">ail to {to} (priority</span>: <span class="inline-diff">{priority})&quot;)</span></span></div>
<div class="line chunk-replace" data-line="512"><span class="line-num">513</span><span class="line-content">    <span class="inline-diff">    return {</span>&quot;st<span class="inline-diff">a</span>t<span class="inline-diff">us</span>&quot;: <span class="inline-diff">&quot;sent&quot;</span>,<span class="inline-diff"> &quot;channel&quot;: &quot;email&quot;}</span></span></div>
<div class="line chunk-replace" data-line="513"><span class="line-num">514</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="514"><span class="line-num">515</span><span class="line-content"><span class="inline-diff">class SMSProvider:</span></span></div>
<div class="line chunk-replace" data-line="515"><span class="line-num">516</span><span class="line-content">    &quot;&quot;&quot;NEW: SMS service provider&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="516"><span class="line-num">517</span><span class="line-content"><span class="inline-diff">    </span>def <span class="inline-diff">s</span>e<span class="inline-diff">nd(self, ph</span>one<span class="inline-diff">, message, priorit</span>y<span class="inline-diff">=&quot;normal&quot;</span>):</span></div>
<div class="line chunk-replace" data-line="517"><span class="line-num">518</span><span class="line-content">     <span class="inline-diff">   log</span>ge<span class="inline-diff">r.info</span>(<span class="inline-diff">f&quot;S</span>e<span class="inline-diff">nding SMS to {phone} (priorit</span>y<span class="inline-diff">: {priority}</span>)<span class="inline-diff">&quot;)</span></span></div>
<div class="line chunk-replace" data-line="518"><span class="line-num">519</span><span class="line-content">        return {&quot;status&quot;: &quot;sent&quot;, &quot;channel&quot;: &quot;sms&quot;}</span></div>
<div class="line chunk-replace" data-line="519"><span class="line-num">520</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="520"><span class="line-num">521</span><span class="line-content"><span class="inline-diff">c</span>l<span class="inline-diff">ass P</span>u<span class="inline-diff">shNotificationProvid</span>e<span class="inline-diff">r:</span></span></div>
<div class="line chunk-replace" data-line="521"><span class="line-num">522</span><span class="line-content">    &quot;&quot;&quot;NEW: Push notification provider&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="522"><span class="line-num">523</span><span class="line-content">  <span class="inline-diff">  def se</span>n<span class="inline-diff">d(se</span>l<span class="inline-diff">f, dev</span>i<span class="inline-diff">ce_id, mess</span>a<span class="inline-diff">ge, pr</span>io<span class="inline-diff">rity=&quot;</span>n<span class="inline-diff">ormal&quot;):</span></span></div>
<div class="line chunk-replace" data-line="523"><span class="line-num">524</span><span class="line-content"> <span class="inline-diff">       logger.</span>in<span class="inline-diff">fo(f&quot;Send</span>i<span class="inline-diff">ng push </span>t<span class="inline-diff">o {dev</span>i<span class="inline-diff">c</span>e_<span class="inline-diff">id} </span>(<span class="inline-diff">priority</span>:<span class="inline-diff"> {priority})&quot;)</span></span></div>
<div class="line chunk-replace" data-line="524"><span class="line-num">525</span><span class="line-content">     <span class="inline-diff">   re</span>t<span class="inline-diff">ur</span>n <span class="inline-diff">{</span>&quot;<span class="inline-diff">status&quot;: &quot;sent&quot;, &quot;channel&quot;: &quot;push&quot;}</span></span></div>
<div class="line chunk-replace" data-line="525"><span class="line-num">526</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="526"><span class="line-num">527</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-replace" data-line="527"><span class="line-num">528</span><span class="line-content"># <span class="inline-diff">SECTION 8: Configuration Management</span></span></div>
<div class="line chunk-replace" data-line="528"><span class="line-num">529</span><span class="line-content"># N<span class="inline-diff">EW</span>: E<span class="inline-diff">nvi</span>ron<span class="inline-diff">me</span>n<span class="inline-diff">t-based confi</span>g<span class="inline-diff">uration</span></span></div>
<div class="line chunk-replace" data-line="529"><span class="line-num">530</span><span class="line-content"># <span class="inline-diff">============================================</span></span></div>
<div class="line chunk-replace" data-line="530"><span class="line-num">531</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="531"><span class="line-num">532</span><span class="line-content">CONFIG = {</span></div>
<div class="line chunk-replace" data-line="532"><span class="line-num">533</span><span class="line-content"> <span class="inline-diff">   &quot;</span>a<span class="inline-diff">pp_na</span>me<span class="inline-diff">&quot;: &quot;</span>E<span class="inline-diff">-c</span>o<span class="inline-diff">mme</span>rce<span class="inline-diff"> v2.0&quot;,</span></span></div>
<div class="line chunk-replace" data-line="533"><span class="line-num">534</span><span class="line-content">    <span class="inline-diff">&quot;environment&quot;: &quot;</span>p<span class="inline-diff">roduction&quot;,</span></span></div>
<div class="line chunk-replace" data-line="534"><span class="line-num">535</span><span class="line-content">    &quot;debug_mode&quot;: False,</span></div>
<div class="line chunk-replace" data-line="535"><span class="line-num">536</span><span class="line-content"> <span class="inline-diff">   &quot;ma</span>x<span class="inline-diff">_</span>c<span class="inline-diff">ar</span>t<span class="inline-diff">_</span>i<span class="inline-diff">tems&quot;</span>:<span class="inline-diff"> 200,</span></span></div>
<div class="line chunk-replace" data-line="536"><span class="line-num">537</span><span class="line-content">    <span class="inline-diff">&quot;se</span>ss<span class="inline-diff">ion_timeout&quot;: 7200,</span></span></div>
<div class="line chunk-replace" data-line="537"><span class="line-num">538</span><span class="line-content">    &quot;payment_providers&quot;: [&quot;stripe&quot;, &quot;paypal&quot;],</span></div>
<div class="line chunk-replace" data-line="538"><span class="line-num">539</span><span class="line-content">  <span class="inline-diff">  &quot;supp</span>or<span class="inline-diff">ted_</span>c<span class="inline-diff">urrencie</span>s<span class="inline-diff">&quot;:</span> <span class="inline-diff">[&quot;US</span>D<span class="inline-diff">&quot;, &quot;</span>E<span class="inline-diff">UR&quot;, &quot;GBP&quot;],</span></span></div>
<div class="line chunk-replace" data-line="539"><span class="line-num">540</span><span class="line-content"> <span class="inline-diff">   &quot;f</span>eat<span class="inline-diff">ures&quot;</span>:<span class="inline-diff"> {</span></span></div>
<div class="line chunk-replace" data-line="540"><span class="line-num">541</span><span class="line-content">    <span class="inline-diff">    &quot;loy</span>a<span class="inline-diff">lty_program&quot;: True,</span></span></div>
<div class="line chunk-replace" data-line="541"><span class="line-num">542</span><span class="line-content">        &quot;gift_cards&quot;: True,</span></div>
<div class="line chunk-replace" data-line="542"><span class="line-num">543</span><span class="line-content"> <span class="inline-diff">       &quot;wis</span>hl<span class="inline-diff">ists&quot;</span>:<span class="inline-diff"> True</span></span></div>
<div class="line chunk-replace" data-line="543"><span class="line-num">544</span><span class="line-content">    <span class="inline-diff">}</span></span></div>
<div class="line chunk-replace" data-line="544"><span class="line-num">545</span><span class="line-content">}</span></div>
<div class="line chunk-replace" data-line="545"><span class="line-num">546</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="546"><span class="line-num">547</span><span class="line-content">def get_config(key, default=None):</span></div>
<div class="line chunk-replace" data-line="547"><span class="line-num">548</span><span class="line-content"> <span class="inline-diff">   &quot;&quot;&quot;NEW: Get config with default value&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="548"><span class="line-num">549</span><span class="line-content">   <span class="inline-diff"> retur</span>n <span class="inline-diff">CONFIG.</span>g<span class="inline-diff">et(key, default)</span></span></div>
<div class="line chunk-replace" data-line="549"><span class="line-num">550</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="550"><span class="line-num">551</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">set_config(key, value):</span></span></div>
<div class="line chunk-replace" data-line="551"><span class="line-num">552</span><span class="line-content">    &quot;&quot;&quot;NEW: Set config with validation&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="552"><span class="line-num">553</span><span class="line-content"><span class="inline-diff">    i</span>f <span class="inline-diff">not is</span>in<span class="inline-diff">stance</span>(<span class="inline-diff">key, str</span>):</span></div>
<div class="line chunk-replace" data-line="553"><span class="line-num">554</span><span class="line-content">    <span class="inline-diff">    raise ValueError(&quot;Config key must be st</span>rin<span class="inline-diff">g</span>&quot;)</span></div>
<div class="line chunk-replace" data-line="554"><span class="line-num">555</span><span class="line-content">    <span class="inline-diff">C</span>O<span class="inline-diff">NFIG[key]</span> <span class="inline-diff">= v</span>al<span class="inline-diff">u</span>e</span></div>
<div class="line chunk-replace" data-line="555"><span class="line-num">556</span><span class="line-content">    <span class="inline-diff">logge</span>r<span class="inline-diff">.</span>in<span class="inline-diff">fo</span>(<span class="inline-diff">f</span>&quot;<span class="inline-diff">Config upda</span>ted<span class="inline-diff">: {ke</span>y<span class="inline-diff">} = {value}</span>&quot;)</span></div>
<div class="line chunk-replace" data-line="556"><span class="line-num">557</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="557"><span class="line-num">558</span><span class="line-content"><span class="inline-diff">de</span>f <span class="inline-diff">lo</span>a<span class="inline-diff">d</span>_<span class="inline-diff">co</span>n<span class="inline-diff">fig</span>_<span class="inline-diff">from</span>_<span class="inline-diff">env()</span>:</span></div>
<div class="line chunk-replace" data-line="558"><span class="line-num">559</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;NEW: Lo</span>a<span class="inline-diff">d co</span>n<span class="inline-diff">figuration from environment variables&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="559"><span class="line-num">560</span><span class="line-content">    import os</span></div>
<div class="line chunk-replace" data-line="560"><span class="line-num">561</span><span class="line-content">    en<span class="inline-diff">v_prefix</span> <span class="inline-diff">= &quot;ECOMMERCE_&quot;</span></span></div>
<div class="line chunk-replace" data-line="561"><span class="line-num">562</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="562"><span class="line-num">563</span><span class="line-content">    for key in CONFIG.keys():</span></div>
<div class="line chunk-replace" data-line="563"><span class="line-num">564</span><span class="line-content">        env_var = f&quot;{env_prefix}{key.upper()}&quot;</span></div>
<div class="line chunk-replace" data-line="564"><span class="line-num">565</span><span class="line-content">        if env_var in os.environ:</span></div>
<div class="line chunk-replace" data-line="565"><span class="line-num">566</span><span class="line-content">            CONFIG[key] = os.environ[env_var]</span></div>
<div class="line chunk-replace" data-line="566"><span class="line-num">567</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="567"><span class="line-num">568</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-replace" data-line="568"><span class="line-num">569</span><span class="line-content"># SECTION 9: Enhanced Error Handling</span></div>
<div class="line chunk-replace" data-line="569"><span class="line-num">570</span><span class="line-content"># NEW: Custom exception hierarchy</span></div>
<div class="line chunk-replace" data-line="570"><span class="line-num">571</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-replace" data-line="571"><span class="line-num">572</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="572"><span class="line-num">573</span><span class="line-content">class EcommerceError(Exception):</span></div>
<div class="line chunk-replace" data-line="573"><span class="line-num">574</span><span class="line-content">    &quot;&quot;&quot;NEW: Base exception for all e-commerce errors&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="574"><span class="line-num">575</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="575"><span class="line-num">576</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="576"><span class="line-num">577</span><span class="line-content">class PaymentError(EcommerceError):</span></div>
<div class="line chunk-replace" data-line="577"><span class="line-num">578</span><span class="line-content">    &quot;&quot;&quot;Payment processing errors&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="578"><span class="line-num">579</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="579"><span class="line-num">580</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="580"><span class="line-num">581</span><span class="line-content">class InventoryError(EcommerceError):</span></div>
<div class="line chunk-replace" data-line="581"><span class="line-num">582</span><span class="line-content">    &quot;&quot;&quot;Inventory management errors&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="582"><span class="line-num">583</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="583"><span class="line-num">584</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="584"><span class="line-num">585</span><span class="line-content">class ValidationError(EcommerceError):</span></div>
<div class="line chunk-replace" data-line="585"><span class="line-num">586</span><span class="line-content">    &quot;&quot;&quot;NEW: Data validation errors&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="586"><span class="line-num">587</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="587"><span class="line-num">588</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="588"><span class="line-num">589</span><span class="line-content">class AuthenticationError(EcommerceError):</span></div>
<div class="line chunk-replace" data-line="589"><span class="line-num">590</span><span class="line-content">    &quot;&quot;&quot;NEW: Authentication errors&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="590"><span class="line-num">591</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="591"><span class="line-num">592</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="592"><span class="line-num">593</span><span class="line-content">def handle_error(error, log_trace=True):</span></div>
<div class="line chunk-replace" data-line="593"><span class="line-num">594</span><span class="line-content">    &quot;&quot;&quot;NEW: Centralized error handling with logging&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="594"><span class="line-num">595</span><span class="line-content">    if log_trace:</span></div>
<div class="line chunk-replace" data-line="595"><span class="line-num">596</span><span class="line-content">        logger.exception(f&quot;Error occurred: {error}&quot;)</span></div>
<div class="line chunk-replace" data-line="596"><span class="line-num">597</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="597"><span class="line-num">598</span><span class="line-content">    error_response = {</span></div>
<div class="line chunk-replace" data-line="598"><span class="line-num">599</span><span class="line-content">        &quot;error_type&quot;: type(error).__name__,</span></div>
<div class="line chunk-replace" data-line="599"><span class="line-num">600</span><span class="line-content">        &quot;message&quot;: str(error),</span></div>
<div class="line chunk-replace" data-line="600"><span class="line-num">601</span><span class="line-content">        &quot;timestamp&quot;: datetime.datetime.now().isoformat()</span></div>
<div class="line chunk-replace" data-line="601"><span class="line-num">602</span><span class="line-content">    }</span></div>
<div class="line chunk-replace" data-line="602"><span class="line-num">603</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="603"><span class="line-num">604</span><span class="line-content">    return error_response</span></div>
<div class="line chunk-replace" data-line="604"><span class="line-num">605</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="605"><span class="line-num">606</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-replace" data-line="606"><span class="line-num">607</span><span class="line-content"># SECTION 10: Application Bootstrap</span></div>
<div class="line chunk-replace" data-line="607"><span class="line-num">608</span><span class="line-content"># NEW: Enhanced initialization</span></div>
<div class="line chunk-replace" data-line="608"><span class="line-num">609</span><span class="line-content"># ============================================</span></div>
<div class="line chunk-replace" data-line="609"><span class="line-num">610</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="610"><span class="line-num">611</span><span class="line-content">def initialize_app(config_path=None):</span></div>
<div class="line chunk-replace" data-line="611"><span class="line-num">612</span><span class="line-content">    &quot;&quot;&quot;NEW: Initialize application with configuration&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="612"><span class="line-num">613</span><span class="line-content">    logger.info(&quot;Initializing E-commerce System v2.0&quot;)</span></div>
<div class="line chunk-replace" data-line="613"><span class="line-num">614</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="614"><span class="line-num">615</span><span class="line-content">    # Load configuration</span></div>
<div class="line chunk-replace" data-line="615"><span class="line-num">616</span><span class="line-content">    if config_path:</span></div>
<div class="line chunk-replace" data-line="616"><span class="line-num">617</span><span class="line-content">        logger.info(f&quot;Loading config from {config_path}&quot;)</span></div>
<div class="line chunk-replace" data-line="617"><span class="line-num">618</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="618"><span class="line-num">619</span><span class="line-content">    load_config_from_env()</span></div>
<div class="line chunk-replace" data-line="619"><span class="line-num">620</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="620"><span class="line-num">621</span><span class="line-content">    # Initialize services</span></div>
<div class="line chunk-replace" data-line="621"><span class="line-num">622</span><span class="line-content">    logger.info(&quot;Services initialized successfully&quot;)</span></div>
<div class="line chunk-replace" data-line="622"><span class="line-num">623</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="623"><span class="line-num">624</span><span class="line-content">    return True</span></div>
<div class="line " data-line="624"><span class="line-num">625</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="625"><span class="line-num">626</span><span class="line-content">def main():</span></div>
<div class="line chunk-replace" data-line="626"><span class="line-num">627</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;A</span>p<span class="inline-diff">plication ent</span>r<span class="inline-diff">y po</span>int&quot;&quot;<span class="inline-diff">&quot;</span></span></div>
<div class="line chunk-replace" data-line="627"><span class="line-num">628</span><span class="line-content">    <span class="inline-diff">pr</span>int<span class="inline-diff">(&quot;=&quot;</span> <span class="inline-diff">*</span> <span class="inline-diff">50)</span></span></div>
<div class="line chunk-replace" data-line="628"><span class="line-num">629</span><span class="line-content">    print(&quot;<span class="inline-diff">E-commerce </span>System <span class="inline-diff">v2.0</span>&quot;)</span></div>
<div class="line chunk-replace" data-line="629"><span class="line-num">630</span><span class="line-content">    print(&quot;Enhanced with modern features&quot;)</span></div>
<div class="line chunk-replace" data-line="630"><span class="line-num">631</span><span class="line-content">   <span class="inline-diff"> pr</span>in<span class="inline-diff">t(</span>&quot;<span class="inline-diff">=&quot; * 50)</span></span></div>
<div class="line chunk-replace" data-line="631"><span class="line-num">632</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="632"><span class="line-num">633</span><span class="line-content">    initialize_app()</span></div>
<div class="line chunk-replace" data-line="633"><span class="line-num">634</span><span class="line-content">    <span class="inline-diff">print(&quot;System</span> <span class="inline-diff">ready for op</span>er<span class="inline-diff">at</span>ion<span class="inline-diff">s&quot;)</span></span></div>
<div class="line " data-line="634"><span class="line-num">635</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="635"><span class="line-num">636</span><span class="line-content">if __name__ == &quot;__main__&quot;:</span></div>
<div class="line " data-line="636"><span class="line-num">637</span><span class="line-content">    main()</span></div>
<div class="line " data-line="637"><span class="line-num">638</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="638"><span class="line-num">639</span><span class="line-content"># END OF FILE - Version <span class="inline-diff">2</span>.0</span></div>
<div class="line chunk-replace" data-line="639"><span class="line-num">640</span><span class="line-content"># Total lines: ~<span class="inline-diff">450 (expanded from ~</span>300<span class="inline-diff">)</span></span></div>
        </div>
    </div>

    <div class="stats" id="stats">
        Chunks: 47 | Scroll to see connections
    </div>

    <script>
        // Chunk data from Python
        const chunks = [{"id": 0, "tag": "replace", "start_a": 0, "end_a": 5, "start_b": 0, "end_b": 4}, {"id": 1, "tag": "insert", "start_a": 9, "end_a": 9, "start_b": 8, "end_b": 9}, {"id": 2, "tag": "delete", "start_a": 11, "end_a": 13, "start_b": 11, "end_b": 11}, {"id": 3, "tag": "replace", "start_a": 15, "end_a": 16, "start_b": 13, "end_b": 14}, {"id": 4, "tag": "insert", "start_a": 20, "end_a": 20, "start_b": 18, "end_b": 19}, {"id": 5, "tag": "replace", "start_a": 21, "end_a": 22, "start_b": 20, "end_b": 21}, {"id": 6, "tag": "insert", "start_a": 24, "end_a": 24, "start_b": 23, "end_b": 25}, {"id": 7, "tag": "replace", "start_a": 28, "end_a": 30, "start_b": 29, "end_b": 33}, {"id": 8, "tag": "insert", "start_a": 33, "end_a": 33, "start_b": 36, "end_b": 38}, {"id": 9, "tag": "delete", "start_a": 35, "end_a": 36, "start_b": 40, "end_b": 40}, {"id": 10, "tag": "replace", "start_a": 40, "end_a": 42, "start_b": 44, "end_b": 52}, {"id": 11, "tag": "replace", "start_a": 43, "end_a": 45, "start_b": 53, "end_b": 57}, {"id": 12, "tag": "replace", "start_a": 48, "end_a": 50, "start_b": 60, "end_b": 61}, {"id": 13, "tag": "replace", "start_a": 52, "end_a": 54, "start_b": 63, "end_b": 71}, {"id": 14, "tag": "replace", "start_a": 58, "end_a": 60, "start_b": 75, "end_b": 78}, {"id": 15, "tag": "replace", "start_a": 61, "end_a": 62, "start_b": 79, "end_b": 80}, {"id": 16, "tag": "insert", "start_a": 64, "end_a": 64, "start_b": 82, "end_b": 92}, {"id": 17, "tag": "insert", "start_a": 66, "end_a": 66, "start_b": 94, "end_b": 95}, {"id": 18, "tag": "insert", "start_a": 69, "end_a": 69, "start_b": 98, "end_b": 99}, {"id": 19, "tag": "replace", "start_a": 71, "end_a": 72, "start_b": 101, "end_b": 102}, {"id": 20, "tag": "insert", "start_a": 75, "end_a": 75, "start_b": 105, "end_b": 109}, {"id": 21, "tag": "insert", "start_a": 82, "end_a": 82, "start_b": 116, "end_b": 118}, {"id": 22, "tag": "replace", "start_a": 88, "end_a": 89, "start_b": 124, "end_b": 134}, {"id": 23, "tag": "replace", "start_a": 91, "end_a": 92, "start_b": 136, "end_b": 137}, {"id": 24, "tag": "replace", "start_a": 94, "end_a": 95, "start_b": 139, "end_b": 142}, {"id": 25, "tag": "insert", "start_a": 97, "end_a": 97, "start_b": 144, "end_b": 146}, {"id": 26, "tag": "insert", "start_a": 101, "end_a": 101, "start_b": 150, "end_b": 153}, {"id": 27, "tag": "replace", "start_a": 106, "end_a": 127, "start_b": 158, "end_b": 206}, {"id": 28, "tag": "replace", "start_a": 129, "end_a": 146, "start_b": 208, "end_b": 259}, {"id": 29, "tag": "replace", "start_a": 149, "end_a": 150, "start_b": 262, "end_b": 264}, {"id": 30, "tag": "replace", "start_a": 151, "end_a": 152, "start_b": 265, "end_b": 267}, {"id": 31, "tag": "insert", "start_a": 154, "end_a": 154, "start_b": 269, "end_b": 272}, {"id": 32, "tag": "insert", "start_a": 159, "end_a": 159, "start_b": 277, "end_b": 279}, {"id": 33, "tag": "replace", "start_a": 160, "end_a": 176, "start_b": 280, "end_b": 319}, {"id": 34, "tag": "replace", "start_a": 179, "end_a": 181, "start_b": 322, "end_b": 324}, {"id": 35, "tag": "replace", "start_a": 182, "end_a": 184, "start_b": 325, "end_b": 338}, {"id": 36, "tag": "replace", "start_a": 186, "end_a": 190, "start_b": 340, "end_b": 351}, {"id": 37, "tag": "replace", "start_a": 192, "end_a": 214, "start_b": 353, "end_b": 405}, {"id": 38, "tag": "replace", "start_a": 215, "end_a": 216, "start_b": 406, "end_b": 411}, {"id": 39, "tag": "replace", "start_a": 218, "end_a": 232, "start_b": 413, "end_b": 447}, {"id": 40, "tag": "replace", "start_a": 234, "end_a": 236, "start_b": 449, "end_b": 451}, {"id": 41, "tag": "replace", "start_a": 237, "end_a": 238, "start_b": 452, "end_b": 454}, {"id": 42, "tag": "replace", "start_a": 239, "end_a": 240, "start_b": 455, "end_b": 461}, {"id": 43, "tag": "replace", "start_a": 242, "end_a": 261, "start_b": 463, "end_b": 623}, {"id": 44, "tag": "delete", "start_a": 263, "end_a": 331, "start_b": 625, "end_b": 625}, {"id": 45, "tag": "replace", "start_a": 332, "end_a": 335, "start_b": 626, "end_b": 634}, {"id": 46, "tag": "replace", "start_a": 339, "end_a": 341, "start_b": 638, "end_b": 640}];

        class DiffRenderer {
            constructor(leftPane, rightPane, svgElement, canvasElement) {
                this.leftPane = leftPane;
                this.rightPane = rightPane;
                this.svg = svgElement;
                this.canvas = canvasElement;
                this.chunks = chunks;
                this.useWebGL = true;
                this.hoveredChunkId = null;
                this.isScrollingProgrammatically = false;

                // Initialize WebGL
                this.initWebGL();

                // Throttle updates for better performance
                this.updatePending = false;
                this.updateLinkMapThrottled = this.throttle(() => this.updateLinkMap(), 16); // ~60fps

                // Setup scroll listeners - panes scroll independently, just update linkmap
                this.leftPane.addEventListener('scroll', () => {
                    if (!this.isScrollingProgrammatically) {
                        this.updateLinkMapThrottled();
                    }
                });
                this.rightPane.addEventListener('scroll', () => {
                    if (!this.isScrollingProgrammatically) {
                        this.updateLinkMapThrottled();
                    }
                });
                window.addEventListener('resize', () => this.updateLinkMapThrottled());

                // Setup ResizeObserver for more reliable updates
                if (typeof ResizeObserver !== 'undefined') {
                    const resizeObserver = new ResizeObserver(() => this.updateLinkMapThrottled());
                    resizeObserver.observe(this.leftPane);
                    resizeObserver.observe(this.rightPane);
                }

                // Canvas hover detection
                this.canvas.addEventListener('mousemove', (e) => this.handleCanvasHover(e));
                this.canvas.addEventListener('mouseleave', () => this.handleCanvasLeave());

                // Rendering mode toggle
                document.getElementById('use-webgl').addEventListener('change', (e) => {
                    this.useWebGL = e.target.checked;
                    this.svg.style.display = this.useWebGL ? 'none' : 'block';
                    this.canvas.style.display = this.useWebGL ? 'block' : 'none';
                    this.updateLinkMap();
                });


                // Initial render
                this.updateLinkMap();
                this.drawMarkers();
            }

            drawMarkers() {
                // Add CSS classes to lines to show insert/delete markers
                this.chunks.forEach((chunk) => {
                    if (chunk.tag === 'insert') {
                        // Insert in right means we need a marker in left pane
                        // Add border-bottom to the line BEFORE the insert position
                        const lineNum = chunk.start_a > 0 ? chunk.start_a - 1 : 0;
                        const lineElement = this.leftPane.querySelector(`[data-line="${lineNum}"]`);
                        if (lineElement) {
                            lineElement.classList.add('insert-marker-after');
                            lineElement.dataset.markerChunkId = chunk.id;
                        }
                    } else if (chunk.tag === 'delete') {
                        // Delete in left means we need a marker in right pane
                        const lineNum = chunk.start_b > 0 ? chunk.start_b - 1 : 0;
                        const lineElement = this.rightPane.querySelector(`[data-line="${lineNum}"]`);
                        if (lineElement) {
                            lineElement.classList.add('delete-marker-after');
                            lineElement.dataset.markerChunkId = chunk.id;
                        }
                    }
                });
            }


            throttle(func, wait) {
                let timeout;
                return function(...args) {
                    if (!timeout) {
                        timeout = setTimeout(() => {
                            timeout = null;
                            func.apply(this, args);
                        }, wait);
                    }
                };
            }

            initWebGL() {
                const gl = this.canvas.getContext('webgl', {
                    alpha: true,
                    antialias: true,
                    preserveDrawingBuffer: true
                });

                if (!gl) {
                    console.warn('WebGL not supported, falling back to SVG');
                    this.useWebGL = false;
                    document.getElementById('use-webgl').checked = false;
                    document.getElementById('use-webgl').disabled = true;
                    return;
                }

                this.gl = gl;

                // Vertex shader - simple pass-through with color
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    attribute vec4 a_color;
                    varying vec4 v_color;
                    uniform vec2 u_resolution;

                    void main() {
                        vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0;
                        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
                        v_color = a_color;
                    }
                `;

                // Fragment shader - simple color
                const fragmentShaderSource = `
                    precision mediump float;
                    varying vec4 v_color;

                    void main() {
                        gl_FragColor = v_color;
                    }
                `;

                // Compile shaders
                const vertexShader = this.compileShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
                const fragmentShader = this.compileShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);

                // Link program
                const program = gl.createProgram();
                gl.attachShader(program, vertexShader);
                gl.attachShader(program, fragmentShader);
                gl.linkProgram(program);

                if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                    console.error('Program link failed:', gl.getProgramInfoLog(program));
                    return;
                }

                this.program = program;
                this.positionLocation = gl.getAttribLocation(program, 'a_position');
                this.colorLocation = gl.getAttribLocation(program, 'a_color');
                this.resolutionLocation = gl.getUniformLocation(program, 'u_resolution');

                // Create buffers
                this.positionBuffer = gl.createBuffer();
                this.colorBuffer = gl.createBuffer();
            }

            compileShader(gl, type, source) {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);

                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    console.error('Shader compile failed:', gl.getShaderInfoLog(shader));
                    gl.deleteShader(shader);
                    return null;
                }

                return shader;
            }

            getLinePosition(pane, lineNum) {
                // Get line element
                const lineElement = pane.querySelector(`[data-line="${lineNum}"]`);
                if (!lineElement) return null;

                const paneRect = pane.getBoundingClientRect();
                const lineRect = lineElement.getBoundingClientRect();

                // Use canvas or SVG as reference depending on current mode
                const referenceRect = this.useWebGL ? this.canvas.getBoundingClientRect() : this.svg.getBoundingClientRect();

                // Position relative to reference element (SVG or Canvas)
                return lineRect.top - referenceRect.top + (lineRect.height / 2);
            }

            getVisibleLines(pane) {
                const rect = pane.getBoundingClientRect();
                const firstLine = pane.querySelector('.line');
                if (!firstLine) return { start: 0, end: 0 };

                const lineHeight = firstLine.offsetHeight;
                const scrollTop = pane.scrollTop;
                const paneHeight = pane.clientHeight;

                const startLine = Math.floor(scrollTop / lineHeight);
                const endLine = Math.ceil((scrollTop + paneHeight) / lineHeight);

                return { start: startLine, end: endLine };
            }

            isChunkVisible(chunk, leftVisible, rightVisible) {
                const leftOverlap = chunk.end_a >= leftVisible.start &&
                                    chunk.start_a <= leftVisible.end;
                const rightOverlap = chunk.end_b >= rightVisible.start &&
                                     chunk.start_b <= rightVisible.end;
                return leftOverlap || rightOverlap;
            }

            updateLinkMap() {
                if (this.useWebGL && this.gl) {
                    this.renderWebGL();
                } else {
                    this.renderSVG();
                }
            }

            renderSVG() {
                // Clear existing paths
                this.svg.innerHTML = '';

                const leftVisible = this.getVisibleLines(this.leftPane);
                const rightVisible = this.getVisibleLines(this.rightPane);

                const svgWidth = this.svg.clientWidth;
                const svgHeight = this.svg.clientHeight;

                // Set SVG viewBox
                this.svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);

                let renderedCount = 0;

                // Draw paths for each chunk
                this.chunks.forEach((chunk, index) => {
                    // Check if chunk is in visible range
                    if (!this.isChunkVisible(chunk, leftVisible, rightVisible)) {
                        return;
                    }

                    const path = this.createChunkPath(chunk, svgWidth);
                    if (path) {
                        // Add chunk ID as data attribute
                        path.setAttribute('data-chunk-id', chunk.id);

                        // Setup hover handlers
                        path.addEventListener('mouseenter', (e) => this.highlightChunk(chunk.id));
                        path.addEventListener('mouseleave', (e) => this.unhighlightChunk(chunk.id));

                        this.svg.appendChild(path);
                        renderedCount++;
                    }
                });

                // Update stats
                document.getElementById('stats').textContent =
                    `Chunks: ${this.chunks.length} | Rendered: ${renderedCount} | Mode: SVG`;
            }

            renderWebGL() {
                const gl = this.gl;
                if (!gl) return;

                const leftVisible = this.getVisibleLines(this.leftPane);
                const rightVisible = this.getVisibleLines(this.rightPane);

                const width = this.canvas.clientWidth;
                const height = this.canvas.clientHeight;

                // Set canvas size accounting for device pixel ratio
                const dpr = window.devicePixelRatio || 1;
                this.canvas.width = width * dpr;
                this.canvas.height = height * dpr;

                gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                gl.clear(gl.COLOR_BUFFER_BIT);

                // Enable blending for transparency
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

                // Use shader program
                gl.useProgram(this.program);
                gl.uniform2f(this.resolutionLocation, this.canvas.width, this.canvas.height);

                let positions = [];
                let colors = [];
                let renderedCount = 0;

                // Generate geometry for visible chunks
                this.visibleChunks = []; // Store for hover detection

                this.chunks.forEach((chunk) => {
                    if (!this.isChunkVisible(chunk, leftVisible, rightVisible)) {
                        return;
                    }

                    // Calculate line positions
                    // For insert/delete chunks, use the marker line position
                    let leftLineStart = chunk.start_a;
                    let leftLineEnd = Math.max(chunk.start_a, chunk.end_a - 1);
                    let rightLineStart = chunk.start_b;
                    let rightLineEnd = Math.max(chunk.start_b, chunk.end_b - 1);

                    // For insert chunks, the marker is on the line BEFORE start_a
                    if (chunk.tag === 'insert' && chunk.start_a > 0) {
                        leftLineStart = chunk.start_a - 1;
                        leftLineEnd = chunk.start_a - 1;
                    }
                    // For delete chunks, the marker is on the line BEFORE start_b
                    if (chunk.tag === 'delete' && chunk.start_b > 0) {
                        rightLineStart = chunk.start_b - 1;
                        rightLineEnd = chunk.start_b - 1;
                    }

                    const leftY0 = this.getLinePosition(this.leftPane, leftLineStart);
                    const leftY1 = this.getLinePosition(this.leftPane, leftLineEnd);
                    const rightY0 = this.getLinePosition(this.rightPane, rightLineStart);
                    const rightY1 = this.getLinePosition(this.rightPane, rightLineEnd);

                    if (leftY0 === null || rightY0 === null) return;

                    // Clamp positions to visible area (with small margin)
                    const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
                    const clampedLeftY0 = clamp(leftY0, -10, height + 10);
                    const clampedLeftY1 = clamp(leftY1 || leftY0, -10, height + 10);
                    const clampedRightY0 = clamp(rightY0, -10, height + 10);
                    const clampedRightY1 = clamp(rightY1 || rightY0, -10, height + 10);

                    let ly0 = clampedLeftY0 * dpr;
                    let ly1 = clampedLeftY1 * dpr;
                    let ry0 = clampedRightY0 * dpr;
                    let ry1 = clampedRightY1 * dpr;

                    // Ensure minimum height for visibility (especially single-line chunks)
                    const MIN_HEIGHT = 3 * dpr; // 3px minimum height
                    if (Math.abs(ly1 - ly0) < MIN_HEIGHT) {
                        // Expand left side slightly for visibility
                        ly0 -= MIN_HEIGHT / 2;
                        ly1 += MIN_HEIGHT / 2;
                    }
                    if (Math.abs(ry1 - ry0) < MIN_HEIGHT) {
                        // Expand right side slightly for visibility
                        ry0 -= MIN_HEIGHT / 2;
                        ry1 += MIN_HEIGHT / 2;
                    }

                    const x0 = 0;
                    const x1 = (width / 2) * dpr; // Middle control point
                    const x2 = width * dpr;

                    // Store chunk bounds for hover detection
                    this.visibleChunks.push({
                        id: chunk.id,
                        x0, x2, ly0, ly1, ry0, ry1,
                        tag: chunk.tag,
                        start_a: chunk.start_a,
                        end_a: chunk.end_a,
                        start_b: chunk.start_b,
                        end_b: chunk.end_b
                    });

                    // Get color
                    const color = this.getColorForTag(chunk.tag, chunk.id === this.hoveredChunkId);

                    // Generate bezier curve approximation using multiple segments
                    const segments = 20; // Number of segments for smooth curve

                    // Create the filled shape exactly like SVG does:
                    // Path: M x0,ly0 C x1,ly0 x1,ry0 x2,ry0 L x2,ry1 C x1,ry1 x1,ly1 x0,ly1 Z

                    // Generate points along the top curve (left to right)
                    const topPoints = [];
                    for (let i = 0; i <= segments; i++) {
                        const t = i / segments;
                        const t2 = t * t;
                        const t3 = t2 * t;
                        const mt = 1 - t;
                        const mt2 = mt * mt;
                        const mt3 = mt2 * mt;

                        // Cubic bezier: (x0,ly0) -> (x1,ly0) -> (x1,ry0) -> (x2,ry0)
                        const x = mt3 * x0 + 3 * mt2 * t * x1 + 3 * mt * t2 * x1 + t3 * x2;
                        const y = mt3 * ly0 + 3 * mt2 * t * ly0 + 3 * mt * t2 * ry0 + t3 * ry0;
                        topPoints.push(x, y);
                    }

                    // Generate points along the bottom curve (left to right, SAME direction as top)
                    // Then we'll traverse it backwards when creating triangles
                    const bottomPoints = [];
                    for (let i = 0; i <= segments; i++) {
                        const t = i / segments;
                        const t2 = t * t;
                        const t3 = t2 * t;
                        const mt = 1 - t;
                        const mt2 = mt * mt;
                        const mt3 = mt2 * mt;

                        // Cubic bezier: (x0,ly1) -> (x1,ly1) -> (x1,ry1) -> (x2,ry1)
                        const x = mt3 * x0 + 3 * mt2 * t * x1 + 3 * mt * t2 * x1 + t3 * x2;
                        const y = mt3 * ly1 + 3 * mt2 * t * ly1 + 3 * mt * t2 * ry1 + t3 * ry1;
                        bottomPoints.push(x, y);
                    }

                    // Create triangle strip between the two curves
                    // This creates a proper filled shape without twisting
                    for (let i = 0; i < segments; i++) {
                        const topX1 = topPoints[i * 2];
                        const topY1 = topPoints[i * 2 + 1];
                        const topX2 = topPoints[(i + 1) * 2];
                        const topY2 = topPoints[(i + 1) * 2 + 1];

                        const bottomX1 = bottomPoints[i * 2];
                        const bottomY1 = bottomPoints[i * 2 + 1];
                        const bottomX2 = bottomPoints[(i + 1) * 2];
                        const bottomY2 = bottomPoints[(i + 1) * 2 + 1];

                        // First triangle
                        positions.push(
                            topX1, topY1,
                            bottomX1, bottomY1,
                            topX2, topY2
                        );
                        for (let j = 0; j < 3; j++) colors.push(...color);

                        // Second triangle
                        positions.push(
                            topX2, topY2,
                            bottomX1, bottomY1,
                            bottomX2, bottomY2
                        );
                        for (let j = 0; j < 3; j++) colors.push(...color);
                    }

                    renderedCount++;
                });

                if (positions.length > 0) {
                    // Upload position data
                    gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);
                    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);
                    gl.enableVertexAttribArray(this.positionLocation);
                    gl.vertexAttribPointer(this.positionLocation, 2, gl.FLOAT, false, 0, 0);

                    // Upload color data
                    gl.bindBuffer(gl.ARRAY_BUFFER, this.colorBuffer);
                    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);
                    gl.enableVertexAttribArray(this.colorLocation);
                    gl.vertexAttribPointer(this.colorLocation, 4, gl.FLOAT, false, 0, 0);

                    // Draw
                    gl.drawArrays(gl.TRIANGLES, 0, positions.length / 2);
                }

                // Update stats
                document.getElementById('stats').textContent =
                    `Chunks: ${this.chunks.length} | Rendered: ${renderedCount} | Mode: WebGL`;
            }


            getColorForTag(tag, isHovered) {
                const alpha = isHovered ? 0.6 : 0.3;
                const colors = {
                    'insert': [0.55, 0.78, 0.55, alpha],
                    'delete': [0.94, 0.55, 0.55, alpha],
                    'replace': [0.55, 0.71, 0.94, alpha]
                };
                return colors[tag] || colors['replace'];
            }

            handleCanvasHover(e) {
                if (!this.useWebGL) return;

                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check which chunk was hovered
                let foundChunk = null;
                for (const chunk of this.visibleChunks || []) {
                    // Simple bounding box check
                    const minY = Math.min(chunk.ly0, chunk.ry0);
                    const maxY = Math.max(chunk.ly1, chunk.ry1);

                    if (y >= minY && y <= maxY) {
                        foundChunk = chunk;
                        break;
                    }
                }

                const newHoveredId = foundChunk ? foundChunk.id : null;

                if (newHoveredId !== this.hoveredChunkId) {
                    if (this.hoveredChunkId !== null) {
                        this.unhighlightChunk(this.hoveredChunkId);
                    }

                    this.hoveredChunkId = newHoveredId;

                    if (this.hoveredChunkId !== null) {
                        this.highlightChunk(this.hoveredChunkId);
                        this.canvas.style.cursor = 'pointer';
                    } else {
                        this.canvas.style.cursor = 'default';
                    }

                    this.renderWebGL(); // Re-render to show hover effect
                }
            }

            handleCanvasLeave() {
                if (this.hoveredChunkId !== null) {
                    this.unhighlightChunk(this.hoveredChunkId);
                    this.hoveredChunkId = null;
                    this.canvas.style.cursor = 'default';
                    this.renderWebGL();
                }
            }

            createChunkPath(chunk, svgWidth) {
                // Calculate Y positions
                // For insert/delete chunks, use the marker line position
                let leftLineStart = chunk.start_a;
                let leftLineEnd = Math.max(chunk.start_a, chunk.end_a - 1);
                let rightLineStart = chunk.start_b;
                let rightLineEnd = Math.max(chunk.start_b, chunk.end_b - 1);

                // For insert chunks, the marker is on the line BEFORE start_a
                if (chunk.tag === 'insert' && chunk.start_a > 0) {
                    leftLineStart = chunk.start_a - 1;
                    leftLineEnd = chunk.start_a - 1;
                }
                // For delete chunks, the marker is on the line BEFORE start_b
                if (chunk.tag === 'delete' && chunk.start_b > 0) {
                    rightLineStart = chunk.start_b - 1;
                    rightLineEnd = chunk.start_b - 1;
                }

                const leftY0 = this.getLinePosition(this.leftPane, leftLineStart);
                const leftY1 = this.getLinePosition(this.leftPane, leftLineEnd);
                const rightY0 = this.getLinePosition(this.rightPane, rightLineStart);
                const rightY1 = this.getLinePosition(this.rightPane, rightLineEnd);

                // Skip if positions couldn't be calculated
                if (leftY0 === null || rightY0 === null) return null;

                const x0 = 0;
                const x1 = svgWidth / 2;
                const x2 = svgWidth;

                // Create bezier curve path (similar to Meld's implementation)
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

                // Handle insert/delete cases where one side has no height
                let ly0 = leftY0 || 0;
                let ly1 = leftY1 || leftY0 || 0;
                let ry0 = rightY0 || 0;
                let ry1 = rightY1 || rightY0 || 0;

                // Pixel-perfect positioning: use -0.5 offsets for crisp rendering
                ly0 -= 0.5;
                ly1 = (ly1 === ly0 + 0.5) ? ly1 : ly1 - 1.5;
                ry0 -= 0.5;
                ry1 = (ry1 === ry0 + 0.5) ? ry1 : ry1 - 1.5;

                const svgHeight = this.svg.clientHeight;
                const RADIUS = 3;

                // Clamp positions to visible area for off-screen chunks
                // This ensures curves to off-screen lines still show a visible connection
                const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
                ly0 = clamp(ly0, -10, svgHeight + 10);
                ly1 = clamp(ly1, -10, svgHeight + 10);
                ry0 = clamp(ry0, -10, svgHeight + 10);
                ry1 = clamp(ry1, -10, svgHeight + 10);

                // Rounded rectangle culling for off-screen chunks (like Meld)
                let pathData;

                // If right side is completely off-screen (top or bottom)
                if ((ry0 < 0 && ry1 < 0) || (ry0 > svgHeight && ry1 > svgHeight)) {
                    if (ly0 === ly1) return null; // Skip if no height

                    // Draw rounded rectangle on left side only
                    pathData = `
                        M ${x0},${ly0 + RADIUS}
                        A ${RADIUS},${RADIUS} 0 0 1 ${x0 + RADIUS},${ly0}
                        L ${x0 + RADIUS},${ly0}
                        A ${RADIUS},${RADIUS} 0 0 1 ${x0},${ly0 + RADIUS}
                        L ${x0},${ly1 - RADIUS}
                        A ${RADIUS},${RADIUS} 0 0 1 ${x0 + RADIUS},${ly1}
                        L ${x0 + RADIUS},${ly1}
                        A ${RADIUS},${RADIUS} 0 0 1 ${x0},${ly1 - RADIUS}
                        Z
                    `.trim().replace(/\s+/g, ' ');
                }
                // If left side is completely off-screen (top or bottom)
                else if ((ly0 < 0 && ly1 < 0) || (ly0 > svgHeight && ly1 > svgHeight)) {
                    if (ry0 === ry1) return null; // Skip if no height

                    // Draw rounded rectangle on right side only
                    pathData = `
                        M ${x2},${ry0 + RADIUS}
                        A ${RADIUS},${RADIUS} 0 0 0 ${x2 - RADIUS},${ry0}
                        L ${x2 - RADIUS},${ry0}
                        A ${RADIUS},${RADIUS} 0 0 0 ${x2},${ry0 + RADIUS}
                        L ${x2},${ry1 - RADIUS}
                        A ${RADIUS},${RADIUS} 0 0 0 ${x2 - RADIUS},${ry1}
                        L ${x2 - RADIUS},${ry1}
                        A ${RADIUS},${RADIUS} 0 0 0 ${x2},${ry1 - RADIUS}
                        Z
                    `.trim().replace(/\s+/g, ' ');
                }
                // Normal case: both sides visible
                else {
                    pathData = `
                        M ${x0},${ly0}
                        C ${x1},${ly0} ${x1},${ry0} ${x2},${ry0}
                        L ${x2},${ry1}
                        C ${x1},${ry1} ${x1},${ly1} ${x0},${ly1}
                        Z
                    `.trim().replace(/\s+/g, ' ');
                }

                path.setAttribute('d', pathData);

                const color = this.getChunkColor(chunk.tag);
                path.setAttribute('fill', color.fill);
                path.setAttribute('stroke', color.stroke);
                path.setAttribute('stroke-width', '1');

                return path;
            }

            getChunkColor(tag) {
                const colors = {
                    'insert': {
                        fill: 'rgba(140, 200, 140, 0.3)',
                        stroke: 'rgba(140, 200, 140, 1)'
                    },
                    'delete': {
                        fill: 'rgba(240, 140, 140, 0.3)',
                        stroke: 'rgba(240, 140, 140, 1)'
                    },
                    'replace': {
                        fill: 'rgba(140, 180, 240, 0.3)',
                        stroke: 'rgba(140, 180, 240, 1)'
                    }
                };
                return colors[tag] || colors['replace'];
            }

            highlightChunk(chunkId) {
                const chunk = this.chunks[chunkId];
                if (!chunk) return;

                // Highlight the SVG path
                const path = this.svg.querySelector(`[data-chunk-id="${chunkId}"]`);
                if (path) {
                    path.classList.add('highlighted');
                }

                // Highlight lines in left pane
                for (let i = chunk.start_a; i < chunk.end_a; i++) {
                    const line = this.leftPane.querySelector(`[data-line="${i}"]`);
                    if (line) line.classList.add('chunk-highlight');
                }

                // Highlight lines in right pane
                for (let i = chunk.start_b; i < chunk.end_b; i++) {
                    const line = this.rightPane.querySelector(`[data-line="${i}"]`);
                    if (line) line.classList.add('chunk-highlight');
                }
            }

            unhighlightChunk(chunkId) {
                const chunk = this.chunks[chunkId];
                if (!chunk) return;

                // Remove highlight from SVG path
                const path = this.svg.querySelector(`[data-chunk-id="${chunkId}"]`);
                if (path) {
                    path.classList.remove('highlighted');
                }

                // Remove highlight from left pane lines
                for (let i = chunk.start_a; i < chunk.end_a; i++) {
                    const line = this.leftPane.querySelector(`[data-line="${i}"]`);
                    if (line) line.classList.remove('chunk-highlight');
                }

                // Remove highlight from right pane lines
                for (let i = chunk.start_b; i < chunk.end_b; i++) {
                    const line = this.rightPane.querySelector(`[data-line="${i}"]`);
                    if (line) line.classList.remove('chunk-highlight');
                }
            }
        }

        // Initialize the diff renderer
        const leftPane = document.getElementById('left-pane');
        const rightPane = document.getElementById('right-pane');
        const linkmap = document.getElementById('linkmap');
        const linkmapCanvas = document.getElementById('linkmap-canvas');

        const renderer = new DiffRenderer(leftPane, rightPane, linkmap, linkmapCanvas);

        // Log initialization
        console.log('Diff renderer initialized with', chunks.length, 'chunks');
    </script>
</body>
</html>