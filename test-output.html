<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meld Web Port - Diff Viewer</title>
    <style>
        :root {
            --line-height: 20px;
            --font-size: 13px;
            --font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size);
            overflow: hidden;
            background: #2e2e2e;
        }

        .header {
            background: #1e1e1e;
            color: #fff;
            padding: 10px 20px;
            border-bottom: 2px solid #0d7377;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: normal;
            margin: 0;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .controls label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            cursor: pointer;
        }

        .controls input[type="checkbox"] {
            cursor: pointer;
        }

        .diff-container {
            display: grid;
            grid-template-columns: 1fr 100px 1fr;
            height: calc(100vh - 50px);
            overflow: hidden;
        }

        .file-pane {
            overflow-y: auto;
            overflow-x: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: var(--font-family);
            font-size: var(--font-size);
            position: relative;
            scroll-behavior: auto; /* Override to allow manual smooth scrolling */
        }

        .file-pane .line {
            display: flex;
            line-height: var(--line-height);
            height: var(--line-height);
            white-space: pre;
        }

        .file-pane .line:hover {
            background: #2a2a2a;
        }

        .file-pane .line-num {
            display: inline-block;
            width: 50px;
            padding: 0 8px;
            text-align: right;
            color: #858585;
            user-select: none;
            flex-shrink: 0;
            border-right: 1px solid #3e3e3e;
        }

        .file-pane .line-content {
            padding: 0 8px;
            flex: 1;
        }

        /* Inline character-level diff highlighting */
        .inline-diff {
            background: rgba(255, 200, 100, 0.4);
            border-radius: 2px;
            padding: 0 1px;
        }

        /* Insert/delete markers using border-bottom on lines */
        .line.insert-marker-after {
            border-bottom: 1px solid rgba(140, 200, 140, 0.9);
            box-shadow: 0 1px 2px rgba(140, 200, 140, 0.5);
        }

        .line.delete-marker-after {
            border-bottom: 1px solid rgba(240, 140, 140, 0.9);
            box-shadow: 0 1px 2px rgba(240, 140, 140, 0.5);
        }

        /* Chunk highlighting */
        .chunk-insert {
            background: rgba(140, 200, 140, 0.2);
        }

        .chunk-delete {
            background: rgba(240, 140, 140, 0.2);
        }

        .chunk-replace {
            background: rgba(140, 180, 240, 0.2);
        }

        /* Hover and highlight states */
        .chunk-highlight {
            background: rgba(255, 255, 100, 0.3) !important;
        }

        .link-map {
            width: 100%;
            height: 100%;
            background: #2e2e2e;
            border-left: 1px solid #3e3e3e;
            border-right: 1px solid #3e3e3e;
        }

        .link-map path {
            cursor: pointer;
            transition: fill 0.15s ease, stroke 0.15s ease;
        }

        .link-map path:hover {
            fill-opacity: 0.6;
            stroke-width: 2;
        }

        .link-map path.highlighted {
            fill-opacity: 0.7;
            stroke-width: 2;
            filter: brightness(1.3);
        }

        .stats {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Meld Web Port - Diff Viewer (Proof of Concept)</h1>
        <div class="controls">
            <label>
                <input type="checkbox" id="use-webgl" checked>
                Use WebGL Rendering (faster for large diffs)
            </label>
        </div>
    </div>

    <div class="diff-container">
        <div class="file-pane" id="left-pane">
<div class="line chunk-replace" data-line="0"><span class="line-num">1</span><span class="line-content"># E-commerce System - Version <span class="inline-diff">1</span>.0</span></div>
<div class="line chunk-replace" data-line="1"><span class="line-num">2</span><span class="line-content"># <span class="inline-diff">B</span>a<span class="inline-diff">si</span>c implementation o<span class="inline-diff">f </span>s<span class="inline-diff">hopping cart</span> and <span class="inline-diff">ord</span>er <span class="inline-diff">pr</span>o<span class="inline-diff">cessi</span>n<span class="inline-diff">g</span></span></div>
<div class="line " data-line="2"><span class="line-num">3</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="3"><span class="line-num">4</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="4"><span class="line-num">5</span><span class="line-content">import logging</span></div>
<div class="line " data-line="5"><span class="line-num">6</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line " data-line="6"><span class="line-num">7</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="7"><span class="line-num">8</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="8"><span class="line-num">9</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="9"><span class="line-num">10</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="10"><span class="line-num">11</span><span class="line-content">    def __init__(self, id, name, price, category):</span></div>
<div class="line " data-line="11"><span class="line-num">12</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="12"><span class="line-num">13</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="13"><span class="line-num">14</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="14"><span class="line-num">15</span><span class="line-content">        self.category = category</span></div>
<div class="line " data-line="15"><span class="line-num">16</span><span class="line-content">        self.stock = 0</span></div>
<div class="line " data-line="16"><span class="line-num">17</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="17"><span class="line-num">18</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line " data-line="18"><span class="line-num">19</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="19"><span class="line-num">20</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="20"><span class="line-num">21</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="21"><span class="line-num">22</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="22"><span class="line-num">23</span><span class="line-content">        return f&quot;{self.name} - ${self.price}&quot;</span></div>
<div class="line " data-line="23"><span class="line-num">24</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="24"><span class="line-num">25</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="25"><span class="line-num">26</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line " data-line="26"><span class="line-num">27</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="27"><span class="line-num">28</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="28"><span class="line-num">29</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="29"><span class="line-num">30</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="30"><span class="line-num">31</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="31"><span class="line-num">32</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="32"><span class="line-num">33</span><span class="line-content">def <span class="inline-diff">calc</span>u<span class="inline-diff">l</span>ate_t<span class="inline-diff">otal(</span>ite<span class="inline-diff">ms</span>):</span></div>
<div class="line chunk-replace" data-line="33"><span class="line-num">34</span><span class="line-content">    t<span class="inline-diff">o</span>t<span class="inline-diff">al</span> = <span class="inline-diff">Decimal(&#x27;</span>0<span class="inline-diff">&#x27;)</span></span></div>
<div class="line " data-line="34"><span class="line-num">35</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="35"><span class="line-num">36</span><span class="line-content">        total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="36"><span class="line-num">37</span><span class="line-content">    return total</span></div>
<div class="line " data-line="37"><span class="line-num">38</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="38"><span class="line-num">39</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="39"><span class="line-num">40</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="40"><span class="line-num">41</span><span class="line-content">    total = calculate_total(items)</span></div>
<div class="line " data-line="41"><span class="line-num">42</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="42"><span class="line-num">43</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="43"><span class="line-num">44</span><span class="line-content">        discount<span class="inline-diff"> = </span>total<span class="inline-diff"> *</span> Decimal(&#x27;0.1&#x27;)</span></div>
<div class="line chunk-replace" data-line="44"><span class="line-num">45</span><span class="line-content">        total = total - discount</span></div>
<div class="line chunk-replace" data-line="45"><span class="line-num">46</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="46"><span class="line-num">47</span><span class="line-content">    return total</span></div>
<div class="line " data-line="47"><span class="line-num">48</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="48"><span class="line-num">49</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="49"><span class="line-num">50</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="50"><span class="line-num">51</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="51"><span class="line-num">52</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line " data-line="52"><span class="line-num">53</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="53"><span class="line-num">54</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line " data-line="54"><span class="line-num">55</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="55"><span class="line-num">56</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line " data-line="56"><span class="line-num">57</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="57"><span class="line-num">58</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="58"><span class="line-num">59</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line " data-line="59"><span class="line-num">60</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="60"><span class="line-num">61</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="61"><span class="line-num">62</span><span class="line-content">        return calculate_total(self.items)</span></div>
<div class="line " data-line="62"><span class="line-num">63</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="63"><span class="line-num">64</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="64"><span class="line-num">65</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="65"><span class="line-num">66</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="66"><span class="line-num">67</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="67"><span class="line-num">68</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="68"><span class="line-num">69</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="69"><span class="line-num">70</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="70"><span class="line-num">71</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="71"><span class="line-num">72</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line " data-line="72"><span class="line-num">73</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="73"><span class="line-num">74</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="74"><span class="line-num">75</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="75"><span class="line-num">76</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="76"><span class="line-num">77</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="77"><span class="line-num">78</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="78"><span class="line-num">79</span><span class="line-content">        <span class="inline-diff">logger.info(f&quot;Order confirmed for {</span>self.cu<span class="inline-diff">sto</span>mer<span class="inline-diff">}&quot;</span>)</span></div>
<div class="line " data-line="79"><span class="line-num">80</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="80"><span class="line-num">81</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="81"><span class="line-num">82</span><span class="line-content">    def __init__(self, name, email):</span></div>
<div class="line " data-line="82"><span class="line-num">83</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="83"><span class="line-num">84</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="84"><span class="line-num">85</span><span class="line-content">        self.o<span class="inline-diff">rd</span>e<span class="inline-diff">rs</span> = <span class="inline-diff">[]</span></span></div>
<div class="line " data-line="85"><span class="line-num">86</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="86"><span class="line-num">87</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line " data-line="87"><span class="line-num">88</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="88"><span class="line-num">89</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="89"><span class="line-num">90</span><span class="line-content">        return order</span></div>
<div class="line " data-line="90"><span class="line-num">91</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="91"><span class="line-num">92</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="92"><span class="line-num">93</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="93"><span class="line-num">94</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="94"><span class="line-num">95</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="95"><span class="line-num">96</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="96"><span class="line-num">97</span><span class="line-content">    <span class="inline-diff">re</span>t<span class="inline-diff">urn &quot;@&quot; in</span> email<span class="inline-diff"> and &quot;.&quot; in email</span></span></div>
<div class="line chunk-replace" data-line="97"><span class="line-num">98</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="98"><span class="line-num">99</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">E-comm</span>er<span class="inline-diff">ce</span> <span class="inline-diff">Syst</span>em <span class="inline-diff">-</span> <span class="inline-diff">Vers</span>i<span class="inline-diff">o</span>n <span class="inline-diff">1.0</span></span></div>
<div class="line chunk-replace" data-line="99"><span class="line-num">100</span><span class="line-content"># Basic implementation of shopping cart and order processing</span></div>
<div class="line " data-line="100"><span class="line-num">101</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="101"><span class="line-num">102</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="102"><span class="line-num">103</span><span class="line-content">import logging</span></div>
<div class="line " data-line="103"><span class="line-num">104</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line " data-line="104"><span class="line-num">105</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="105"><span class="line-num">106</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="106"><span class="line-num">107</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="107"><span class="line-num">108</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="108"><span class="line-num">109</span><span class="line-content">    def __init__(self, id, name, price, category):</span></div>
<div class="line " data-line="109"><span class="line-num">110</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="110"><span class="line-num">111</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="111"><span class="line-num">112</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="112"><span class="line-num">113</span><span class="line-content">        self.category = category</span></div>
<div class="line " data-line="113"><span class="line-num">114</span><span class="line-content">        self.stock = 0</span></div>
<div class="line " data-line="114"><span class="line-num">115</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="115"><span class="line-num">116</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line " data-line="116"><span class="line-num">117</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="117"><span class="line-num">118</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="118"><span class="line-num">119</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="119"><span class="line-num">120</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="120"><span class="line-num">121</span><span class="line-content">        return f&quot;{self.name} - ${self.price}&quot;</span></div>
<div class="line " data-line="121"><span class="line-num">122</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="122"><span class="line-num">123</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="123"><span class="line-num">124</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line " data-line="124"><span class="line-num">125</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="125"><span class="line-num">126</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="126"><span class="line-num">127</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="127"><span class="line-num">128</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="128"><span class="line-num">129</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="129"><span class="line-num">130</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="130"><span class="line-num">131</span><span class="line-content">def <span class="inline-diff">calc</span>u<span class="inline-diff">l</span>ate_t<span class="inline-diff">otal(</span>ite<span class="inline-diff">ms</span>):</span></div>
<div class="line chunk-replace" data-line="131"><span class="line-num">132</span><span class="line-content">    t<span class="inline-diff">o</span>t<span class="inline-diff">al</span> = <span class="inline-diff">Decimal(&#x27;</span>0<span class="inline-diff">&#x27;)</span></span></div>
<div class="line " data-line="132"><span class="line-num">133</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="133"><span class="line-num">134</span><span class="line-content">        total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="134"><span class="line-num">135</span><span class="line-content">    return total</span></div>
<div class="line " data-line="135"><span class="line-num">136</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="136"><span class="line-num">137</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="137"><span class="line-num">138</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="138"><span class="line-num">139</span><span class="line-content">    total = calculate_total(items)</span></div>
<div class="line " data-line="139"><span class="line-num">140</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="140"><span class="line-num">141</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="141"><span class="line-num">142</span><span class="line-content">        discount<span class="inline-diff"> = </span>total<span class="inline-diff"> *</span> Decimal(&#x27;0.1&#x27;)</span></div>
<div class="line chunk-replace" data-line="142"><span class="line-num">143</span><span class="line-content">        total = total - discount</span></div>
<div class="line chunk-replace" data-line="143"><span class="line-num">144</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="144"><span class="line-num">145</span><span class="line-content">    return total</span></div>
<div class="line " data-line="145"><span class="line-num">146</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="146"><span class="line-num">147</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="147"><span class="line-num">148</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="148"><span class="line-num">149</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="149"><span class="line-num">150</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line " data-line="150"><span class="line-num">151</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="151"><span class="line-num">152</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line " data-line="152"><span class="line-num">153</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="153"><span class="line-num">154</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line " data-line="154"><span class="line-num">155</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="155"><span class="line-num">156</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="156"><span class="line-num">157</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line " data-line="157"><span class="line-num">158</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="158"><span class="line-num">159</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="159"><span class="line-num">160</span><span class="line-content">        return calculate_total(self.items)</span></div>
<div class="line " data-line="160"><span class="line-num">161</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="161"><span class="line-num">162</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="162"><span class="line-num">163</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="163"><span class="line-num">164</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="164"><span class="line-num">165</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="165"><span class="line-num">166</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="166"><span class="line-num">167</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="167"><span class="line-num">168</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="168"><span class="line-num">169</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="169"><span class="line-num">170</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line " data-line="170"><span class="line-num">171</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="171"><span class="line-num">172</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="172"><span class="line-num">173</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="173"><span class="line-num">174</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="174"><span class="line-num">175</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="175"><span class="line-num">176</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="176"><span class="line-num">177</span><span class="line-content">        <span class="inline-diff">logger.info(f&quot;Order confirmed for {</span>self.cu<span class="inline-diff">sto</span>mer<span class="inline-diff">}&quot;</span>)</span></div>
<div class="line " data-line="177"><span class="line-num">178</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="178"><span class="line-num">179</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="179"><span class="line-num">180</span><span class="line-content">    def __init__(self, name, email):</span></div>
<div class="line " data-line="180"><span class="line-num">181</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="181"><span class="line-num">182</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="182"><span class="line-num">183</span><span class="line-content">        self.o<span class="inline-diff">rd</span>e<span class="inline-diff">rs</span> = <span class="inline-diff">[]</span></span></div>
<div class="line " data-line="183"><span class="line-num">184</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="184"><span class="line-num">185</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line " data-line="185"><span class="line-num">186</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="186"><span class="line-num">187</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="187"><span class="line-num">188</span><span class="line-content">        return order</span></div>
<div class="line " data-line="188"><span class="line-num">189</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="189"><span class="line-num">190</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="190"><span class="line-num">191</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="191"><span class="line-num">192</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="192"><span class="line-num">193</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="193"><span class="line-num">194</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="194"><span class="line-num">195</span><span class="line-content">    <span class="inline-diff">re</span>t<span class="inline-diff">urn &quot;@&quot; in</span> email<span class="inline-diff"> and &quot;.&quot; in email</span></span></div>
<div class="line chunk-replace" data-line="195"><span class="line-num">196</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="196"><span class="line-num">197</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">E-comm</span>er<span class="inline-diff">ce</span> <span class="inline-diff">Syst</span>em <span class="inline-diff">-</span> <span class="inline-diff">Vers</span>i<span class="inline-diff">o</span>n <span class="inline-diff">1.0</span></span></div>
<div class="line chunk-replace" data-line="197"><span class="line-num">198</span><span class="line-content"># Basic implementation of shopping cart and order processing</span></div>
<div class="line " data-line="198"><span class="line-num">199</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="199"><span class="line-num">200</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="200"><span class="line-num">201</span><span class="line-content">import logging</span></div>
<div class="line " data-line="201"><span class="line-num">202</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line " data-line="202"><span class="line-num">203</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="203"><span class="line-num">204</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="204"><span class="line-num">205</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="205"><span class="line-num">206</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="206"><span class="line-num">207</span><span class="line-content">    def __init__(self, id, name, price, category):</span></div>
<div class="line " data-line="207"><span class="line-num">208</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="208"><span class="line-num">209</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="209"><span class="line-num">210</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="210"><span class="line-num">211</span><span class="line-content">        self.category = category</span></div>
<div class="line " data-line="211"><span class="line-num">212</span><span class="line-content">        self.stock = 0</span></div>
<div class="line " data-line="212"><span class="line-num">213</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="213"><span class="line-num">214</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line " data-line="214"><span class="line-num">215</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="215"><span class="line-num">216</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="216"><span class="line-num">217</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="217"><span class="line-num">218</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="218"><span class="line-num">219</span><span class="line-content">        return f&quot;{self.name} - ${self.price}&quot;</span></div>
<div class="line " data-line="219"><span class="line-num">220</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="220"><span class="line-num">221</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="221"><span class="line-num">222</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line " data-line="222"><span class="line-num">223</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="223"><span class="line-num">224</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="224"><span class="line-num">225</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="225"><span class="line-num">226</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="226"><span class="line-num">227</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="227"><span class="line-num">228</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="228"><span class="line-num">229</span><span class="line-content">def <span class="inline-diff">calc</span>u<span class="inline-diff">l</span>ate_t<span class="inline-diff">otal(</span>ite<span class="inline-diff">ms</span>):</span></div>
<div class="line chunk-replace" data-line="229"><span class="line-num">230</span><span class="line-content">    t<span class="inline-diff">o</span>t<span class="inline-diff">al</span> = <span class="inline-diff">Decimal(&#x27;</span>0<span class="inline-diff">&#x27;)</span></span></div>
<div class="line " data-line="230"><span class="line-num">231</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="231"><span class="line-num">232</span><span class="line-content">        total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="232"><span class="line-num">233</span><span class="line-content">    return total</span></div>
<div class="line " data-line="233"><span class="line-num">234</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="234"><span class="line-num">235</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="235"><span class="line-num">236</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="236"><span class="line-num">237</span><span class="line-content">    total = calculate_total(items)</span></div>
<div class="line " data-line="237"><span class="line-num">238</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="238"><span class="line-num">239</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="239"><span class="line-num">240</span><span class="line-content">        discount<span class="inline-diff"> = </span>total<span class="inline-diff"> *</span> Decimal(&#x27;0.1&#x27;)</span></div>
<div class="line chunk-replace" data-line="240"><span class="line-num">241</span><span class="line-content">        total = total - discount</span></div>
<div class="line chunk-replace" data-line="241"><span class="line-num">242</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="242"><span class="line-num">243</span><span class="line-content">    return total</span></div>
<div class="line " data-line="243"><span class="line-num">244</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="244"><span class="line-num">245</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="245"><span class="line-num">246</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="246"><span class="line-num">247</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="247"><span class="line-num">248</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line " data-line="248"><span class="line-num">249</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="249"><span class="line-num">250</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line " data-line="250"><span class="line-num">251</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="251"><span class="line-num">252</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line " data-line="252"><span class="line-num">253</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="253"><span class="line-num">254</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="254"><span class="line-num">255</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line " data-line="255"><span class="line-num">256</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="256"><span class="line-num">257</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="257"><span class="line-num">258</span><span class="line-content">        return calculate_total(self.items)</span></div>
<div class="line " data-line="258"><span class="line-num">259</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="259"><span class="line-num">260</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="260"><span class="line-num">261</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="261"><span class="line-num">262</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="262"><span class="line-num">263</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="263"><span class="line-num">264</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="264"><span class="line-num">265</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="265"><span class="line-num">266</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="266"><span class="line-num">267</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="267"><span class="line-num">268</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line " data-line="268"><span class="line-num">269</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="269"><span class="line-num">270</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="270"><span class="line-num">271</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="271"><span class="line-num">272</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="272"><span class="line-num">273</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="273"><span class="line-num">274</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="274"><span class="line-num">275</span><span class="line-content">        <span class="inline-diff">logger.info(f&quot;Order confirmed for {</span>self.cu<span class="inline-diff">sto</span>mer<span class="inline-diff">}&quot;</span>)</span></div>
<div class="line " data-line="275"><span class="line-num">276</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="276"><span class="line-num">277</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="277"><span class="line-num">278</span><span class="line-content">    def __init__(self, name, email):</span></div>
<div class="line " data-line="278"><span class="line-num">279</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="279"><span class="line-num">280</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="280"><span class="line-num">281</span><span class="line-content">        self.o<span class="inline-diff">rd</span>e<span class="inline-diff">rs</span> = <span class="inline-diff">[]</span></span></div>
<div class="line " data-line="281"><span class="line-num">282</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="282"><span class="line-num">283</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line " data-line="283"><span class="line-num">284</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="284"><span class="line-num">285</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="285"><span class="line-num">286</span><span class="line-content">        return order</span></div>
<div class="line " data-line="286"><span class="line-num">287</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="287"><span class="line-num">288</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="288"><span class="line-num">289</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="289"><span class="line-num">290</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="290"><span class="line-num">291</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="291"><span class="line-num">292</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="292"><span class="line-num">293</span><span class="line-content">    <span class="inline-diff">re</span>t<span class="inline-diff">urn &quot;@&quot; in</span> email<span class="inline-diff"> and &quot;.&quot; in email</span></span></div>
<div class="line chunk-replace" data-line="293"><span class="line-num">294</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="294"><span class="line-num">295</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">E-comm</span>er<span class="inline-diff">ce</span> <span class="inline-diff">Syst</span>em <span class="inline-diff">-</span> <span class="inline-diff">Vers</span>i<span class="inline-diff">o</span>n <span class="inline-diff">1.0</span></span></div>
<div class="line chunk-replace" data-line="295"><span class="line-num">296</span><span class="line-content"># Basic implementation of shopping cart and order processing</span></div>
<div class="line " data-line="296"><span class="line-num">297</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="297"><span class="line-num">298</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="298"><span class="line-num">299</span><span class="line-content">import logging</span></div>
<div class="line " data-line="299"><span class="line-num">300</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line " data-line="300"><span class="line-num">301</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="301"><span class="line-num">302</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="302"><span class="line-num">303</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="303"><span class="line-num">304</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="304"><span class="line-num">305</span><span class="line-content">    def __init__(self, id, name, price, category):</span></div>
<div class="line " data-line="305"><span class="line-num">306</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="306"><span class="line-num">307</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="307"><span class="line-num">308</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="308"><span class="line-num">309</span><span class="line-content">        self.category = category</span></div>
<div class="line " data-line="309"><span class="line-num">310</span><span class="line-content">        self.stock = 0</span></div>
<div class="line " data-line="310"><span class="line-num">311</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="311"><span class="line-num">312</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line " data-line="312"><span class="line-num">313</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="313"><span class="line-num">314</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="314"><span class="line-num">315</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="315"><span class="line-num">316</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="316"><span class="line-num">317</span><span class="line-content">        return f&quot;{self.name} - ${self.price}&quot;</span></div>
<div class="line " data-line="317"><span class="line-num">318</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="318"><span class="line-num">319</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="319"><span class="line-num">320</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line " data-line="320"><span class="line-num">321</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="321"><span class="line-num">322</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="322"><span class="line-num">323</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="323"><span class="line-num">324</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="324"><span class="line-num">325</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="325"><span class="line-num">326</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="326"><span class="line-num">327</span><span class="line-content">def <span class="inline-diff">calc</span>u<span class="inline-diff">l</span>ate_t<span class="inline-diff">otal(</span>ite<span class="inline-diff">ms</span>):</span></div>
<div class="line chunk-replace" data-line="327"><span class="line-num">328</span><span class="line-content">    t<span class="inline-diff">o</span>t<span class="inline-diff">al</span> = <span class="inline-diff">Decimal(&#x27;</span>0<span class="inline-diff">&#x27;)</span></span></div>
<div class="line " data-line="328"><span class="line-num">329</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="329"><span class="line-num">330</span><span class="line-content">        total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="330"><span class="line-num">331</span><span class="line-content">    return total</span></div>
<div class="line " data-line="331"><span class="line-num">332</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="332"><span class="line-num">333</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="333"><span class="line-num">334</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="334"><span class="line-num">335</span><span class="line-content">    total = calculate_total(items)</span></div>
<div class="line " data-line="335"><span class="line-num">336</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="336"><span class="line-num">337</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="337"><span class="line-num">338</span><span class="line-content">        discount<span class="inline-diff"> = </span>total<span class="inline-diff"> *</span> Decimal(&#x27;0.1&#x27;)</span></div>
<div class="line chunk-replace" data-line="338"><span class="line-num">339</span><span class="line-content">        total = total - discount</span></div>
<div class="line chunk-replace" data-line="339"><span class="line-num">340</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="340"><span class="line-num">341</span><span class="line-content">    return total</span></div>
<div class="line " data-line="341"><span class="line-num">342</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="342"><span class="line-num">343</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="343"><span class="line-num">344</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="344"><span class="line-num">345</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="345"><span class="line-num">346</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line " data-line="346"><span class="line-num">347</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="347"><span class="line-num">348</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line " data-line="348"><span class="line-num">349</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="349"><span class="line-num">350</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line " data-line="350"><span class="line-num">351</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="351"><span class="line-num">352</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="352"><span class="line-num">353</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line " data-line="353"><span class="line-num">354</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="354"><span class="line-num">355</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="355"><span class="line-num">356</span><span class="line-content">        return calculate_total(self.items)</span></div>
<div class="line " data-line="356"><span class="line-num">357</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="357"><span class="line-num">358</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="358"><span class="line-num">359</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="359"><span class="line-num">360</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="360"><span class="line-num">361</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="361"><span class="line-num">362</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="362"><span class="line-num">363</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="363"><span class="line-num">364</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="364"><span class="line-num">365</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="365"><span class="line-num">366</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line " data-line="366"><span class="line-num">367</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="367"><span class="line-num">368</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="368"><span class="line-num">369</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="369"><span class="line-num">370</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="370"><span class="line-num">371</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="371"><span class="line-num">372</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="372"><span class="line-num">373</span><span class="line-content">        <span class="inline-diff">logger.info(f&quot;Order confirmed for {</span>self.cu<span class="inline-diff">sto</span>mer<span class="inline-diff">}&quot;</span>)</span></div>
<div class="line " data-line="373"><span class="line-num">374</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="374"><span class="line-num">375</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="375"><span class="line-num">376</span><span class="line-content">    def __init__(self, name, email):</span></div>
<div class="line " data-line="376"><span class="line-num">377</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="377"><span class="line-num">378</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="378"><span class="line-num">379</span><span class="line-content">        self.o<span class="inline-diff">rd</span>e<span class="inline-diff">rs</span> = <span class="inline-diff">[]</span></span></div>
<div class="line " data-line="379"><span class="line-num">380</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="380"><span class="line-num">381</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line " data-line="381"><span class="line-num">382</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="382"><span class="line-num">383</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="383"><span class="line-num">384</span><span class="line-content">        return order</span></div>
<div class="line " data-line="384"><span class="line-num">385</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="385"><span class="line-num">386</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="386"><span class="line-num">387</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="387"><span class="line-num">388</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="388"><span class="line-num">389</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="389"><span class="line-num">390</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="390"><span class="line-num">391</span><span class="line-content">    <span class="inline-diff">re</span>t<span class="inline-diff">urn &quot;@&quot; in</span> email<span class="inline-diff"> and &quot;.&quot; in email</span></span></div>
<div class="line chunk-replace" data-line="391"><span class="line-num">392</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="392"><span class="line-num">393</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">E-comm</span>er<span class="inline-diff">ce</span> <span class="inline-diff">Syst</span>em <span class="inline-diff">-</span> <span class="inline-diff">Vers</span>i<span class="inline-diff">o</span>n <span class="inline-diff">1.0</span></span></div>
<div class="line chunk-replace" data-line="393"><span class="line-num">394</span><span class="line-content"># Basic implementation of shopping cart and order processing</span></div>
<div class="line " data-line="394"><span class="line-num">395</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="395"><span class="line-num">396</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="396"><span class="line-num">397</span><span class="line-content">import logging</span></div>
<div class="line " data-line="397"><span class="line-num">398</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line " data-line="398"><span class="line-num">399</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="399"><span class="line-num">400</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="400"><span class="line-num">401</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="401"><span class="line-num">402</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="402"><span class="line-num">403</span><span class="line-content">    def __init__(self, id, name, price, category):</span></div>
<div class="line " data-line="403"><span class="line-num">404</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="404"><span class="line-num">405</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="405"><span class="line-num">406</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="406"><span class="line-num">407</span><span class="line-content">        self.category = category</span></div>
<div class="line " data-line="407"><span class="line-num">408</span><span class="line-content">        self.stock = 0</span></div>
<div class="line " data-line="408"><span class="line-num">409</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="409"><span class="line-num">410</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line " data-line="410"><span class="line-num">411</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="411"><span class="line-num">412</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="412"><span class="line-num">413</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="413"><span class="line-num">414</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="414"><span class="line-num">415</span><span class="line-content">        return f&quot;{self.name} - ${self.price}&quot;</span></div>
<div class="line " data-line="415"><span class="line-num">416</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="416"><span class="line-num">417</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="417"><span class="line-num">418</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line " data-line="418"><span class="line-num">419</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="419"><span class="line-num">420</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="420"><span class="line-num">421</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="421"><span class="line-num">422</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="422"><span class="line-num">423</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="423"><span class="line-num">424</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="424"><span class="line-num">425</span><span class="line-content">def <span class="inline-diff">calc</span>u<span class="inline-diff">l</span>ate_t<span class="inline-diff">otal(</span>ite<span class="inline-diff">ms</span>):</span></div>
<div class="line chunk-replace" data-line="425"><span class="line-num">426</span><span class="line-content">    t<span class="inline-diff">o</span>t<span class="inline-diff">al</span> = <span class="inline-diff">Decimal(&#x27;</span>0<span class="inline-diff">&#x27;)</span></span></div>
<div class="line " data-line="426"><span class="line-num">427</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="427"><span class="line-num">428</span><span class="line-content">        total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="428"><span class="line-num">429</span><span class="line-content">    return total</span></div>
<div class="line " data-line="429"><span class="line-num">430</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="430"><span class="line-num">431</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="431"><span class="line-num">432</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="432"><span class="line-num">433</span><span class="line-content">    total = calculate_total(items)</span></div>
<div class="line " data-line="433"><span class="line-num">434</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="434"><span class="line-num">435</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="435"><span class="line-num">436</span><span class="line-content">        discount<span class="inline-diff"> = </span>total<span class="inline-diff"> *</span> Decimal(&#x27;0.1&#x27;)</span></div>
<div class="line chunk-replace" data-line="436"><span class="line-num">437</span><span class="line-content">        total = total - discount</span></div>
<div class="line chunk-replace" data-line="437"><span class="line-num">438</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="438"><span class="line-num">439</span><span class="line-content">    return total</span></div>
<div class="line " data-line="439"><span class="line-num">440</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="440"><span class="line-num">441</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="441"><span class="line-num">442</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="442"><span class="line-num">443</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="443"><span class="line-num">444</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line " data-line="444"><span class="line-num">445</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="445"><span class="line-num">446</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line " data-line="446"><span class="line-num">447</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="447"><span class="line-num">448</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line " data-line="448"><span class="line-num">449</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="449"><span class="line-num">450</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="450"><span class="line-num">451</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line " data-line="451"><span class="line-num">452</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="452"><span class="line-num">453</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="453"><span class="line-num">454</span><span class="line-content">        return calculate_total(self.items)</span></div>
<div class="line " data-line="454"><span class="line-num">455</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="455"><span class="line-num">456</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="456"><span class="line-num">457</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="457"><span class="line-num">458</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="458"><span class="line-num">459</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="459"><span class="line-num">460</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="460"><span class="line-num">461</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="461"><span class="line-num">462</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="462"><span class="line-num">463</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="463"><span class="line-num">464</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line " data-line="464"><span class="line-num">465</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="465"><span class="line-num">466</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="466"><span class="line-num">467</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="467"><span class="line-num">468</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="468"><span class="line-num">469</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="469"><span class="line-num">470</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="470"><span class="line-num">471</span><span class="line-content">        <span class="inline-diff">logger.info(f&quot;Order confirmed for {</span>self.cu<span class="inline-diff">sto</span>mer<span class="inline-diff">}&quot;</span>)</span></div>
<div class="line " data-line="471"><span class="line-num">472</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="472"><span class="line-num">473</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="473"><span class="line-num">474</span><span class="line-content">    def __init__(self, name, email):</span></div>
<div class="line " data-line="474"><span class="line-num">475</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="475"><span class="line-num">476</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="476"><span class="line-num">477</span><span class="line-content">        self.o<span class="inline-diff">rd</span>e<span class="inline-diff">rs</span> = <span class="inline-diff">[]</span></span></div>
<div class="line " data-line="477"><span class="line-num">478</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="478"><span class="line-num">479</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line " data-line="479"><span class="line-num">480</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="480"><span class="line-num">481</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="481"><span class="line-num">482</span><span class="line-content">        return order</span></div>
<div class="line " data-line="482"><span class="line-num">483</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="483"><span class="line-num">484</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="484"><span class="line-num">485</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="485"><span class="line-num">486</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="486"><span class="line-num">487</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="487"><span class="line-num">488</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="488"><span class="line-num">489</span><span class="line-content">    <span class="inline-diff">re</span>t<span class="inline-diff">urn &quot;@&quot; in</span> email<span class="inline-diff"> and &quot;.&quot; in email</span></span></div>
<div class="line chunk-replace" data-line="489"><span class="line-num">490</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="490"><span class="line-num">491</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">E-comm</span>er<span class="inline-diff">ce</span> <span class="inline-diff">Syst</span>em <span class="inline-diff">-</span> <span class="inline-diff">Vers</span>i<span class="inline-diff">o</span>n <span class="inline-diff">1.0</span></span></div>
<div class="line chunk-replace" data-line="491"><span class="line-num">492</span><span class="line-content"># Basic implementation of shopping cart and order processing</span></div>
<div class="line " data-line="492"><span class="line-num">493</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="493"><span class="line-num">494</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="494"><span class="line-num">495</span><span class="line-content">import logging</span></div>
<div class="line " data-line="495"><span class="line-num">496</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line " data-line="496"><span class="line-num">497</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="497"><span class="line-num">498</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="498"><span class="line-num">499</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="499"><span class="line-num">500</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="500"><span class="line-num">501</span><span class="line-content">    def __init__(self, id, name, price, category):</span></div>
<div class="line " data-line="501"><span class="line-num">502</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="502"><span class="line-num">503</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="503"><span class="line-num">504</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="504"><span class="line-num">505</span><span class="line-content">        self.category = category</span></div>
<div class="line " data-line="505"><span class="line-num">506</span><span class="line-content">        self.stock = 0</span></div>
<div class="line " data-line="506"><span class="line-num">507</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="507"><span class="line-num">508</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line " data-line="508"><span class="line-num">509</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="509"><span class="line-num">510</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="510"><span class="line-num">511</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="511"><span class="line-num">512</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="512"><span class="line-num">513</span><span class="line-content">        return f&quot;{self.name} - ${self.price}&quot;</span></div>
<div class="line " data-line="513"><span class="line-num">514</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="514"><span class="line-num">515</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="515"><span class="line-num">516</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line " data-line="516"><span class="line-num">517</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="517"><span class="line-num">518</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="518"><span class="line-num">519</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="519"><span class="line-num">520</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="520"><span class="line-num">521</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="521"><span class="line-num">522</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="522"><span class="line-num">523</span><span class="line-content">def <span class="inline-diff">calc</span>u<span class="inline-diff">l</span>ate_t<span class="inline-diff">otal(</span>ite<span class="inline-diff">ms</span>):</span></div>
<div class="line chunk-replace" data-line="523"><span class="line-num">524</span><span class="line-content">    t<span class="inline-diff">o</span>t<span class="inline-diff">al</span> = <span class="inline-diff">Decimal(&#x27;</span>0<span class="inline-diff">&#x27;)</span></span></div>
<div class="line " data-line="524"><span class="line-num">525</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="525"><span class="line-num">526</span><span class="line-content">        total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="526"><span class="line-num">527</span><span class="line-content">    return total</span></div>
<div class="line " data-line="527"><span class="line-num">528</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="528"><span class="line-num">529</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="529"><span class="line-num">530</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="530"><span class="line-num">531</span><span class="line-content">    total = calculate_total(items)</span></div>
<div class="line " data-line="531"><span class="line-num">532</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="532"><span class="line-num">533</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="533"><span class="line-num">534</span><span class="line-content">        discount<span class="inline-diff"> = </span>total<span class="inline-diff"> *</span> Decimal(&#x27;0.1&#x27;)</span></div>
<div class="line chunk-replace" data-line="534"><span class="line-num">535</span><span class="line-content">        total = total - discount</span></div>
<div class="line chunk-replace" data-line="535"><span class="line-num">536</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="536"><span class="line-num">537</span><span class="line-content">    return total</span></div>
<div class="line " data-line="537"><span class="line-num">538</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="538"><span class="line-num">539</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="539"><span class="line-num">540</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="540"><span class="line-num">541</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="541"><span class="line-num">542</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line " data-line="542"><span class="line-num">543</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="543"><span class="line-num">544</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line " data-line="544"><span class="line-num">545</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="545"><span class="line-num">546</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line " data-line="546"><span class="line-num">547</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="547"><span class="line-num">548</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="548"><span class="line-num">549</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line " data-line="549"><span class="line-num">550</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="550"><span class="line-num">551</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="551"><span class="line-num">552</span><span class="line-content">        return calculate_total(self.items)</span></div>
<div class="line " data-line="552"><span class="line-num">553</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="553"><span class="line-num">554</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="554"><span class="line-num">555</span><span class="line-content">        self.items = []</span></div>
<div class="line " data-line="555"><span class="line-num">556</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="556"><span class="line-num">557</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="557"><span class="line-num">558</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="558"><span class="line-num">559</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="559"><span class="line-num">560</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="560"><span class="line-num">561</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="561"><span class="line-num">562</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line " data-line="562"><span class="line-num">563</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="563"><span class="line-num">564</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="564"><span class="line-num">565</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="565"><span class="line-num">566</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="566"><span class="line-num">567</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="567"><span class="line-num">568</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="568"><span class="line-num">569</span><span class="line-content">        <span class="inline-diff">logger.info(f&quot;Order confirmed for {</span>self.cu<span class="inline-diff">sto</span>mer<span class="inline-diff">}&quot;</span>)</span></div>
<div class="line " data-line="569"><span class="line-num">570</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="570"><span class="line-num">571</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="571"><span class="line-num">572</span><span class="line-content">    def __init__(self, name, email):</span></div>
<div class="line " data-line="572"><span class="line-num">573</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="573"><span class="line-num">574</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="574"><span class="line-num">575</span><span class="line-content">        self.o<span class="inline-diff">rd</span>e<span class="inline-diff">rs</span> = <span class="inline-diff">[]</span></span></div>
<div class="line " data-line="575"><span class="line-num">576</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="576"><span class="line-num">577</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line " data-line="577"><span class="line-num">578</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="578"><span class="line-num">579</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="579"><span class="line-num">580</span><span class="line-content">        return order</span></div>
<div class="line " data-line="580"><span class="line-num">581</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="581"><span class="line-num">582</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="582"><span class="line-num">583</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="583"><span class="line-num">584</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="584"><span class="line-num">585</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="585"><span class="line-num">586</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="586"><span class="line-num">587</span><span class="line-content">    <span class="inline-diff">re</span>t<span class="inline-diff">urn &quot;@&quot; in</span> email<span class="inline-diff"> and &quot;.&quot; in email</span></span></div>
<div class="line chunk-replace" data-line="587"><span class="line-num">588</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="588"><span class="line-num">589</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">E-comm</span>er<span class="inline-diff">ce</span> <span class="inline-diff">Syst</span>em <span class="inline-diff">-</span> <span class="inline-diff">Vers</span>i<span class="inline-diff">o</span>n <span class="inline-diff">1.0</span></span></div>
<div class="line chunk-replace" data-line="589"><span class="line-num">590</span><span class="line-content"># Basic implementation of shopping cart and order processing</span></div>
<div class="line chunk-replace" data-line="590"><span class="line-num">591</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="591"><span class="line-num">592</span><span class="line-content"><span class="inline-diff">imp</span>or<span class="inline-diff">t</span> <span class="inline-diff">d</span>ate<span class="inline-diff">t</span>i<span class="inline-diff">me</span></span></div>
<div class="line chunk-replace" data-line="592"><span class="line-num">593</span><span class="line-content"><span class="inline-diff">import</span> logging</span></div>
<div class="line chunk-replace" data-line="593"><span class="line-num">594</span><span class="line-content"><span class="inline-diff">from</span> <span class="inline-diff">deci</span>mal i<span class="inline-diff">mp</span>or<span class="inline-diff">t D</span>e<span class="inline-diff">cimal</span></span></div>
<div class="line chunk-replace" data-line="594"><span class="line-num">595</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="595"><span class="line-num">596</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line chunk-replace" data-line="596"><span class="line-num">597</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="597"><span class="line-num">598</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="598"><span class="line-num">599</span><span class="line-content">    def __init__(self, id, name, price, category):</span></div>
<div class="line chunk-replace" data-line="599"><span class="line-num">600</span><span class="line-content">        self.id = id</span></div>
<div class="line chunk-replace" data-line="600"><span class="line-num">601</span><span class="line-content">        self.name = name</span></div>
<div class="line chunk-replace" data-line="601"><span class="line-num">602</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line chunk-replace" data-line="602"><span class="line-num">603</span><span class="line-content">        self.category = category</span></div>
<div class="line chunk-replace" data-line="603"><span class="line-num">604</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-replace" data-line="604"><span class="line-num">605</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="605"><span class="line-num">606</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line chunk-replace" data-line="606"><span class="line-num">607</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line chunk-replace" data-line="607"><span class="line-num">608</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line chunk-replace" data-line="608"><span class="line-num">609</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="609"><span class="line-num">610</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="610"><span class="line-num">611</span><span class="line-content">        return f&quot;{self.name} - ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="611"><span class="line-num">612</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="612"><span class="line-num">613</span><span class="line-content">class CartItem:</span></div>
<div class="line chunk-replace" data-line="613"><span class="line-num">614</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line chunk-replace" data-line="614"><span class="line-num">615</span><span class="line-content">        self.product = product</span></div>
<div class="line chunk-replace" data-line="615"><span class="line-num">616</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line chunk-replace" data-line="616"><span class="line-num">617</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="617"><span class="line-num">618</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line chunk-replace" data-line="618"><span class="line-num">619</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line chunk-replace" data-line="619"><span class="line-num">620</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="620"><span class="line-num">621</span><span class="line-content">def calculate_total(items):</span></div>
<div class="line chunk-replace" data-line="621"><span class="line-num">622</span><span class="line-content">    total = Decimal(&#x27;0&#x27;)</span></div>
<div class="line chunk-replace" data-line="622"><span class="line-num">623</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="623"><span class="line-num">624</span><span class="line-content">        total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="624"><span class="line-num">625</span><span class="line-content">    return total</span></div>
<div class="line chunk-replace" data-line="625"><span class="line-num">626</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="626"><span class="line-num">627</span><span class="line-content">def process_order(order):</span></div>
<div class="line chunk-replace" data-line="627"><span class="line-num">628</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="628"><span class="line-num">629</span><span class="line-content">    total = calculate_total(items)</span></div>
<div class="line chunk-replace" data-line="629"><span class="line-num">630</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="630"><span class="line-num">631</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="631"><span class="line-num">632</span><span class="line-content">        discount = total * Decimal(&#x27;0.1&#x27;)</span></div>
<div class="line chunk-replace" data-line="632"><span class="line-num">633</span><span class="line-content">        total = total - discount</span></div>
<div class="line chunk-replace" data-line="633"><span class="line-num">634</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="634"><span class="line-num">635</span><span class="line-content">    return total</span></div>
<div class="line chunk-replace" data-line="635"><span class="line-num">636</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="636"><span class="line-num">637</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="637"><span class="line-num">638</span><span class="line-content">    def __init__(self):</span></div>
<div class="line chunk-replace" data-line="638"><span class="line-num">639</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-replace" data-line="639"><span class="line-num">640</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-replace" data-line="640"><span class="line-num">641</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="641"><span class="line-num">642</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line chunk-replace" data-line="642"><span class="line-num">643</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line chunk-replace" data-line="643"><span class="line-num">644</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line chunk-replace" data-line="644"><span class="line-num">645</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="645"><span class="line-num">646</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line chunk-replace" data-line="646"><span class="line-num">647</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line chunk-replace" data-line="647"><span class="line-num">648</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="648"><span class="line-num">649</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="649"><span class="line-num">650</span><span class="line-content">        return calculate_total(self.items)</span></div>
<div class="line chunk-replace" data-line="650"><span class="line-num">651</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="651"><span class="line-num">652</span><span class="line-content">    def clear(self):</span></div>
<div class="line chunk-replace" data-line="652"><span class="line-num">653</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-replace" data-line="653"><span class="line-num">654</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="654"><span class="line-num">655</span><span class="line-content">class Order:</span></div>
<div class="line chunk-replace" data-line="655"><span class="line-num">656</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line chunk-replace" data-line="656"><span class="line-num">657</span><span class="line-content">        self.cart = cart</span></div>
<div class="line chunk-replace" data-line="657"><span class="line-num">658</span><span class="line-content">        self.customer = customer</span></div>
<div class="line chunk-replace" data-line="658"><span class="line-num">659</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line chunk-replace" data-line="659"><span class="line-num">660</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line chunk-replace" data-line="660"><span class="line-num">661</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="661"><span class="line-num">662</span><span class="line-content">    def get_items(self):</span></div>
<div class="line chunk-replace" data-line="662"><span class="line-num">663</span><span class="line-content">        return self.cart.items</span></div>
<div class="line chunk-replace" data-line="663"><span class="line-num">664</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="664"><span class="line-num">665</span><span class="line-content">    def confirm(self):</span></div>
<div class="line chunk-replace" data-line="665"><span class="line-num">666</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="666"><span class="line-num">667</span><span class="line-content">        logger.info(f&quot;Order confirmed for {self.customer}&quot;)</span></div>
<div class="line chunk-replace" data-line="667"><span class="line-num">668</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="668"><span class="line-num">669</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="669"><span class="line-num">670</span><span class="line-content">    def __init__(self, name, email):</span></div>
<div class="line chunk-replace" data-line="670"><span class="line-num">671</span><span class="line-content">        self.name = name</span></div>
<div class="line chunk-replace" data-line="671"><span class="line-num">672</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="672"><span class="line-num">673</span><span class="line-content">        self.orders = []</span></div>
<div class="line chunk-replace" data-line="673"><span class="line-num">674</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="674"><span class="line-num">675</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line chunk-replace" data-line="675"><span class="line-num">676</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line chunk-replace" data-line="676"><span class="line-num">677</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line chunk-replace" data-line="677"><span class="line-num">678</span><span class="line-content">        return order</span></div>
<div class="line chunk-replace" data-line="678"><span class="line-num">679</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="679"><span class="line-num">680</span><span class="line-content"># Utility functions</span></div>
<div class="line chunk-replace" data-line="680"><span class="line-num">681</span><span class="line-content">def format_price(amount):</span></div>
<div class="line chunk-replace" data-line="681"><span class="line-num">682</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line chunk-replace" data-line="682"><span class="line-num">683</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="683"><span class="line-num">684</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="684"><span class="line-num">685</span><span class="line-content">    return &quot;@&quot; in email and &quot;.&quot; in email</span></div>
<div class="line chunk-replace" data-line="685"><span class="line-num">686</span><span class="line-content">&nbsp;</span></div>
        </div>

        <svg id="linkmap" class="link-map" style="display: none;"></svg>
        <canvas id="linkmap-canvas" class="link-map"></canvas>

        <div class="file-pane" id="right-pane">
<div class="line chunk-replace" data-line="0"><span class="line-num">1</span><span class="line-content"># E-commerce System - Version <span class="inline-diff">2</span>.0</span></div>
<div class="line chunk-replace" data-line="1"><span class="line-num">2</span><span class="line-content"># <span class="inline-diff">Enh</span>a<span class="inline-diff">n</span>c<span class="inline-diff">ed</span> implementation <span class="inline-diff">w</span>it<span class="inline-diff">h tax, discounts,</span> and <span class="inline-diff">bett</span>er <span class="inline-diff">val</span>i<span class="inline-diff">datio</span>n</span></div>
<div class="line " data-line="2"><span class="line-num">3</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="3"><span class="line-num">4</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="4"><span class="line-num">5</span><span class="line-content">import logging</span></div>
<div class="line " data-line="5"><span class="line-num">6</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line chunk-insert" data-line="6"><span class="line-num">7</span><span class="line-content">from typing import List, Optional</span></div>
<div class="line " data-line="7"><span class="line-num">8</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="8"><span class="line-num">9</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="9"><span class="line-num">10</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="10"><span class="line-num">11</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="11"><span class="line-num">12</span><span class="line-content">    def __init__(self, id, name, price, category<span class="inline-diff">, description=&quot;&quot;</span>):</span></div>
<div class="line " data-line="12"><span class="line-num">13</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="13"><span class="line-num">14</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="14"><span class="line-num">15</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="15"><span class="line-num">16</span><span class="line-content">        self.category = category</span></div>
<div class="line chunk-insert" data-line="16"><span class="line-num">17</span><span class="line-content">        self.description = description</span></div>
<div class="line " data-line="17"><span class="line-num">18</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-insert" data-line="18"><span class="line-num">19</span><span class="line-content">        self.sku = f&quot;SKU-{id}&quot;</span></div>
<div class="line " data-line="19"><span class="line-num">20</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="20"><span class="line-num">21</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line chunk-insert" data-line="21"><span class="line-num">22</span><span class="line-content">        if self.stock + quantity &lt; 0:</span></div>
<div class="line chunk-insert" data-line="22"><span class="line-num">23</span><span class="line-content">            raise ValueError(&quot;Insufficient stock&quot;)</span></div>
<div class="line " data-line="23"><span class="line-num">24</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="24"><span class="line-num">25</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="25"><span class="line-num">26</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="26"><span class="line-num">27</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="27"><span class="line-num">28</span><span class="line-content">        return f&quot;{self.name} <span class="inline-diff">({self.sku}) </span>- ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="28"><span class="line-num">29</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="29"><span class="line-num">30</span><span class="line-content"><span class="inline-diff">    def is_avai</span>la<span class="inline-diff">bl</span>e<span class="inline-diff">(self)</span>:</span></div>
<div class="line chunk-replace" data-line="30"><span class="line-num">31</span><span class="line-content">     <span class="inline-diff">   re</span>t<span class="inline-diff">urn </span>self<span class="inline-diff">.s</span>t<span class="inline-diff">ock</span> <span class="inline-diff">&gt; 0</span></span></div>
<div class="line " data-line="31"><span class="line-num">32</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="32"><span class="line-num">33</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="33"><span class="line-num">34</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="34"><span class="line-num">35</span><span class="line-content">        if quantity &lt;= 0:</span></div>
<div class="line chunk-insert" data-line="35"><span class="line-num">36</span><span class="line-content">            raise ValueError(&quot;Quantity must be positive&quot;)</span></div>
<div class="line " data-line="36"><span class="line-num">37</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="37"><span class="line-num">38</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="38"><span class="line-num">39</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="39"><span class="line-num">40</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="40"><span class="line-num">41</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="41"><span class="line-num">42</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="42"><span class="line-num">43</span><span class="line-content"><span class="inline-diff">    </span>def u<span class="inline-diff">pd</span>ate_<span class="inline-diff">qu</span>a<span class="inline-diff">nt</span>it<span class="inline-diff">y(</span>s<span class="inline-diff">elf, new_quantity</span>):</span></div>
<div class="line chunk-replace" data-line="43"><span class="line-num">44</span><span class="line-content">     <span class="inline-diff">   if new_quantity &lt;</span>= 0<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="44"><span class="line-num">45</span><span class="line-content">    <span class="inline-diff">        raise ValueErr</span>or<span class="inline-diff">(&quot;Quant</span>it<span class="inline-diff">y</span> <span class="inline-diff">must</span> <span class="inline-diff">be pos</span>it<span class="inline-diff">iv</span>e<span class="inline-diff">&quot;)</span></span></div>
<div class="line chunk-replace" data-line="45"><span class="line-num">46</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.quant</span>it<span class="inline-diff">y = n</span>e<span class="inline-diff">w</span>_<span class="inline-diff">q</span>ua<span class="inline-diff">ntity</span></span></div>
<div class="line chunk-replace" data-line="46"><span class="line-num">47</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="47"><span class="line-num">48</span><span class="line-content">def calculate_total(items, tax_rate=Decimal(&#x27;0.0&#x27;)):</span></div>
<div class="line chunk-replace" data-line="48"><span class="line-num">49</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Calculat</span>e<span class="inline-diff"> total</span> pr<span class="inline-diff">i</span>ce<span class="inline-diff"> inclu</span>d<span class="inline-diff">ing tax&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="49"><span class="line-num">50</span><span class="line-content">    s<span class="inline-diff">ubtotal</span> = <span class="inline-diff">D</span>e<span class="inline-diff">c</span>im<span class="inline-diff">al</span>(<span class="inline-diff">&#x27;0&#x27;</span>)</span></div>
<div class="line " data-line="50"><span class="line-num">51</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="51"><span class="line-num">52</span><span class="line-content">        <span class="inline-diff">sub</span>total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="52"><span class="line-num">53</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="53"><span class="line-num">54</span><span class="line-content">    tax = subtotal * tax_rate</span></div>
<div class="line chunk-replace" data-line="54"><span class="line-num">55</span><span class="line-content"> <span class="inline-diff">   </span>re<span class="inline-diff">tu</span>r<span class="inline-diff">n subt</span>o<span class="inline-diff">tal + tax</span></span></div>
<div class="line chunk-replace" data-line="55"><span class="line-num">56</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="56"><span class="line-num">57</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">apply_discount(</span>total<span class="inline-diff">,</span> <span class="inline-diff">dis</span>c<span class="inline-diff">o</span>u<span class="inline-diff">nt_r</span>ate)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="57"><span class="line-num">58</span><span class="line-content">    &quot;&quot;&quot;Apply discount to total&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="58"><span class="line-num">59</span><span class="line-content">    <span class="inline-diff">return</span> total <span class="inline-diff">*</span> <span class="inline-diff">(Decimal(&#x27;</span>1<span class="inline-diff">&#x27;) - discount_rate)</span></span></div>
<div class="line " data-line="59"><span class="line-num">60</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="60"><span class="line-num">61</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="61"><span class="line-num">62</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="62"><span class="line-num">63</span><span class="line-content">    total = calculate_total(items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="63"><span class="line-num">64</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="64"><span class="line-num">65</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="65"><span class="line-num">66</span><span class="line-content">        <span class="inline-diff">total = apply_</span>discount<span class="inline-diff">(</span>total<span class="inline-diff">,</span> Decimal(&#x27;0.1&#x27;)<span class="inline-diff">)</span></span></div>
<div class="line chunk-replace" data-line="66"><span class="line-num">67</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="67"><span class="line-num">68</span><span class="line-content">    # Apply coupon if available</span></div>
<div class="line chunk-replace" data-line="68"><span class="line-num">69</span><span class="line-content">    <span class="inline-diff">if</span> o<span class="inline-diff">rder.coupon_code:</span></span></div>
<div class="line chunk-replace" data-line="69"><span class="line-num">70</span><span class="line-content">        total = apply_coupon(total, order.coupon_code)</span></div>
<div class="line chunk-replace" data-line="70"><span class="line-num">71</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="71"><span class="line-num">72</span><span class="line-content">    <span class="inline-diff"># Log the or</span>de<span class="inline-diff">r</span></span></div>
<div class="line chunk-replace" data-line="72"><span class="line-num">73</span><span class="line-content">    l<span class="inline-diff">ogger</span>.i<span class="inline-diff">nfo(f&quot;Ord</span>e<span class="inline-diff">r</span> <span class="inline-diff">processed:</span> <span class="inline-diff">${total:.2f}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="73"><span class="line-num">74</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="74"><span class="line-num">75</span><span class="line-content">    return total</span></div>
<div class="line chunk-replace" data-line="75"><span class="line-num">76</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="76"><span class="line-num">77</span><span class="line-content">d<span class="inline-diff">ef apply_</span>c<span class="inline-diff">oupon(</span>t<span class="inline-diff">otal</span>, <span class="inline-diff">co</span>u<span class="inline-diff">po</span>n<span class="inline-diff">_code</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="77"><span class="line-num">78</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;A</span>pp<span class="inline-diff">ly </span>c<span class="inline-diff">oupon d</span>i<span class="inline-diff">scoun</span>t<span class="inline-diff">&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="78"><span class="line-num">79</span><span class="line-content">    # Simple coupon validation</span></div>
<div class="line chunk-replace" data-line="79"><span class="line-num">80</span><span class="line-content">    <span class="inline-diff">i</span>f <span class="inline-diff">c</span>o<span class="inline-diff">u</span>p<span class="inline-diff">on_c</span>od<span class="inline-diff">e == &quot;SAVE10&quot;</span>:</span></div>
<div class="line chunk-replace" data-line="80"><span class="line-num">81</span><span class="line-content">        re<span class="inline-diff">tur</span>n tot<span class="inline-diff">al</span> <span class="inline-diff">*</span> <span class="inline-diff">De</span>ci<span class="inline-diff">mal(&#x27;0.9&#x27;)</span></span></div>
<div class="line " data-line="81"><span class="line-num">82</span><span class="line-content">    return total</span></div>
<div class="line " data-line="82"><span class="line-num">83</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="83"><span class="line-num">84</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="84"><span class="line-num">85</span><span class="line-content">    def __init__(self<span class="inline-diff">, customer=None</span>):</span></div>
<div class="line chunk-replace" data-line="85"><span class="line-num">86</span><span class="line-content">        self.items<span class="inline-diff">: List[CartItem]</span> = []</span></div>
<div class="line chunk-replace" data-line="86"><span class="line-num">87</span><span class="line-content">        self.c<span class="inline-diff">us</span>t<span class="inline-diff">om</span>e<span class="inline-diff">r</span> = <span class="inline-diff">cus</span>t<span class="inline-diff">o</span>me<span class="inline-diff">r</span></span></div>
<div class="line " data-line="87"><span class="line-num">88</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="88"><span class="line-num">89</span><span class="line-content">        self.updated_at = self.created_at</span></div>
<div class="line " data-line="89"><span class="line-num">90</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="90"><span class="line-num">91</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="91"><span class="line-num">92</span><span class="line-content">        if not product.is_available():</span></div>
<div class="line chunk-insert" data-line="92"><span class="line-num">93</span><span class="line-content">            raise ValueError(&quot;Product not available&quot;)</span></div>
<div class="line chunk-insert" data-line="93"><span class="line-num">94</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="94"><span class="line-num">95</span><span class="line-content">        # Check if product already in cart</span></div>
<div class="line chunk-insert" data-line="95"><span class="line-num">96</span><span class="line-content">        for item in self.items:</span></div>
<div class="line chunk-insert" data-line="96"><span class="line-num">97</span><span class="line-content">            if item.product.id == product.id:</span></div>
<div class="line chunk-insert" data-line="97"><span class="line-num">98</span><span class="line-content">                item.update_quantity(item.quantity + quantity)</span></div>
<div class="line chunk-insert" data-line="98"><span class="line-num">99</span><span class="line-content">                self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="99"><span class="line-num">100</span><span class="line-content">                return</span></div>
<div class="line chunk-insert" data-line="100"><span class="line-num">101</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="101"><span class="line-num">102</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="102"><span class="line-num">103</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line chunk-insert" data-line="103"><span class="line-num">104</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="104"><span class="line-num">105</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="105"><span class="line-num">106</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="106"><span class="line-num">107</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line chunk-insert" data-line="107"><span class="line-num">108</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="108"><span class="line-num">109</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="109"><span class="line-num">110</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="110"><span class="line-num">111</span><span class="line-content">        return calculate_total(self.items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="111"><span class="line-num">112</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="112"><span class="line-num">113</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="113"><span class="line-num">114</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-insert" data-line="114"><span class="line-num">115</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="115"><span class="line-num">116</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="116"><span class="line-num">117</span><span class="line-content">    def get_item_count(self):</span></div>
<div class="line chunk-insert" data-line="117"><span class="line-num">118</span><span class="line-content">        return sum(item.quantity for item in self.items)</span></div>
<div class="line " data-line="118"><span class="line-num">119</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="119"><span class="line-num">120</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="120"><span class="line-num">121</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="121"><span class="line-num">122</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="122"><span class="line-num">123</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="123"><span class="line-num">124</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="124"><span class="line-num">125</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line chunk-insert" data-line="125"><span class="line-num">126</span><span class="line-content">        self.coupon_code = None</span></div>
<div class="line chunk-insert" data-line="126"><span class="line-num">127</span><span class="line-content">        self.tracking_number = None</span></div>
<div class="line " data-line="127"><span class="line-num">128</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="128"><span class="line-num">129</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="129"><span class="line-num">130</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="130"><span class="line-num">131</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="131"><span class="line-num">132</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="132"><span class="line-num">133</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="133"><span class="line-num">134</span><span class="line-content">        self.t<span class="inline-diff">racking_nu</span>m<span class="inline-diff">b</span>er<span class="inline-diff"> = self._generate_tracking_number(</span>)</span></div>
<div class="line chunk-replace" data-line="134"><span class="line-num">135</span><span class="line-content">        logger.info(f&quot;Order confirmed for {self.customer.name}&quot;)</span></div>
<div class="line chunk-replace" data-line="135"><span class="line-num">136</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="136"><span class="line-num">137</span><span class="line-content">    def _<span class="inline-diff">generate</span>_<span class="inline-diff">track</span>in<span class="inline-diff">g</span>_<span class="inline-diff">number</span>(self):</span></div>
<div class="line chunk-replace" data-line="137"><span class="line-num">138</span><span class="line-content">        <span class="inline-diff">return f&quot;TRK{</span>self.<span class="inline-diff">order_d</span>a<span class="inline-diff">te.ti</span>me<span class="inline-diff">st</span>am<span class="inline-diff">p()}&quot;</span></span></div>
<div class="line chunk-replace" data-line="138"><span class="line-num">139</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="139"><span class="line-num">140</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">cancel(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="140"><span class="line-num">141</span><span class="line-content">        if self.status == &quot;shipped&quot;:</span></div>
<div class="line chunk-replace" data-line="141"><span class="line-num">142</span><span class="line-content">     <span class="inline-diff">       r</span>a<span class="inline-diff">ise ValueError(&quot;Cannot can</span>ce<span class="inline-diff">l shipped </span>order<span class="inline-diff">&quot;</span>)</span></div>
<div class="line chunk-replace" data-line="142"><span class="line-num">143</span><span class="line-content">        self<span class="inline-diff">.status = &quot;cancelled&quot;</span></span></div>
<div class="line " data-line="143"><span class="line-num">144</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="144"><span class="line-num">145</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="145"><span class="line-num">146</span><span class="line-content">    def __init__(self, name, email<span class="inline-diff">, phone=&quot;&quot;</span>):</span></div>
<div class="line " data-line="146"><span class="line-num">147</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="147"><span class="line-num">148</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="148"><span class="line-num">149</span><span class="line-content">        self.<span class="inline-diff">ph</span>o<span class="inline-diff">n</span>e = <span class="inline-diff">phone</span></span></div>
<div class="line chunk-replace" data-line="149"><span class="line-num">150</span><span class="line-content">        self.orders: List[Order] = []</span></div>
<div class="line chunk-replace" data-line="150"><span class="line-num">151</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.loy</span>a<span class="inline-diff">l</span>t<span class="inline-diff">y_points = 0</span></span></div>
<div class="line " data-line="151"><span class="line-num">152</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="152"><span class="line-num">153</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line chunk-insert" data-line="153"><span class="line-num">154</span><span class="line-content">        if not self.email:</span></div>
<div class="line chunk-insert" data-line="154"><span class="line-num">155</span><span class="line-content">            raise ValueError(&quot;Customer email required&quot;)</span></div>
<div class="line " data-line="155"><span class="line-num">156</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="156"><span class="line-num">157</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="157"><span class="line-num">158</span><span class="line-content">        return order</span></div>
<div class="line " data-line="158"><span class="line-num">159</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="159"><span class="line-num">160</span><span class="line-content">    def add_loyalty_points(self, points):</span></div>
<div class="line chunk-insert" data-line="160"><span class="line-num">161</span><span class="line-content">        self.loyalty_points += points</span></div>
<div class="line chunk-insert" data-line="161"><span class="line-num">162</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="162"><span class="line-num">163</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="163"><span class="line-num">164</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="164"><span class="line-num">165</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="165"><span class="line-num">166</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="166"><span class="line-num">167</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="167"><span class="line-num">168</span><span class="line-content">    i<span class="inline-diff">f </span>n<span class="inline-diff">ot</span> email<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="168"><span class="line-num">169</span><span class="line-content">        return False</span></div>
<div class="line chunk-replace" data-line="169"><span class="line-num">170</span><span class="line-content">    r<span class="inline-diff">etur</span>n <span class="inline-diff">&quot;@&quot; in email and &quot;</span>.<span class="inline-diff">&quot; in email and len(email) &gt; 5</span></span></div>
<div class="line chunk-replace" data-line="170"><span class="line-num">171</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="171"><span class="line-num">172</span><span class="line-content">def send_confirmation_email(customer, order):</span></div>
<div class="line chunk-replace" data-line="172"><span class="line-num">173</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Send </span>ord<span class="inline-diff">er confirm</span>ati<span class="inline-diff">on </span>e<span class="inline-diff">mail&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="173"><span class="line-num">174</span><span class="line-content"><span class="inline-diff">   </span> logg<span class="inline-diff">er.info(f&quot;Send</span>ing<span class="inline-diff"> confirmation to {customer.email}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="174"><span class="line-num">175</span><span class="line-content"> <span class="inline-diff">   # E</span>ma<span class="inline-diff">i</span>l <span class="inline-diff">s</span>e<span class="inline-diff">nd</span>i<span class="inline-diff">ng </span>l<span class="inline-diff">ogic here</span></span></div>
<div class="line chunk-replace" data-line="175"><span class="line-num">176</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="176"><span class="line-num">177</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="177"><span class="line-num">178</span><span class="line-content"># E-commerce System - Version 2.0</span></div>
<div class="line chunk-replace" data-line="178"><span class="line-num">179</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">Enhan</span>c<span class="inline-diff">ed implemen</span>t<span class="inline-diff">ation with tax, discounts, and better validation</span></span></div>
<div class="line " data-line="179"><span class="line-num">180</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="180"><span class="line-num">181</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="181"><span class="line-num">182</span><span class="line-content">import logging</span></div>
<div class="line " data-line="182"><span class="line-num">183</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line chunk-insert" data-line="183"><span class="line-num">184</span><span class="line-content">from typing import List, Optional</span></div>
<div class="line " data-line="184"><span class="line-num">185</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="185"><span class="line-num">186</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="186"><span class="line-num">187</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="187"><span class="line-num">188</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="188"><span class="line-num">189</span><span class="line-content">    def __init__(self, id, name, price, category<span class="inline-diff">, description=&quot;&quot;</span>):</span></div>
<div class="line " data-line="189"><span class="line-num">190</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="190"><span class="line-num">191</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="191"><span class="line-num">192</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="192"><span class="line-num">193</span><span class="line-content">        self.category = category</span></div>
<div class="line chunk-insert" data-line="193"><span class="line-num">194</span><span class="line-content">        self.description = description</span></div>
<div class="line " data-line="194"><span class="line-num">195</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-insert" data-line="195"><span class="line-num">196</span><span class="line-content">        self.sku = f&quot;SKU-{id}&quot;</span></div>
<div class="line " data-line="196"><span class="line-num">197</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="197"><span class="line-num">198</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line chunk-insert" data-line="198"><span class="line-num">199</span><span class="line-content">        if self.stock + quantity &lt; 0:</span></div>
<div class="line chunk-insert" data-line="199"><span class="line-num">200</span><span class="line-content">            raise ValueError(&quot;Insufficient stock&quot;)</span></div>
<div class="line " data-line="200"><span class="line-num">201</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="201"><span class="line-num">202</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="202"><span class="line-num">203</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="203"><span class="line-num">204</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="204"><span class="line-num">205</span><span class="line-content">        return f&quot;{self.name} <span class="inline-diff">({self.sku}) </span>- ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="205"><span class="line-num">206</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="206"><span class="line-num">207</span><span class="line-content"><span class="inline-diff">    def is_avai</span>la<span class="inline-diff">bl</span>e<span class="inline-diff">(self)</span>:</span></div>
<div class="line chunk-replace" data-line="207"><span class="line-num">208</span><span class="line-content">     <span class="inline-diff">   re</span>t<span class="inline-diff">urn </span>self<span class="inline-diff">.s</span>t<span class="inline-diff">ock</span> <span class="inline-diff">&gt; 0</span></span></div>
<div class="line " data-line="208"><span class="line-num">209</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="209"><span class="line-num">210</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="210"><span class="line-num">211</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="211"><span class="line-num">212</span><span class="line-content">        if quantity &lt;= 0:</span></div>
<div class="line chunk-insert" data-line="212"><span class="line-num">213</span><span class="line-content">            raise ValueError(&quot;Quantity must be positive&quot;)</span></div>
<div class="line " data-line="213"><span class="line-num">214</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="214"><span class="line-num">215</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="215"><span class="line-num">216</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="216"><span class="line-num">217</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="217"><span class="line-num">218</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="218"><span class="line-num">219</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="219"><span class="line-num">220</span><span class="line-content"><span class="inline-diff">    </span>def u<span class="inline-diff">pd</span>ate_<span class="inline-diff">qu</span>a<span class="inline-diff">nt</span>it<span class="inline-diff">y(</span>s<span class="inline-diff">elf, new_quantity</span>):</span></div>
<div class="line chunk-replace" data-line="220"><span class="line-num">221</span><span class="line-content">     <span class="inline-diff">   if new_quantity &lt;</span>= 0<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="221"><span class="line-num">222</span><span class="line-content">    <span class="inline-diff">        raise ValueErr</span>or<span class="inline-diff">(&quot;Quant</span>it<span class="inline-diff">y</span> <span class="inline-diff">must</span> <span class="inline-diff">be pos</span>it<span class="inline-diff">iv</span>e<span class="inline-diff">&quot;)</span></span></div>
<div class="line chunk-replace" data-line="222"><span class="line-num">223</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.quant</span>it<span class="inline-diff">y = n</span>e<span class="inline-diff">w</span>_<span class="inline-diff">q</span>ua<span class="inline-diff">ntity</span></span></div>
<div class="line chunk-replace" data-line="223"><span class="line-num">224</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="224"><span class="line-num">225</span><span class="line-content">def calculate_total(items, tax_rate=Decimal(&#x27;0.0&#x27;)):</span></div>
<div class="line chunk-replace" data-line="225"><span class="line-num">226</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Calculat</span>e<span class="inline-diff"> total</span> pr<span class="inline-diff">i</span>ce<span class="inline-diff"> inclu</span>d<span class="inline-diff">ing tax&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="226"><span class="line-num">227</span><span class="line-content">    s<span class="inline-diff">ubtotal</span> = <span class="inline-diff">D</span>e<span class="inline-diff">c</span>im<span class="inline-diff">al</span>(<span class="inline-diff">&#x27;0&#x27;</span>)</span></div>
<div class="line " data-line="227"><span class="line-num">228</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="228"><span class="line-num">229</span><span class="line-content">        <span class="inline-diff">sub</span>total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="229"><span class="line-num">230</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="230"><span class="line-num">231</span><span class="line-content">    tax = subtotal * tax_rate</span></div>
<div class="line chunk-replace" data-line="231"><span class="line-num">232</span><span class="line-content"> <span class="inline-diff">   </span>re<span class="inline-diff">tu</span>r<span class="inline-diff">n subt</span>o<span class="inline-diff">tal + tax</span></span></div>
<div class="line chunk-replace" data-line="232"><span class="line-num">233</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="233"><span class="line-num">234</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">apply_discount(</span>total<span class="inline-diff">,</span> <span class="inline-diff">dis</span>c<span class="inline-diff">o</span>u<span class="inline-diff">nt_r</span>ate)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="234"><span class="line-num">235</span><span class="line-content">    &quot;&quot;&quot;Apply discount to total&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="235"><span class="line-num">236</span><span class="line-content">    <span class="inline-diff">return</span> total <span class="inline-diff">*</span> <span class="inline-diff">(Decimal(&#x27;</span>1<span class="inline-diff">&#x27;) - discount_rate)</span></span></div>
<div class="line " data-line="236"><span class="line-num">237</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="237"><span class="line-num">238</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="238"><span class="line-num">239</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="239"><span class="line-num">240</span><span class="line-content">    total = calculate_total(items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="240"><span class="line-num">241</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="241"><span class="line-num">242</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="242"><span class="line-num">243</span><span class="line-content">        <span class="inline-diff">total = apply_</span>discount<span class="inline-diff">(</span>total<span class="inline-diff">,</span> Decimal(&#x27;0.1&#x27;)<span class="inline-diff">)</span></span></div>
<div class="line chunk-replace" data-line="243"><span class="line-num">244</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="244"><span class="line-num">245</span><span class="line-content">    # Apply coupon if available</span></div>
<div class="line chunk-replace" data-line="245"><span class="line-num">246</span><span class="line-content">    <span class="inline-diff">if</span> o<span class="inline-diff">rder.coupon_code:</span></span></div>
<div class="line chunk-replace" data-line="246"><span class="line-num">247</span><span class="line-content">        total = apply_coupon(total, order.coupon_code)</span></div>
<div class="line chunk-replace" data-line="247"><span class="line-num">248</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="248"><span class="line-num">249</span><span class="line-content">    <span class="inline-diff"># Log the or</span>de<span class="inline-diff">r</span></span></div>
<div class="line chunk-replace" data-line="249"><span class="line-num">250</span><span class="line-content">    l<span class="inline-diff">ogger</span>.i<span class="inline-diff">nfo(f&quot;Ord</span>e<span class="inline-diff">r</span> <span class="inline-diff">processed:</span> <span class="inline-diff">${total:.2f}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="250"><span class="line-num">251</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="251"><span class="line-num">252</span><span class="line-content">    return total</span></div>
<div class="line chunk-replace" data-line="252"><span class="line-num">253</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="253"><span class="line-num">254</span><span class="line-content">d<span class="inline-diff">ef apply_</span>c<span class="inline-diff">oupon(</span>t<span class="inline-diff">otal</span>, <span class="inline-diff">co</span>u<span class="inline-diff">po</span>n<span class="inline-diff">_code</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="254"><span class="line-num">255</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;A</span>pp<span class="inline-diff">ly </span>c<span class="inline-diff">oupon d</span>i<span class="inline-diff">scoun</span>t<span class="inline-diff">&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="255"><span class="line-num">256</span><span class="line-content">    # Simple coupon validation</span></div>
<div class="line chunk-replace" data-line="256"><span class="line-num">257</span><span class="line-content">    <span class="inline-diff">i</span>f <span class="inline-diff">c</span>o<span class="inline-diff">u</span>p<span class="inline-diff">on_c</span>od<span class="inline-diff">e == &quot;SAVE10&quot;</span>:</span></div>
<div class="line chunk-replace" data-line="257"><span class="line-num">258</span><span class="line-content">        re<span class="inline-diff">tur</span>n tot<span class="inline-diff">al</span> <span class="inline-diff">*</span> <span class="inline-diff">De</span>ci<span class="inline-diff">mal(&#x27;0.9&#x27;)</span></span></div>
<div class="line " data-line="258"><span class="line-num">259</span><span class="line-content">    return total</span></div>
<div class="line " data-line="259"><span class="line-num">260</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="260"><span class="line-num">261</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="261"><span class="line-num">262</span><span class="line-content">    def __init__(self<span class="inline-diff">, customer=None</span>):</span></div>
<div class="line chunk-replace" data-line="262"><span class="line-num">263</span><span class="line-content">        self.items<span class="inline-diff">: List[CartItem]</span> = []</span></div>
<div class="line chunk-replace" data-line="263"><span class="line-num">264</span><span class="line-content">        self.c<span class="inline-diff">us</span>t<span class="inline-diff">om</span>e<span class="inline-diff">r</span> = <span class="inline-diff">cus</span>t<span class="inline-diff">o</span>me<span class="inline-diff">r</span></span></div>
<div class="line " data-line="264"><span class="line-num">265</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="265"><span class="line-num">266</span><span class="line-content">        self.updated_at = self.created_at</span></div>
<div class="line " data-line="266"><span class="line-num">267</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="267"><span class="line-num">268</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="268"><span class="line-num">269</span><span class="line-content">        if not product.is_available():</span></div>
<div class="line chunk-insert" data-line="269"><span class="line-num">270</span><span class="line-content">            raise ValueError(&quot;Product not available&quot;)</span></div>
<div class="line chunk-insert" data-line="270"><span class="line-num">271</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="271"><span class="line-num">272</span><span class="line-content">        # Check if product already in cart</span></div>
<div class="line chunk-insert" data-line="272"><span class="line-num">273</span><span class="line-content">        for item in self.items:</span></div>
<div class="line chunk-insert" data-line="273"><span class="line-num">274</span><span class="line-content">            if item.product.id == product.id:</span></div>
<div class="line chunk-insert" data-line="274"><span class="line-num">275</span><span class="line-content">                item.update_quantity(item.quantity + quantity)</span></div>
<div class="line chunk-insert" data-line="275"><span class="line-num">276</span><span class="line-content">                self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="276"><span class="line-num">277</span><span class="line-content">                return</span></div>
<div class="line chunk-insert" data-line="277"><span class="line-num">278</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="278"><span class="line-num">279</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="279"><span class="line-num">280</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line chunk-insert" data-line="280"><span class="line-num">281</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="281"><span class="line-num">282</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="282"><span class="line-num">283</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="283"><span class="line-num">284</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line chunk-insert" data-line="284"><span class="line-num">285</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="285"><span class="line-num">286</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="286"><span class="line-num">287</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="287"><span class="line-num">288</span><span class="line-content">        return calculate_total(self.items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="288"><span class="line-num">289</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="289"><span class="line-num">290</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="290"><span class="line-num">291</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-insert" data-line="291"><span class="line-num">292</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="292"><span class="line-num">293</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="293"><span class="line-num">294</span><span class="line-content">    def get_item_count(self):</span></div>
<div class="line chunk-insert" data-line="294"><span class="line-num">295</span><span class="line-content">        return sum(item.quantity for item in self.items)</span></div>
<div class="line " data-line="295"><span class="line-num">296</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="296"><span class="line-num">297</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="297"><span class="line-num">298</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="298"><span class="line-num">299</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="299"><span class="line-num">300</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="300"><span class="line-num">301</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="301"><span class="line-num">302</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line chunk-insert" data-line="302"><span class="line-num">303</span><span class="line-content">        self.coupon_code = None</span></div>
<div class="line chunk-insert" data-line="303"><span class="line-num">304</span><span class="line-content">        self.tracking_number = None</span></div>
<div class="line " data-line="304"><span class="line-num">305</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="305"><span class="line-num">306</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="306"><span class="line-num">307</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="307"><span class="line-num">308</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="308"><span class="line-num">309</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="309"><span class="line-num">310</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="310"><span class="line-num">311</span><span class="line-content">        self.t<span class="inline-diff">racking_nu</span>m<span class="inline-diff">b</span>er<span class="inline-diff"> = self._generate_tracking_number(</span>)</span></div>
<div class="line chunk-replace" data-line="311"><span class="line-num">312</span><span class="line-content">        logger.info(f&quot;Order confirmed for {self.customer.name}&quot;)</span></div>
<div class="line chunk-replace" data-line="312"><span class="line-num">313</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="313"><span class="line-num">314</span><span class="line-content">    def _<span class="inline-diff">generate</span>_<span class="inline-diff">track</span>in<span class="inline-diff">g</span>_<span class="inline-diff">number</span>(self):</span></div>
<div class="line chunk-replace" data-line="314"><span class="line-num">315</span><span class="line-content">        <span class="inline-diff">return f&quot;TRK{</span>self.<span class="inline-diff">order_d</span>a<span class="inline-diff">te.ti</span>me<span class="inline-diff">st</span>am<span class="inline-diff">p()}&quot;</span></span></div>
<div class="line chunk-replace" data-line="315"><span class="line-num">316</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="316"><span class="line-num">317</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">cancel(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="317"><span class="line-num">318</span><span class="line-content">        if self.status == &quot;shipped&quot;:</span></div>
<div class="line chunk-replace" data-line="318"><span class="line-num">319</span><span class="line-content">     <span class="inline-diff">       r</span>a<span class="inline-diff">ise ValueError(&quot;Cannot can</span>ce<span class="inline-diff">l shipped </span>order<span class="inline-diff">&quot;</span>)</span></div>
<div class="line chunk-replace" data-line="319"><span class="line-num">320</span><span class="line-content">        self<span class="inline-diff">.status = &quot;cancelled&quot;</span></span></div>
<div class="line " data-line="320"><span class="line-num">321</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="321"><span class="line-num">322</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="322"><span class="line-num">323</span><span class="line-content">    def __init__(self, name, email<span class="inline-diff">, phone=&quot;&quot;</span>):</span></div>
<div class="line " data-line="323"><span class="line-num">324</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="324"><span class="line-num">325</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="325"><span class="line-num">326</span><span class="line-content">        self.<span class="inline-diff">ph</span>o<span class="inline-diff">n</span>e = <span class="inline-diff">phone</span></span></div>
<div class="line chunk-replace" data-line="326"><span class="line-num">327</span><span class="line-content">        self.orders: List[Order] = []</span></div>
<div class="line chunk-replace" data-line="327"><span class="line-num">328</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.loy</span>a<span class="inline-diff">l</span>t<span class="inline-diff">y_points = 0</span></span></div>
<div class="line " data-line="328"><span class="line-num">329</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="329"><span class="line-num">330</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line chunk-insert" data-line="330"><span class="line-num">331</span><span class="line-content">        if not self.email:</span></div>
<div class="line chunk-insert" data-line="331"><span class="line-num">332</span><span class="line-content">            raise ValueError(&quot;Customer email required&quot;)</span></div>
<div class="line " data-line="332"><span class="line-num">333</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="333"><span class="line-num">334</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="334"><span class="line-num">335</span><span class="line-content">        return order</span></div>
<div class="line " data-line="335"><span class="line-num">336</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="336"><span class="line-num">337</span><span class="line-content">    def add_loyalty_points(self, points):</span></div>
<div class="line chunk-insert" data-line="337"><span class="line-num">338</span><span class="line-content">        self.loyalty_points += points</span></div>
<div class="line chunk-insert" data-line="338"><span class="line-num">339</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="339"><span class="line-num">340</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="340"><span class="line-num">341</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="341"><span class="line-num">342</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="342"><span class="line-num">343</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="343"><span class="line-num">344</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="344"><span class="line-num">345</span><span class="line-content">    i<span class="inline-diff">f </span>n<span class="inline-diff">ot</span> email<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="345"><span class="line-num">346</span><span class="line-content">        return False</span></div>
<div class="line chunk-replace" data-line="346"><span class="line-num">347</span><span class="line-content">    r<span class="inline-diff">etur</span>n <span class="inline-diff">&quot;@&quot; in email and &quot;</span>.<span class="inline-diff">&quot; in email and len(email) &gt; 5</span></span></div>
<div class="line chunk-replace" data-line="347"><span class="line-num">348</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="348"><span class="line-num">349</span><span class="line-content">def send_confirmation_email(customer, order):</span></div>
<div class="line chunk-replace" data-line="349"><span class="line-num">350</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Send </span>ord<span class="inline-diff">er confirm</span>ati<span class="inline-diff">on </span>e<span class="inline-diff">mail&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="350"><span class="line-num">351</span><span class="line-content"><span class="inline-diff">   </span> logg<span class="inline-diff">er.info(f&quot;Send</span>ing<span class="inline-diff"> confirmation to {customer.email}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="351"><span class="line-num">352</span><span class="line-content"> <span class="inline-diff">   # E</span>ma<span class="inline-diff">i</span>l <span class="inline-diff">s</span>e<span class="inline-diff">nd</span>i<span class="inline-diff">ng </span>l<span class="inline-diff">ogic here</span></span></div>
<div class="line chunk-replace" data-line="352"><span class="line-num">353</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="353"><span class="line-num">354</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="354"><span class="line-num">355</span><span class="line-content"># E-commerce System - Version 2.0</span></div>
<div class="line chunk-replace" data-line="355"><span class="line-num">356</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">Enhan</span>c<span class="inline-diff">ed implemen</span>t<span class="inline-diff">ation with tax, discounts, and better validation</span></span></div>
<div class="line " data-line="356"><span class="line-num">357</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="357"><span class="line-num">358</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="358"><span class="line-num">359</span><span class="line-content">import logging</span></div>
<div class="line " data-line="359"><span class="line-num">360</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line chunk-insert" data-line="360"><span class="line-num">361</span><span class="line-content">from typing import List, Optional</span></div>
<div class="line " data-line="361"><span class="line-num">362</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="362"><span class="line-num">363</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="363"><span class="line-num">364</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="364"><span class="line-num">365</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="365"><span class="line-num">366</span><span class="line-content">    def __init__(self, id, name, price, category<span class="inline-diff">, description=&quot;&quot;</span>):</span></div>
<div class="line " data-line="366"><span class="line-num">367</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="367"><span class="line-num">368</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="368"><span class="line-num">369</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="369"><span class="line-num">370</span><span class="line-content">        self.category = category</span></div>
<div class="line chunk-insert" data-line="370"><span class="line-num">371</span><span class="line-content">        self.description = description</span></div>
<div class="line " data-line="371"><span class="line-num">372</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-insert" data-line="372"><span class="line-num">373</span><span class="line-content">        self.sku = f&quot;SKU-{id}&quot;</span></div>
<div class="line " data-line="373"><span class="line-num">374</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="374"><span class="line-num">375</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line chunk-insert" data-line="375"><span class="line-num">376</span><span class="line-content">        if self.stock + quantity &lt; 0:</span></div>
<div class="line chunk-insert" data-line="376"><span class="line-num">377</span><span class="line-content">            raise ValueError(&quot;Insufficient stock&quot;)</span></div>
<div class="line " data-line="377"><span class="line-num">378</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="378"><span class="line-num">379</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="379"><span class="line-num">380</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="380"><span class="line-num">381</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="381"><span class="line-num">382</span><span class="line-content">        return f&quot;{self.name} <span class="inline-diff">({self.sku}) </span>- ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="382"><span class="line-num">383</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="383"><span class="line-num">384</span><span class="line-content"><span class="inline-diff">    def is_avai</span>la<span class="inline-diff">bl</span>e<span class="inline-diff">(self)</span>:</span></div>
<div class="line chunk-replace" data-line="384"><span class="line-num">385</span><span class="line-content">     <span class="inline-diff">   re</span>t<span class="inline-diff">urn </span>self<span class="inline-diff">.s</span>t<span class="inline-diff">ock</span> <span class="inline-diff">&gt; 0</span></span></div>
<div class="line " data-line="385"><span class="line-num">386</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="386"><span class="line-num">387</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="387"><span class="line-num">388</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="388"><span class="line-num">389</span><span class="line-content">        if quantity &lt;= 0:</span></div>
<div class="line chunk-insert" data-line="389"><span class="line-num">390</span><span class="line-content">            raise ValueError(&quot;Quantity must be positive&quot;)</span></div>
<div class="line " data-line="390"><span class="line-num">391</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="391"><span class="line-num">392</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="392"><span class="line-num">393</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="393"><span class="line-num">394</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="394"><span class="line-num">395</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="395"><span class="line-num">396</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="396"><span class="line-num">397</span><span class="line-content"><span class="inline-diff">    </span>def u<span class="inline-diff">pd</span>ate_<span class="inline-diff">qu</span>a<span class="inline-diff">nt</span>it<span class="inline-diff">y(</span>s<span class="inline-diff">elf, new_quantity</span>):</span></div>
<div class="line chunk-replace" data-line="397"><span class="line-num">398</span><span class="line-content">     <span class="inline-diff">   if new_quantity &lt;</span>= 0<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="398"><span class="line-num">399</span><span class="line-content">    <span class="inline-diff">        raise ValueErr</span>or<span class="inline-diff">(&quot;Quant</span>it<span class="inline-diff">y</span> <span class="inline-diff">must</span> <span class="inline-diff">be pos</span>it<span class="inline-diff">iv</span>e<span class="inline-diff">&quot;)</span></span></div>
<div class="line chunk-replace" data-line="399"><span class="line-num">400</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.quant</span>it<span class="inline-diff">y = n</span>e<span class="inline-diff">w</span>_<span class="inline-diff">q</span>ua<span class="inline-diff">ntity</span></span></div>
<div class="line chunk-replace" data-line="400"><span class="line-num">401</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="401"><span class="line-num">402</span><span class="line-content">def calculate_total(items, tax_rate=Decimal(&#x27;0.0&#x27;)):</span></div>
<div class="line chunk-replace" data-line="402"><span class="line-num">403</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Calculat</span>e<span class="inline-diff"> total</span> pr<span class="inline-diff">i</span>ce<span class="inline-diff"> inclu</span>d<span class="inline-diff">ing tax&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="403"><span class="line-num">404</span><span class="line-content">    s<span class="inline-diff">ubtotal</span> = <span class="inline-diff">D</span>e<span class="inline-diff">c</span>im<span class="inline-diff">al</span>(<span class="inline-diff">&#x27;0&#x27;</span>)</span></div>
<div class="line " data-line="404"><span class="line-num">405</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="405"><span class="line-num">406</span><span class="line-content">        <span class="inline-diff">sub</span>total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="406"><span class="line-num">407</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="407"><span class="line-num">408</span><span class="line-content">    tax = subtotal * tax_rate</span></div>
<div class="line chunk-replace" data-line="408"><span class="line-num">409</span><span class="line-content"> <span class="inline-diff">   </span>re<span class="inline-diff">tu</span>r<span class="inline-diff">n subt</span>o<span class="inline-diff">tal + tax</span></span></div>
<div class="line chunk-replace" data-line="409"><span class="line-num">410</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="410"><span class="line-num">411</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">apply_discount(</span>total<span class="inline-diff">,</span> <span class="inline-diff">dis</span>c<span class="inline-diff">o</span>u<span class="inline-diff">nt_r</span>ate)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="411"><span class="line-num">412</span><span class="line-content">    &quot;&quot;&quot;Apply discount to total&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="412"><span class="line-num">413</span><span class="line-content">    <span class="inline-diff">return</span> total <span class="inline-diff">*</span> <span class="inline-diff">(Decimal(&#x27;</span>1<span class="inline-diff">&#x27;) - discount_rate)</span></span></div>
<div class="line " data-line="413"><span class="line-num">414</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="414"><span class="line-num">415</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="415"><span class="line-num">416</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="416"><span class="line-num">417</span><span class="line-content">    total = calculate_total(items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="417"><span class="line-num">418</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="418"><span class="line-num">419</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="419"><span class="line-num">420</span><span class="line-content">        <span class="inline-diff">total = apply_</span>discount<span class="inline-diff">(</span>total<span class="inline-diff">,</span> Decimal(&#x27;0.1&#x27;)<span class="inline-diff">)</span></span></div>
<div class="line chunk-replace" data-line="420"><span class="line-num">421</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="421"><span class="line-num">422</span><span class="line-content">    # Apply coupon if available</span></div>
<div class="line chunk-replace" data-line="422"><span class="line-num">423</span><span class="line-content">    <span class="inline-diff">if</span> o<span class="inline-diff">rder.coupon_code:</span></span></div>
<div class="line chunk-replace" data-line="423"><span class="line-num">424</span><span class="line-content">        total = apply_coupon(total, order.coupon_code)</span></div>
<div class="line chunk-replace" data-line="424"><span class="line-num">425</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="425"><span class="line-num">426</span><span class="line-content">    <span class="inline-diff"># Log the or</span>de<span class="inline-diff">r</span></span></div>
<div class="line chunk-replace" data-line="426"><span class="line-num">427</span><span class="line-content">    l<span class="inline-diff">ogger</span>.i<span class="inline-diff">nfo(f&quot;Ord</span>e<span class="inline-diff">r</span> <span class="inline-diff">processed:</span> <span class="inline-diff">${total:.2f}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="427"><span class="line-num">428</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="428"><span class="line-num">429</span><span class="line-content">    return total</span></div>
<div class="line chunk-replace" data-line="429"><span class="line-num">430</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="430"><span class="line-num">431</span><span class="line-content">d<span class="inline-diff">ef apply_</span>c<span class="inline-diff">oupon(</span>t<span class="inline-diff">otal</span>, <span class="inline-diff">co</span>u<span class="inline-diff">po</span>n<span class="inline-diff">_code</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="431"><span class="line-num">432</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;A</span>pp<span class="inline-diff">ly </span>c<span class="inline-diff">oupon d</span>i<span class="inline-diff">scoun</span>t<span class="inline-diff">&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="432"><span class="line-num">433</span><span class="line-content">    # Simple coupon validation</span></div>
<div class="line chunk-replace" data-line="433"><span class="line-num">434</span><span class="line-content">    <span class="inline-diff">i</span>f <span class="inline-diff">c</span>o<span class="inline-diff">u</span>p<span class="inline-diff">on_c</span>od<span class="inline-diff">e == &quot;SAVE10&quot;</span>:</span></div>
<div class="line chunk-replace" data-line="434"><span class="line-num">435</span><span class="line-content">        re<span class="inline-diff">tur</span>n tot<span class="inline-diff">al</span> <span class="inline-diff">*</span> <span class="inline-diff">De</span>ci<span class="inline-diff">mal(&#x27;0.9&#x27;)</span></span></div>
<div class="line " data-line="435"><span class="line-num">436</span><span class="line-content">    return total</span></div>
<div class="line " data-line="436"><span class="line-num">437</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="437"><span class="line-num">438</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="438"><span class="line-num">439</span><span class="line-content">    def __init__(self<span class="inline-diff">, customer=None</span>):</span></div>
<div class="line chunk-replace" data-line="439"><span class="line-num">440</span><span class="line-content">        self.items<span class="inline-diff">: List[CartItem]</span> = []</span></div>
<div class="line chunk-replace" data-line="440"><span class="line-num">441</span><span class="line-content">        self.c<span class="inline-diff">us</span>t<span class="inline-diff">om</span>e<span class="inline-diff">r</span> = <span class="inline-diff">cus</span>t<span class="inline-diff">o</span>me<span class="inline-diff">r</span></span></div>
<div class="line " data-line="441"><span class="line-num">442</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="442"><span class="line-num">443</span><span class="line-content">        self.updated_at = self.created_at</span></div>
<div class="line " data-line="443"><span class="line-num">444</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="444"><span class="line-num">445</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="445"><span class="line-num">446</span><span class="line-content">        if not product.is_available():</span></div>
<div class="line chunk-insert" data-line="446"><span class="line-num">447</span><span class="line-content">            raise ValueError(&quot;Product not available&quot;)</span></div>
<div class="line chunk-insert" data-line="447"><span class="line-num">448</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="448"><span class="line-num">449</span><span class="line-content">        # Check if product already in cart</span></div>
<div class="line chunk-insert" data-line="449"><span class="line-num">450</span><span class="line-content">        for item in self.items:</span></div>
<div class="line chunk-insert" data-line="450"><span class="line-num">451</span><span class="line-content">            if item.product.id == product.id:</span></div>
<div class="line chunk-insert" data-line="451"><span class="line-num">452</span><span class="line-content">                item.update_quantity(item.quantity + quantity)</span></div>
<div class="line chunk-insert" data-line="452"><span class="line-num">453</span><span class="line-content">                self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="453"><span class="line-num">454</span><span class="line-content">                return</span></div>
<div class="line chunk-insert" data-line="454"><span class="line-num">455</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="455"><span class="line-num">456</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="456"><span class="line-num">457</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line chunk-insert" data-line="457"><span class="line-num">458</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="458"><span class="line-num">459</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="459"><span class="line-num">460</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="460"><span class="line-num">461</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line chunk-insert" data-line="461"><span class="line-num">462</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="462"><span class="line-num">463</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="463"><span class="line-num">464</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="464"><span class="line-num">465</span><span class="line-content">        return calculate_total(self.items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="465"><span class="line-num">466</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="466"><span class="line-num">467</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="467"><span class="line-num">468</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-insert" data-line="468"><span class="line-num">469</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="469"><span class="line-num">470</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="470"><span class="line-num">471</span><span class="line-content">    def get_item_count(self):</span></div>
<div class="line chunk-insert" data-line="471"><span class="line-num">472</span><span class="line-content">        return sum(item.quantity for item in self.items)</span></div>
<div class="line " data-line="472"><span class="line-num">473</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="473"><span class="line-num">474</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="474"><span class="line-num">475</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="475"><span class="line-num">476</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="476"><span class="line-num">477</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="477"><span class="line-num">478</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="478"><span class="line-num">479</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line chunk-insert" data-line="479"><span class="line-num">480</span><span class="line-content">        self.coupon_code = None</span></div>
<div class="line chunk-insert" data-line="480"><span class="line-num">481</span><span class="line-content">        self.tracking_number = None</span></div>
<div class="line " data-line="481"><span class="line-num">482</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="482"><span class="line-num">483</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="483"><span class="line-num">484</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="484"><span class="line-num">485</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="485"><span class="line-num">486</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="486"><span class="line-num">487</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="487"><span class="line-num">488</span><span class="line-content">        self.t<span class="inline-diff">racking_nu</span>m<span class="inline-diff">b</span>er<span class="inline-diff"> = self._generate_tracking_number(</span>)</span></div>
<div class="line chunk-replace" data-line="488"><span class="line-num">489</span><span class="line-content">        logger.info(f&quot;Order confirmed for {self.customer.name}&quot;)</span></div>
<div class="line chunk-replace" data-line="489"><span class="line-num">490</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="490"><span class="line-num">491</span><span class="line-content">    def _<span class="inline-diff">generate</span>_<span class="inline-diff">track</span>in<span class="inline-diff">g</span>_<span class="inline-diff">number</span>(self):</span></div>
<div class="line chunk-replace" data-line="491"><span class="line-num">492</span><span class="line-content">        <span class="inline-diff">return f&quot;TRK{</span>self.<span class="inline-diff">order_d</span>a<span class="inline-diff">te.ti</span>me<span class="inline-diff">st</span>am<span class="inline-diff">p()}&quot;</span></span></div>
<div class="line chunk-replace" data-line="492"><span class="line-num">493</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="493"><span class="line-num">494</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">cancel(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="494"><span class="line-num">495</span><span class="line-content">        if self.status == &quot;shipped&quot;:</span></div>
<div class="line chunk-replace" data-line="495"><span class="line-num">496</span><span class="line-content">     <span class="inline-diff">       r</span>a<span class="inline-diff">ise ValueError(&quot;Cannot can</span>ce<span class="inline-diff">l shipped </span>order<span class="inline-diff">&quot;</span>)</span></div>
<div class="line chunk-replace" data-line="496"><span class="line-num">497</span><span class="line-content">        self<span class="inline-diff">.status = &quot;cancelled&quot;</span></span></div>
<div class="line " data-line="497"><span class="line-num">498</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="498"><span class="line-num">499</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="499"><span class="line-num">500</span><span class="line-content">    def __init__(self, name, email<span class="inline-diff">, phone=&quot;&quot;</span>):</span></div>
<div class="line " data-line="500"><span class="line-num">501</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="501"><span class="line-num">502</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="502"><span class="line-num">503</span><span class="line-content">        self.<span class="inline-diff">ph</span>o<span class="inline-diff">n</span>e = <span class="inline-diff">phone</span></span></div>
<div class="line chunk-replace" data-line="503"><span class="line-num">504</span><span class="line-content">        self.orders: List[Order] = []</span></div>
<div class="line chunk-replace" data-line="504"><span class="line-num">505</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.loy</span>a<span class="inline-diff">l</span>t<span class="inline-diff">y_points = 0</span></span></div>
<div class="line " data-line="505"><span class="line-num">506</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="506"><span class="line-num">507</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line chunk-insert" data-line="507"><span class="line-num">508</span><span class="line-content">        if not self.email:</span></div>
<div class="line chunk-insert" data-line="508"><span class="line-num">509</span><span class="line-content">            raise ValueError(&quot;Customer email required&quot;)</span></div>
<div class="line " data-line="509"><span class="line-num">510</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="510"><span class="line-num">511</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="511"><span class="line-num">512</span><span class="line-content">        return order</span></div>
<div class="line " data-line="512"><span class="line-num">513</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="513"><span class="line-num">514</span><span class="line-content">    def add_loyalty_points(self, points):</span></div>
<div class="line chunk-insert" data-line="514"><span class="line-num">515</span><span class="line-content">        self.loyalty_points += points</span></div>
<div class="line chunk-insert" data-line="515"><span class="line-num">516</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="516"><span class="line-num">517</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="517"><span class="line-num">518</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="518"><span class="line-num">519</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="519"><span class="line-num">520</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="520"><span class="line-num">521</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="521"><span class="line-num">522</span><span class="line-content">    i<span class="inline-diff">f </span>n<span class="inline-diff">ot</span> email<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="522"><span class="line-num">523</span><span class="line-content">        return False</span></div>
<div class="line chunk-replace" data-line="523"><span class="line-num">524</span><span class="line-content">    r<span class="inline-diff">etur</span>n <span class="inline-diff">&quot;@&quot; in email and &quot;</span>.<span class="inline-diff">&quot; in email and len(email) &gt; 5</span></span></div>
<div class="line chunk-replace" data-line="524"><span class="line-num">525</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="525"><span class="line-num">526</span><span class="line-content">def send_confirmation_email(customer, order):</span></div>
<div class="line chunk-replace" data-line="526"><span class="line-num">527</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Send </span>ord<span class="inline-diff">er confirm</span>ati<span class="inline-diff">on </span>e<span class="inline-diff">mail&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="527"><span class="line-num">528</span><span class="line-content"><span class="inline-diff">   </span> logg<span class="inline-diff">er.info(f&quot;Send</span>ing<span class="inline-diff"> confirmation to {customer.email}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="528"><span class="line-num">529</span><span class="line-content"> <span class="inline-diff">   # E</span>ma<span class="inline-diff">i</span>l <span class="inline-diff">s</span>e<span class="inline-diff">nd</span>i<span class="inline-diff">ng </span>l<span class="inline-diff">ogic here</span></span></div>
<div class="line chunk-replace" data-line="529"><span class="line-num">530</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="530"><span class="line-num">531</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="531"><span class="line-num">532</span><span class="line-content"># E-commerce System - Version 2.0</span></div>
<div class="line chunk-replace" data-line="532"><span class="line-num">533</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">Enhan</span>c<span class="inline-diff">ed implemen</span>t<span class="inline-diff">ation with tax, discounts, and better validation</span></span></div>
<div class="line " data-line="533"><span class="line-num">534</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="534"><span class="line-num">535</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="535"><span class="line-num">536</span><span class="line-content">import logging</span></div>
<div class="line " data-line="536"><span class="line-num">537</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line chunk-insert" data-line="537"><span class="line-num">538</span><span class="line-content">from typing import List, Optional</span></div>
<div class="line " data-line="538"><span class="line-num">539</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="539"><span class="line-num">540</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="540"><span class="line-num">541</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="541"><span class="line-num">542</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="542"><span class="line-num">543</span><span class="line-content">    def __init__(self, id, name, price, category<span class="inline-diff">, description=&quot;&quot;</span>):</span></div>
<div class="line " data-line="543"><span class="line-num">544</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="544"><span class="line-num">545</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="545"><span class="line-num">546</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="546"><span class="line-num">547</span><span class="line-content">        self.category = category</span></div>
<div class="line chunk-insert" data-line="547"><span class="line-num">548</span><span class="line-content">        self.description = description</span></div>
<div class="line " data-line="548"><span class="line-num">549</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-insert" data-line="549"><span class="line-num">550</span><span class="line-content">        self.sku = f&quot;SKU-{id}&quot;</span></div>
<div class="line " data-line="550"><span class="line-num">551</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="551"><span class="line-num">552</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line chunk-insert" data-line="552"><span class="line-num">553</span><span class="line-content">        if self.stock + quantity &lt; 0:</span></div>
<div class="line chunk-insert" data-line="553"><span class="line-num">554</span><span class="line-content">            raise ValueError(&quot;Insufficient stock&quot;)</span></div>
<div class="line " data-line="554"><span class="line-num">555</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="555"><span class="line-num">556</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="556"><span class="line-num">557</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="557"><span class="line-num">558</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="558"><span class="line-num">559</span><span class="line-content">        return f&quot;{self.name} <span class="inline-diff">({self.sku}) </span>- ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="559"><span class="line-num">560</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="560"><span class="line-num">561</span><span class="line-content"><span class="inline-diff">    def is_avai</span>la<span class="inline-diff">bl</span>e<span class="inline-diff">(self)</span>:</span></div>
<div class="line chunk-replace" data-line="561"><span class="line-num">562</span><span class="line-content">     <span class="inline-diff">   re</span>t<span class="inline-diff">urn </span>self<span class="inline-diff">.s</span>t<span class="inline-diff">ock</span> <span class="inline-diff">&gt; 0</span></span></div>
<div class="line " data-line="562"><span class="line-num">563</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="563"><span class="line-num">564</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="564"><span class="line-num">565</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="565"><span class="line-num">566</span><span class="line-content">        if quantity &lt;= 0:</span></div>
<div class="line chunk-insert" data-line="566"><span class="line-num">567</span><span class="line-content">            raise ValueError(&quot;Quantity must be positive&quot;)</span></div>
<div class="line " data-line="567"><span class="line-num">568</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="568"><span class="line-num">569</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="569"><span class="line-num">570</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="570"><span class="line-num">571</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="571"><span class="line-num">572</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="572"><span class="line-num">573</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="573"><span class="line-num">574</span><span class="line-content"><span class="inline-diff">    </span>def u<span class="inline-diff">pd</span>ate_<span class="inline-diff">qu</span>a<span class="inline-diff">nt</span>it<span class="inline-diff">y(</span>s<span class="inline-diff">elf, new_quantity</span>):</span></div>
<div class="line chunk-replace" data-line="574"><span class="line-num">575</span><span class="line-content">     <span class="inline-diff">   if new_quantity &lt;</span>= 0<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="575"><span class="line-num">576</span><span class="line-content">    <span class="inline-diff">        raise ValueErr</span>or<span class="inline-diff">(&quot;Quant</span>it<span class="inline-diff">y</span> <span class="inline-diff">must</span> <span class="inline-diff">be pos</span>it<span class="inline-diff">iv</span>e<span class="inline-diff">&quot;)</span></span></div>
<div class="line chunk-replace" data-line="576"><span class="line-num">577</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.quant</span>it<span class="inline-diff">y = n</span>e<span class="inline-diff">w</span>_<span class="inline-diff">q</span>ua<span class="inline-diff">ntity</span></span></div>
<div class="line chunk-replace" data-line="577"><span class="line-num">578</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="578"><span class="line-num">579</span><span class="line-content">def calculate_total(items, tax_rate=Decimal(&#x27;0.0&#x27;)):</span></div>
<div class="line chunk-replace" data-line="579"><span class="line-num">580</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Calculat</span>e<span class="inline-diff"> total</span> pr<span class="inline-diff">i</span>ce<span class="inline-diff"> inclu</span>d<span class="inline-diff">ing tax&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="580"><span class="line-num">581</span><span class="line-content">    s<span class="inline-diff">ubtotal</span> = <span class="inline-diff">D</span>e<span class="inline-diff">c</span>im<span class="inline-diff">al</span>(<span class="inline-diff">&#x27;0&#x27;</span>)</span></div>
<div class="line " data-line="581"><span class="line-num">582</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="582"><span class="line-num">583</span><span class="line-content">        <span class="inline-diff">sub</span>total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="583"><span class="line-num">584</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="584"><span class="line-num">585</span><span class="line-content">    tax = subtotal * tax_rate</span></div>
<div class="line chunk-replace" data-line="585"><span class="line-num">586</span><span class="line-content"> <span class="inline-diff">   </span>re<span class="inline-diff">tu</span>r<span class="inline-diff">n subt</span>o<span class="inline-diff">tal + tax</span></span></div>
<div class="line chunk-replace" data-line="586"><span class="line-num">587</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="587"><span class="line-num">588</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">apply_discount(</span>total<span class="inline-diff">,</span> <span class="inline-diff">dis</span>c<span class="inline-diff">o</span>u<span class="inline-diff">nt_r</span>ate)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="588"><span class="line-num">589</span><span class="line-content">    &quot;&quot;&quot;Apply discount to total&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="589"><span class="line-num">590</span><span class="line-content">    <span class="inline-diff">return</span> total <span class="inline-diff">*</span> <span class="inline-diff">(Decimal(&#x27;</span>1<span class="inline-diff">&#x27;) - discount_rate)</span></span></div>
<div class="line " data-line="590"><span class="line-num">591</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="591"><span class="line-num">592</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="592"><span class="line-num">593</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="593"><span class="line-num">594</span><span class="line-content">    total = calculate_total(items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="594"><span class="line-num">595</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="595"><span class="line-num">596</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="596"><span class="line-num">597</span><span class="line-content">        <span class="inline-diff">total = apply_</span>discount<span class="inline-diff">(</span>total<span class="inline-diff">,</span> Decimal(&#x27;0.1&#x27;)<span class="inline-diff">)</span></span></div>
<div class="line chunk-replace" data-line="597"><span class="line-num">598</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="598"><span class="line-num">599</span><span class="line-content">    # Apply coupon if available</span></div>
<div class="line chunk-replace" data-line="599"><span class="line-num">600</span><span class="line-content">    <span class="inline-diff">if</span> o<span class="inline-diff">rder.coupon_code:</span></span></div>
<div class="line chunk-replace" data-line="600"><span class="line-num">601</span><span class="line-content">        total = apply_coupon(total, order.coupon_code)</span></div>
<div class="line chunk-replace" data-line="601"><span class="line-num">602</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="602"><span class="line-num">603</span><span class="line-content">    <span class="inline-diff"># Log the or</span>de<span class="inline-diff">r</span></span></div>
<div class="line chunk-replace" data-line="603"><span class="line-num">604</span><span class="line-content">    l<span class="inline-diff">ogger</span>.i<span class="inline-diff">nfo(f&quot;Ord</span>e<span class="inline-diff">r</span> <span class="inline-diff">processed:</span> <span class="inline-diff">${total:.2f}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="604"><span class="line-num">605</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="605"><span class="line-num">606</span><span class="line-content">    return total</span></div>
<div class="line chunk-replace" data-line="606"><span class="line-num">607</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="607"><span class="line-num">608</span><span class="line-content">d<span class="inline-diff">ef apply_</span>c<span class="inline-diff">oupon(</span>t<span class="inline-diff">otal</span>, <span class="inline-diff">co</span>u<span class="inline-diff">po</span>n<span class="inline-diff">_code</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="608"><span class="line-num">609</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;A</span>pp<span class="inline-diff">ly </span>c<span class="inline-diff">oupon d</span>i<span class="inline-diff">scoun</span>t<span class="inline-diff">&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="609"><span class="line-num">610</span><span class="line-content">    # Simple coupon validation</span></div>
<div class="line chunk-replace" data-line="610"><span class="line-num">611</span><span class="line-content">    <span class="inline-diff">i</span>f <span class="inline-diff">c</span>o<span class="inline-diff">u</span>p<span class="inline-diff">on_c</span>od<span class="inline-diff">e == &quot;SAVE10&quot;</span>:</span></div>
<div class="line chunk-replace" data-line="611"><span class="line-num">612</span><span class="line-content">        re<span class="inline-diff">tur</span>n tot<span class="inline-diff">al</span> <span class="inline-diff">*</span> <span class="inline-diff">De</span>ci<span class="inline-diff">mal(&#x27;0.9&#x27;)</span></span></div>
<div class="line " data-line="612"><span class="line-num">613</span><span class="line-content">    return total</span></div>
<div class="line " data-line="613"><span class="line-num">614</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="614"><span class="line-num">615</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="615"><span class="line-num">616</span><span class="line-content">    def __init__(self<span class="inline-diff">, customer=None</span>):</span></div>
<div class="line chunk-replace" data-line="616"><span class="line-num">617</span><span class="line-content">        self.items<span class="inline-diff">: List[CartItem]</span> = []</span></div>
<div class="line chunk-replace" data-line="617"><span class="line-num">618</span><span class="line-content">        self.c<span class="inline-diff">us</span>t<span class="inline-diff">om</span>e<span class="inline-diff">r</span> = <span class="inline-diff">cus</span>t<span class="inline-diff">o</span>me<span class="inline-diff">r</span></span></div>
<div class="line " data-line="618"><span class="line-num">619</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="619"><span class="line-num">620</span><span class="line-content">        self.updated_at = self.created_at</span></div>
<div class="line " data-line="620"><span class="line-num">621</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="621"><span class="line-num">622</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="622"><span class="line-num">623</span><span class="line-content">        if not product.is_available():</span></div>
<div class="line chunk-insert" data-line="623"><span class="line-num">624</span><span class="line-content">            raise ValueError(&quot;Product not available&quot;)</span></div>
<div class="line chunk-insert" data-line="624"><span class="line-num">625</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="625"><span class="line-num">626</span><span class="line-content">        # Check if product already in cart</span></div>
<div class="line chunk-insert" data-line="626"><span class="line-num">627</span><span class="line-content">        for item in self.items:</span></div>
<div class="line chunk-insert" data-line="627"><span class="line-num">628</span><span class="line-content">            if item.product.id == product.id:</span></div>
<div class="line chunk-insert" data-line="628"><span class="line-num">629</span><span class="line-content">                item.update_quantity(item.quantity + quantity)</span></div>
<div class="line chunk-insert" data-line="629"><span class="line-num">630</span><span class="line-content">                self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="630"><span class="line-num">631</span><span class="line-content">                return</span></div>
<div class="line chunk-insert" data-line="631"><span class="line-num">632</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="632"><span class="line-num">633</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="633"><span class="line-num">634</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line chunk-insert" data-line="634"><span class="line-num">635</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="635"><span class="line-num">636</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="636"><span class="line-num">637</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="637"><span class="line-num">638</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line chunk-insert" data-line="638"><span class="line-num">639</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="639"><span class="line-num">640</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="640"><span class="line-num">641</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="641"><span class="line-num">642</span><span class="line-content">        return calculate_total(self.items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="642"><span class="line-num">643</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="643"><span class="line-num">644</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="644"><span class="line-num">645</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-insert" data-line="645"><span class="line-num">646</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="646"><span class="line-num">647</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="647"><span class="line-num">648</span><span class="line-content">    def get_item_count(self):</span></div>
<div class="line chunk-insert" data-line="648"><span class="line-num">649</span><span class="line-content">        return sum(item.quantity for item in self.items)</span></div>
<div class="line " data-line="649"><span class="line-num">650</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="650"><span class="line-num">651</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="651"><span class="line-num">652</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="652"><span class="line-num">653</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="653"><span class="line-num">654</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="654"><span class="line-num">655</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="655"><span class="line-num">656</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line chunk-insert" data-line="656"><span class="line-num">657</span><span class="line-content">        self.coupon_code = None</span></div>
<div class="line chunk-insert" data-line="657"><span class="line-num">658</span><span class="line-content">        self.tracking_number = None</span></div>
<div class="line " data-line="658"><span class="line-num">659</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="659"><span class="line-num">660</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="660"><span class="line-num">661</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="661"><span class="line-num">662</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="662"><span class="line-num">663</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="663"><span class="line-num">664</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="664"><span class="line-num">665</span><span class="line-content">        self.t<span class="inline-diff">racking_nu</span>m<span class="inline-diff">b</span>er<span class="inline-diff"> = self._generate_tracking_number(</span>)</span></div>
<div class="line chunk-replace" data-line="665"><span class="line-num">666</span><span class="line-content">        logger.info(f&quot;Order confirmed for {self.customer.name}&quot;)</span></div>
<div class="line chunk-replace" data-line="666"><span class="line-num">667</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="667"><span class="line-num">668</span><span class="line-content">    def _<span class="inline-diff">generate</span>_<span class="inline-diff">track</span>in<span class="inline-diff">g</span>_<span class="inline-diff">number</span>(self):</span></div>
<div class="line chunk-replace" data-line="668"><span class="line-num">669</span><span class="line-content">        <span class="inline-diff">return f&quot;TRK{</span>self.<span class="inline-diff">order_d</span>a<span class="inline-diff">te.ti</span>me<span class="inline-diff">st</span>am<span class="inline-diff">p()}&quot;</span></span></div>
<div class="line chunk-replace" data-line="669"><span class="line-num">670</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="670"><span class="line-num">671</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">cancel(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="671"><span class="line-num">672</span><span class="line-content">        if self.status == &quot;shipped&quot;:</span></div>
<div class="line chunk-replace" data-line="672"><span class="line-num">673</span><span class="line-content">     <span class="inline-diff">       r</span>a<span class="inline-diff">ise ValueError(&quot;Cannot can</span>ce<span class="inline-diff">l shipped </span>order<span class="inline-diff">&quot;</span>)</span></div>
<div class="line chunk-replace" data-line="673"><span class="line-num">674</span><span class="line-content">        self<span class="inline-diff">.status = &quot;cancelled&quot;</span></span></div>
<div class="line " data-line="674"><span class="line-num">675</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="675"><span class="line-num">676</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="676"><span class="line-num">677</span><span class="line-content">    def __init__(self, name, email<span class="inline-diff">, phone=&quot;&quot;</span>):</span></div>
<div class="line " data-line="677"><span class="line-num">678</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="678"><span class="line-num">679</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="679"><span class="line-num">680</span><span class="line-content">        self.<span class="inline-diff">ph</span>o<span class="inline-diff">n</span>e = <span class="inline-diff">phone</span></span></div>
<div class="line chunk-replace" data-line="680"><span class="line-num">681</span><span class="line-content">        self.orders: List[Order] = []</span></div>
<div class="line chunk-replace" data-line="681"><span class="line-num">682</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.loy</span>a<span class="inline-diff">l</span>t<span class="inline-diff">y_points = 0</span></span></div>
<div class="line " data-line="682"><span class="line-num">683</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="683"><span class="line-num">684</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line chunk-insert" data-line="684"><span class="line-num">685</span><span class="line-content">        if not self.email:</span></div>
<div class="line chunk-insert" data-line="685"><span class="line-num">686</span><span class="line-content">            raise ValueError(&quot;Customer email required&quot;)</span></div>
<div class="line " data-line="686"><span class="line-num">687</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="687"><span class="line-num">688</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="688"><span class="line-num">689</span><span class="line-content">        return order</span></div>
<div class="line " data-line="689"><span class="line-num">690</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="690"><span class="line-num">691</span><span class="line-content">    def add_loyalty_points(self, points):</span></div>
<div class="line chunk-insert" data-line="691"><span class="line-num">692</span><span class="line-content">        self.loyalty_points += points</span></div>
<div class="line chunk-insert" data-line="692"><span class="line-num">693</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="693"><span class="line-num">694</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="694"><span class="line-num">695</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="695"><span class="line-num">696</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="696"><span class="line-num">697</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="697"><span class="line-num">698</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="698"><span class="line-num">699</span><span class="line-content">    i<span class="inline-diff">f </span>n<span class="inline-diff">ot</span> email<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="699"><span class="line-num">700</span><span class="line-content">        return False</span></div>
<div class="line chunk-replace" data-line="700"><span class="line-num">701</span><span class="line-content">    r<span class="inline-diff">etur</span>n <span class="inline-diff">&quot;@&quot; in email and &quot;</span>.<span class="inline-diff">&quot; in email and len(email) &gt; 5</span></span></div>
<div class="line chunk-replace" data-line="701"><span class="line-num">702</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="702"><span class="line-num">703</span><span class="line-content">def send_confirmation_email(customer, order):</span></div>
<div class="line chunk-replace" data-line="703"><span class="line-num">704</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Send </span>ord<span class="inline-diff">er confirm</span>ati<span class="inline-diff">on </span>e<span class="inline-diff">mail&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="704"><span class="line-num">705</span><span class="line-content"><span class="inline-diff">   </span> logg<span class="inline-diff">er.info(f&quot;Send</span>ing<span class="inline-diff"> confirmation to {customer.email}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="705"><span class="line-num">706</span><span class="line-content"> <span class="inline-diff">   # E</span>ma<span class="inline-diff">i</span>l <span class="inline-diff">s</span>e<span class="inline-diff">nd</span>i<span class="inline-diff">ng </span>l<span class="inline-diff">ogic here</span></span></div>
<div class="line chunk-replace" data-line="706"><span class="line-num">707</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="707"><span class="line-num">708</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="708"><span class="line-num">709</span><span class="line-content"># E-commerce System - Version 2.0</span></div>
<div class="line chunk-replace" data-line="709"><span class="line-num">710</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">Enhan</span>c<span class="inline-diff">ed implemen</span>t<span class="inline-diff">ation with tax, discounts, and better validation</span></span></div>
<div class="line " data-line="710"><span class="line-num">711</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="711"><span class="line-num">712</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="712"><span class="line-num">713</span><span class="line-content">import logging</span></div>
<div class="line " data-line="713"><span class="line-num">714</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line chunk-insert" data-line="714"><span class="line-num">715</span><span class="line-content">from typing import List, Optional</span></div>
<div class="line " data-line="715"><span class="line-num">716</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="716"><span class="line-num">717</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="717"><span class="line-num">718</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="718"><span class="line-num">719</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="719"><span class="line-num">720</span><span class="line-content">    def __init__(self, id, name, price, category<span class="inline-diff">, description=&quot;&quot;</span>):</span></div>
<div class="line " data-line="720"><span class="line-num">721</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="721"><span class="line-num">722</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="722"><span class="line-num">723</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="723"><span class="line-num">724</span><span class="line-content">        self.category = category</span></div>
<div class="line chunk-insert" data-line="724"><span class="line-num">725</span><span class="line-content">        self.description = description</span></div>
<div class="line " data-line="725"><span class="line-num">726</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-insert" data-line="726"><span class="line-num">727</span><span class="line-content">        self.sku = f&quot;SKU-{id}&quot;</span></div>
<div class="line " data-line="727"><span class="line-num">728</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="728"><span class="line-num">729</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line chunk-insert" data-line="729"><span class="line-num">730</span><span class="line-content">        if self.stock + quantity &lt; 0:</span></div>
<div class="line chunk-insert" data-line="730"><span class="line-num">731</span><span class="line-content">            raise ValueError(&quot;Insufficient stock&quot;)</span></div>
<div class="line " data-line="731"><span class="line-num">732</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="732"><span class="line-num">733</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="733"><span class="line-num">734</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="734"><span class="line-num">735</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="735"><span class="line-num">736</span><span class="line-content">        return f&quot;{self.name} <span class="inline-diff">({self.sku}) </span>- ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="736"><span class="line-num">737</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="737"><span class="line-num">738</span><span class="line-content"><span class="inline-diff">    def is_avai</span>la<span class="inline-diff">bl</span>e<span class="inline-diff">(self)</span>:</span></div>
<div class="line chunk-replace" data-line="738"><span class="line-num">739</span><span class="line-content">     <span class="inline-diff">   re</span>t<span class="inline-diff">urn </span>self<span class="inline-diff">.s</span>t<span class="inline-diff">ock</span> <span class="inline-diff">&gt; 0</span></span></div>
<div class="line " data-line="739"><span class="line-num">740</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="740"><span class="line-num">741</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="741"><span class="line-num">742</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="742"><span class="line-num">743</span><span class="line-content">        if quantity &lt;= 0:</span></div>
<div class="line chunk-insert" data-line="743"><span class="line-num">744</span><span class="line-content">            raise ValueError(&quot;Quantity must be positive&quot;)</span></div>
<div class="line " data-line="744"><span class="line-num">745</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="745"><span class="line-num">746</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="746"><span class="line-num">747</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="747"><span class="line-num">748</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="748"><span class="line-num">749</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="749"><span class="line-num">750</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="750"><span class="line-num">751</span><span class="line-content"><span class="inline-diff">    </span>def u<span class="inline-diff">pd</span>ate_<span class="inline-diff">qu</span>a<span class="inline-diff">nt</span>it<span class="inline-diff">y(</span>s<span class="inline-diff">elf, new_quantity</span>):</span></div>
<div class="line chunk-replace" data-line="751"><span class="line-num">752</span><span class="line-content">     <span class="inline-diff">   if new_quantity &lt;</span>= 0<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="752"><span class="line-num">753</span><span class="line-content">    <span class="inline-diff">        raise ValueErr</span>or<span class="inline-diff">(&quot;Quant</span>it<span class="inline-diff">y</span> <span class="inline-diff">must</span> <span class="inline-diff">be pos</span>it<span class="inline-diff">iv</span>e<span class="inline-diff">&quot;)</span></span></div>
<div class="line chunk-replace" data-line="753"><span class="line-num">754</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.quant</span>it<span class="inline-diff">y = n</span>e<span class="inline-diff">w</span>_<span class="inline-diff">q</span>ua<span class="inline-diff">ntity</span></span></div>
<div class="line chunk-replace" data-line="754"><span class="line-num">755</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="755"><span class="line-num">756</span><span class="line-content">def calculate_total(items, tax_rate=Decimal(&#x27;0.0&#x27;)):</span></div>
<div class="line chunk-replace" data-line="756"><span class="line-num">757</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Calculat</span>e<span class="inline-diff"> total</span> pr<span class="inline-diff">i</span>ce<span class="inline-diff"> inclu</span>d<span class="inline-diff">ing tax&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="757"><span class="line-num">758</span><span class="line-content">    s<span class="inline-diff">ubtotal</span> = <span class="inline-diff">D</span>e<span class="inline-diff">c</span>im<span class="inline-diff">al</span>(<span class="inline-diff">&#x27;0&#x27;</span>)</span></div>
<div class="line " data-line="758"><span class="line-num">759</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="759"><span class="line-num">760</span><span class="line-content">        <span class="inline-diff">sub</span>total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="760"><span class="line-num">761</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="761"><span class="line-num">762</span><span class="line-content">    tax = subtotal * tax_rate</span></div>
<div class="line chunk-replace" data-line="762"><span class="line-num">763</span><span class="line-content"> <span class="inline-diff">   </span>re<span class="inline-diff">tu</span>r<span class="inline-diff">n subt</span>o<span class="inline-diff">tal + tax</span></span></div>
<div class="line chunk-replace" data-line="763"><span class="line-num">764</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="764"><span class="line-num">765</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">apply_discount(</span>total<span class="inline-diff">,</span> <span class="inline-diff">dis</span>c<span class="inline-diff">o</span>u<span class="inline-diff">nt_r</span>ate)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="765"><span class="line-num">766</span><span class="line-content">    &quot;&quot;&quot;Apply discount to total&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="766"><span class="line-num">767</span><span class="line-content">    <span class="inline-diff">return</span> total <span class="inline-diff">*</span> <span class="inline-diff">(Decimal(&#x27;</span>1<span class="inline-diff">&#x27;) - discount_rate)</span></span></div>
<div class="line " data-line="767"><span class="line-num">768</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="768"><span class="line-num">769</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="769"><span class="line-num">770</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="770"><span class="line-num">771</span><span class="line-content">    total = calculate_total(items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="771"><span class="line-num">772</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="772"><span class="line-num">773</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="773"><span class="line-num">774</span><span class="line-content">        <span class="inline-diff">total = apply_</span>discount<span class="inline-diff">(</span>total<span class="inline-diff">,</span> Decimal(&#x27;0.1&#x27;)<span class="inline-diff">)</span></span></div>
<div class="line chunk-replace" data-line="774"><span class="line-num">775</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="775"><span class="line-num">776</span><span class="line-content">    # Apply coupon if available</span></div>
<div class="line chunk-replace" data-line="776"><span class="line-num">777</span><span class="line-content">    <span class="inline-diff">if</span> o<span class="inline-diff">rder.coupon_code:</span></span></div>
<div class="line chunk-replace" data-line="777"><span class="line-num">778</span><span class="line-content">        total = apply_coupon(total, order.coupon_code)</span></div>
<div class="line chunk-replace" data-line="778"><span class="line-num">779</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="779"><span class="line-num">780</span><span class="line-content">    <span class="inline-diff"># Log the or</span>de<span class="inline-diff">r</span></span></div>
<div class="line chunk-replace" data-line="780"><span class="line-num">781</span><span class="line-content">    l<span class="inline-diff">ogger</span>.i<span class="inline-diff">nfo(f&quot;Ord</span>e<span class="inline-diff">r</span> <span class="inline-diff">processed:</span> <span class="inline-diff">${total:.2f}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="781"><span class="line-num">782</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="782"><span class="line-num">783</span><span class="line-content">    return total</span></div>
<div class="line chunk-replace" data-line="783"><span class="line-num">784</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="784"><span class="line-num">785</span><span class="line-content">d<span class="inline-diff">ef apply_</span>c<span class="inline-diff">oupon(</span>t<span class="inline-diff">otal</span>, <span class="inline-diff">co</span>u<span class="inline-diff">po</span>n<span class="inline-diff">_code</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="785"><span class="line-num">786</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;A</span>pp<span class="inline-diff">ly </span>c<span class="inline-diff">oupon d</span>i<span class="inline-diff">scoun</span>t<span class="inline-diff">&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="786"><span class="line-num">787</span><span class="line-content">    # Simple coupon validation</span></div>
<div class="line chunk-replace" data-line="787"><span class="line-num">788</span><span class="line-content">    <span class="inline-diff">i</span>f <span class="inline-diff">c</span>o<span class="inline-diff">u</span>p<span class="inline-diff">on_c</span>od<span class="inline-diff">e == &quot;SAVE10&quot;</span>:</span></div>
<div class="line chunk-replace" data-line="788"><span class="line-num">789</span><span class="line-content">        re<span class="inline-diff">tur</span>n tot<span class="inline-diff">al</span> <span class="inline-diff">*</span> <span class="inline-diff">De</span>ci<span class="inline-diff">mal(&#x27;0.9&#x27;)</span></span></div>
<div class="line " data-line="789"><span class="line-num">790</span><span class="line-content">    return total</span></div>
<div class="line " data-line="790"><span class="line-num">791</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="791"><span class="line-num">792</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="792"><span class="line-num">793</span><span class="line-content">    def __init__(self<span class="inline-diff">, customer=None</span>):</span></div>
<div class="line chunk-replace" data-line="793"><span class="line-num">794</span><span class="line-content">        self.items<span class="inline-diff">: List[CartItem]</span> = []</span></div>
<div class="line chunk-replace" data-line="794"><span class="line-num">795</span><span class="line-content">        self.c<span class="inline-diff">us</span>t<span class="inline-diff">om</span>e<span class="inline-diff">r</span> = <span class="inline-diff">cus</span>t<span class="inline-diff">o</span>me<span class="inline-diff">r</span></span></div>
<div class="line " data-line="795"><span class="line-num">796</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="796"><span class="line-num">797</span><span class="line-content">        self.updated_at = self.created_at</span></div>
<div class="line " data-line="797"><span class="line-num">798</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="798"><span class="line-num">799</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="799"><span class="line-num">800</span><span class="line-content">        if not product.is_available():</span></div>
<div class="line chunk-insert" data-line="800"><span class="line-num">801</span><span class="line-content">            raise ValueError(&quot;Product not available&quot;)</span></div>
<div class="line chunk-insert" data-line="801"><span class="line-num">802</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="802"><span class="line-num">803</span><span class="line-content">        # Check if product already in cart</span></div>
<div class="line chunk-insert" data-line="803"><span class="line-num">804</span><span class="line-content">        for item in self.items:</span></div>
<div class="line chunk-insert" data-line="804"><span class="line-num">805</span><span class="line-content">            if item.product.id == product.id:</span></div>
<div class="line chunk-insert" data-line="805"><span class="line-num">806</span><span class="line-content">                item.update_quantity(item.quantity + quantity)</span></div>
<div class="line chunk-insert" data-line="806"><span class="line-num">807</span><span class="line-content">                self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="807"><span class="line-num">808</span><span class="line-content">                return</span></div>
<div class="line chunk-insert" data-line="808"><span class="line-num">809</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="809"><span class="line-num">810</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="810"><span class="line-num">811</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line chunk-insert" data-line="811"><span class="line-num">812</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="812"><span class="line-num">813</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="813"><span class="line-num">814</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="814"><span class="line-num">815</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line chunk-insert" data-line="815"><span class="line-num">816</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="816"><span class="line-num">817</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="817"><span class="line-num">818</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="818"><span class="line-num">819</span><span class="line-content">        return calculate_total(self.items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="819"><span class="line-num">820</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="820"><span class="line-num">821</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="821"><span class="line-num">822</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-insert" data-line="822"><span class="line-num">823</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="823"><span class="line-num">824</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="824"><span class="line-num">825</span><span class="line-content">    def get_item_count(self):</span></div>
<div class="line chunk-insert" data-line="825"><span class="line-num">826</span><span class="line-content">        return sum(item.quantity for item in self.items)</span></div>
<div class="line " data-line="826"><span class="line-num">827</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="827"><span class="line-num">828</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="828"><span class="line-num">829</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="829"><span class="line-num">830</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="830"><span class="line-num">831</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="831"><span class="line-num">832</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="832"><span class="line-num">833</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line chunk-insert" data-line="833"><span class="line-num">834</span><span class="line-content">        self.coupon_code = None</span></div>
<div class="line chunk-insert" data-line="834"><span class="line-num">835</span><span class="line-content">        self.tracking_number = None</span></div>
<div class="line " data-line="835"><span class="line-num">836</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="836"><span class="line-num">837</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="837"><span class="line-num">838</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="838"><span class="line-num">839</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="839"><span class="line-num">840</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="840"><span class="line-num">841</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="841"><span class="line-num">842</span><span class="line-content">        self.t<span class="inline-diff">racking_nu</span>m<span class="inline-diff">b</span>er<span class="inline-diff"> = self._generate_tracking_number(</span>)</span></div>
<div class="line chunk-replace" data-line="842"><span class="line-num">843</span><span class="line-content">        logger.info(f&quot;Order confirmed for {self.customer.name}&quot;)</span></div>
<div class="line chunk-replace" data-line="843"><span class="line-num">844</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="844"><span class="line-num">845</span><span class="line-content">    def _<span class="inline-diff">generate</span>_<span class="inline-diff">track</span>in<span class="inline-diff">g</span>_<span class="inline-diff">number</span>(self):</span></div>
<div class="line chunk-replace" data-line="845"><span class="line-num">846</span><span class="line-content">        <span class="inline-diff">return f&quot;TRK{</span>self.<span class="inline-diff">order_d</span>a<span class="inline-diff">te.ti</span>me<span class="inline-diff">st</span>am<span class="inline-diff">p()}&quot;</span></span></div>
<div class="line chunk-replace" data-line="846"><span class="line-num">847</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="847"><span class="line-num">848</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">cancel(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="848"><span class="line-num">849</span><span class="line-content">        if self.status == &quot;shipped&quot;:</span></div>
<div class="line chunk-replace" data-line="849"><span class="line-num">850</span><span class="line-content">     <span class="inline-diff">       r</span>a<span class="inline-diff">ise ValueError(&quot;Cannot can</span>ce<span class="inline-diff">l shipped </span>order<span class="inline-diff">&quot;</span>)</span></div>
<div class="line chunk-replace" data-line="850"><span class="line-num">851</span><span class="line-content">        self<span class="inline-diff">.status = &quot;cancelled&quot;</span></span></div>
<div class="line " data-line="851"><span class="line-num">852</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="852"><span class="line-num">853</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="853"><span class="line-num">854</span><span class="line-content">    def __init__(self, name, email<span class="inline-diff">, phone=&quot;&quot;</span>):</span></div>
<div class="line " data-line="854"><span class="line-num">855</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="855"><span class="line-num">856</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="856"><span class="line-num">857</span><span class="line-content">        self.<span class="inline-diff">ph</span>o<span class="inline-diff">n</span>e = <span class="inline-diff">phone</span></span></div>
<div class="line chunk-replace" data-line="857"><span class="line-num">858</span><span class="line-content">        self.orders: List[Order] = []</span></div>
<div class="line chunk-replace" data-line="858"><span class="line-num">859</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.loy</span>a<span class="inline-diff">l</span>t<span class="inline-diff">y_points = 0</span></span></div>
<div class="line " data-line="859"><span class="line-num">860</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="860"><span class="line-num">861</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line chunk-insert" data-line="861"><span class="line-num">862</span><span class="line-content">        if not self.email:</span></div>
<div class="line chunk-insert" data-line="862"><span class="line-num">863</span><span class="line-content">            raise ValueError(&quot;Customer email required&quot;)</span></div>
<div class="line " data-line="863"><span class="line-num">864</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="864"><span class="line-num">865</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="865"><span class="line-num">866</span><span class="line-content">        return order</span></div>
<div class="line " data-line="866"><span class="line-num">867</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="867"><span class="line-num">868</span><span class="line-content">    def add_loyalty_points(self, points):</span></div>
<div class="line chunk-insert" data-line="868"><span class="line-num">869</span><span class="line-content">        self.loyalty_points += points</span></div>
<div class="line chunk-insert" data-line="869"><span class="line-num">870</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="870"><span class="line-num">871</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="871"><span class="line-num">872</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="872"><span class="line-num">873</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="873"><span class="line-num">874</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="874"><span class="line-num">875</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="875"><span class="line-num">876</span><span class="line-content">    i<span class="inline-diff">f </span>n<span class="inline-diff">ot</span> email<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="876"><span class="line-num">877</span><span class="line-content">        return False</span></div>
<div class="line chunk-replace" data-line="877"><span class="line-num">878</span><span class="line-content">    r<span class="inline-diff">etur</span>n <span class="inline-diff">&quot;@&quot; in email and &quot;</span>.<span class="inline-diff">&quot; in email and len(email) &gt; 5</span></span></div>
<div class="line chunk-replace" data-line="878"><span class="line-num">879</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="879"><span class="line-num">880</span><span class="line-content">def send_confirmation_email(customer, order):</span></div>
<div class="line chunk-replace" data-line="880"><span class="line-num">881</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Send </span>ord<span class="inline-diff">er confirm</span>ati<span class="inline-diff">on </span>e<span class="inline-diff">mail&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="881"><span class="line-num">882</span><span class="line-content"><span class="inline-diff">   </span> logg<span class="inline-diff">er.info(f&quot;Send</span>ing<span class="inline-diff"> confirmation to {customer.email}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="882"><span class="line-num">883</span><span class="line-content"> <span class="inline-diff">   # E</span>ma<span class="inline-diff">i</span>l <span class="inline-diff">s</span>e<span class="inline-diff">nd</span>i<span class="inline-diff">ng </span>l<span class="inline-diff">ogic here</span></span></div>
<div class="line chunk-replace" data-line="883"><span class="line-num">884</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="884"><span class="line-num">885</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="885"><span class="line-num">886</span><span class="line-content"># E-commerce System - Version 2.0</span></div>
<div class="line chunk-replace" data-line="886"><span class="line-num">887</span><span class="line-content"><span class="inline-diff">#</span> <span class="inline-diff">Enhan</span>c<span class="inline-diff">ed implemen</span>t<span class="inline-diff">ation with tax, discounts, and better validation</span></span></div>
<div class="line " data-line="887"><span class="line-num">888</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="888"><span class="line-num">889</span><span class="line-content">import datetime</span></div>
<div class="line " data-line="889"><span class="line-num">890</span><span class="line-content">import logging</span></div>
<div class="line " data-line="890"><span class="line-num">891</span><span class="line-content">from decimal import Decimal</span></div>
<div class="line chunk-insert" data-line="891"><span class="line-num">892</span><span class="line-content">from typing import List, Optional</span></div>
<div class="line " data-line="892"><span class="line-num">893</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="893"><span class="line-num">894</span><span class="line-content">logger = logging.getLogger(__name__)</span></div>
<div class="line " data-line="894"><span class="line-num">895</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="895"><span class="line-num">896</span><span class="line-content">class Product:</span></div>
<div class="line chunk-replace" data-line="896"><span class="line-num">897</span><span class="line-content">    def __init__(self, id, name, price, category<span class="inline-diff">, description=&quot;&quot;</span>):</span></div>
<div class="line " data-line="897"><span class="line-num">898</span><span class="line-content">        self.id = id</span></div>
<div class="line " data-line="898"><span class="line-num">899</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="899"><span class="line-num">900</span><span class="line-content">        self.price = Decimal(str(price))</span></div>
<div class="line " data-line="900"><span class="line-num">901</span><span class="line-content">        self.category = category</span></div>
<div class="line chunk-insert" data-line="901"><span class="line-num">902</span><span class="line-content">        self.description = description</span></div>
<div class="line " data-line="902"><span class="line-num">903</span><span class="line-content">        self.stock = 0</span></div>
<div class="line chunk-insert" data-line="903"><span class="line-num">904</span><span class="line-content">        self.sku = f&quot;SKU-{id}&quot;</span></div>
<div class="line " data-line="904"><span class="line-num">905</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="905"><span class="line-num">906</span><span class="line-content">    def update_stock(self, quantity):</span></div>
<div class="line chunk-insert" data-line="906"><span class="line-num">907</span><span class="line-content">        if self.stock + quantity &lt; 0:</span></div>
<div class="line chunk-insert" data-line="907"><span class="line-num">908</span><span class="line-content">            raise ValueError(&quot;Insufficient stock&quot;)</span></div>
<div class="line " data-line="908"><span class="line-num">909</span><span class="line-content">        self.stock += quantity</span></div>
<div class="line " data-line="909"><span class="line-num">910</span><span class="line-content">        logger.info(f&quot;Updated stock for {self.name}: {self.stock}&quot;)</span></div>
<div class="line " data-line="910"><span class="line-num">911</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="911"><span class="line-num">912</span><span class="line-content">    def get_info(self):</span></div>
<div class="line chunk-replace" data-line="912"><span class="line-num">913</span><span class="line-content">        return f&quot;{self.name} <span class="inline-diff">({self.sku}) </span>- ${self.price}&quot;</span></div>
<div class="line chunk-replace" data-line="913"><span class="line-num">914</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="914"><span class="line-num">915</span><span class="line-content"><span class="inline-diff">    def is_avai</span>la<span class="inline-diff">bl</span>e<span class="inline-diff">(self)</span>:</span></div>
<div class="line chunk-replace" data-line="915"><span class="line-num">916</span><span class="line-content">     <span class="inline-diff">   re</span>t<span class="inline-diff">urn </span>self<span class="inline-diff">.s</span>t<span class="inline-diff">ock</span> <span class="inline-diff">&gt; 0</span></span></div>
<div class="line " data-line="916"><span class="line-num">917</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="917"><span class="line-num">918</span><span class="line-content">class CartItem:</span></div>
<div class="line " data-line="918"><span class="line-num">919</span><span class="line-content">    def __init__(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="919"><span class="line-num">920</span><span class="line-content">        if quantity &lt;= 0:</span></div>
<div class="line chunk-insert" data-line="920"><span class="line-num">921</span><span class="line-content">            raise ValueError(&quot;Quantity must be positive&quot;)</span></div>
<div class="line " data-line="921"><span class="line-num">922</span><span class="line-content">        self.product = product</span></div>
<div class="line " data-line="922"><span class="line-num">923</span><span class="line-content">        self.quantity = quantity</span></div>
<div class="line " data-line="923"><span class="line-num">924</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="924"><span class="line-num">925</span><span class="line-content">    def get_subtotal(self):</span></div>
<div class="line " data-line="925"><span class="line-num">926</span><span class="line-content">        return self.product.price * self.quantity</span></div>
<div class="line " data-line="926"><span class="line-num">927</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="927"><span class="line-num">928</span><span class="line-content"><span class="inline-diff">    </span>def u<span class="inline-diff">pd</span>ate_<span class="inline-diff">qu</span>a<span class="inline-diff">nt</span>it<span class="inline-diff">y(</span>s<span class="inline-diff">elf, new_quantity</span>):</span></div>
<div class="line chunk-replace" data-line="928"><span class="line-num">929</span><span class="line-content">     <span class="inline-diff">   if new_quantity &lt;</span>= 0<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="929"><span class="line-num">930</span><span class="line-content">    <span class="inline-diff">        raise ValueErr</span>or<span class="inline-diff">(&quot;Quant</span>it<span class="inline-diff">y</span> <span class="inline-diff">must</span> <span class="inline-diff">be pos</span>it<span class="inline-diff">iv</span>e<span class="inline-diff">&quot;)</span></span></div>
<div class="line chunk-replace" data-line="930"><span class="line-num">931</span><span class="line-content">        <span class="inline-diff">se</span>l<span class="inline-diff">f.quant</span>it<span class="inline-diff">y = n</span>e<span class="inline-diff">w</span>_<span class="inline-diff">q</span>ua<span class="inline-diff">ntity</span></span></div>
<div class="line chunk-replace" data-line="931"><span class="line-num">932</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="932"><span class="line-num">933</span><span class="line-content">def calculate_total(items, tax_rate=Decimal(&#x27;0.0&#x27;)):</span></div>
<div class="line chunk-replace" data-line="933"><span class="line-num">934</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Calculat</span>e<span class="inline-diff"> total</span> pr<span class="inline-diff">i</span>ce<span class="inline-diff"> inclu</span>d<span class="inline-diff">ing tax&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="934"><span class="line-num">935</span><span class="line-content">    s<span class="inline-diff">ubtotal</span> = <span class="inline-diff">D</span>e<span class="inline-diff">c</span>im<span class="inline-diff">al</span>(<span class="inline-diff">&#x27;0&#x27;</span>)</span></div>
<div class="line " data-line="935"><span class="line-num">936</span><span class="line-content">    for item in items:</span></div>
<div class="line chunk-replace" data-line="936"><span class="line-num">937</span><span class="line-content">        <span class="inline-diff">sub</span>total += item.get_subtotal()</span></div>
<div class="line chunk-replace" data-line="937"><span class="line-num">938</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="938"><span class="line-num">939</span><span class="line-content">    tax = subtotal * tax_rate</span></div>
<div class="line chunk-replace" data-line="939"><span class="line-num">940</span><span class="line-content"> <span class="inline-diff">   </span>re<span class="inline-diff">tu</span>r<span class="inline-diff">n subt</span>o<span class="inline-diff">tal + tax</span></span></div>
<div class="line chunk-replace" data-line="940"><span class="line-num">941</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="941"><span class="line-num">942</span><span class="line-content"><span class="inline-diff">def</span> <span class="inline-diff">apply_discount(</span>total<span class="inline-diff">,</span> <span class="inline-diff">dis</span>c<span class="inline-diff">o</span>u<span class="inline-diff">nt_r</span>ate)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="942"><span class="line-num">943</span><span class="line-content">    &quot;&quot;&quot;Apply discount to total&quot;&quot;&quot;</span></div>
<div class="line chunk-replace" data-line="943"><span class="line-num">944</span><span class="line-content">    <span class="inline-diff">return</span> total <span class="inline-diff">*</span> <span class="inline-diff">(Decimal(&#x27;</span>1<span class="inline-diff">&#x27;) - discount_rate)</span></span></div>
<div class="line " data-line="944"><span class="line-num">945</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="945"><span class="line-num">946</span><span class="line-content">def process_order(order):</span></div>
<div class="line " data-line="946"><span class="line-num">947</span><span class="line-content">    items = order.get_items()</span></div>
<div class="line chunk-replace" data-line="947"><span class="line-num">948</span><span class="line-content">    total = calculate_total(items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="948"><span class="line-num">949</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="949"><span class="line-num">950</span><span class="line-content">    if total &gt; 100:</span></div>
<div class="line chunk-replace" data-line="950"><span class="line-num">951</span><span class="line-content">        <span class="inline-diff">total = apply_</span>discount<span class="inline-diff">(</span>total<span class="inline-diff">,</span> Decimal(&#x27;0.1&#x27;)<span class="inline-diff">)</span></span></div>
<div class="line chunk-replace" data-line="951"><span class="line-num">952</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="952"><span class="line-num">953</span><span class="line-content">    # Apply coupon if available</span></div>
<div class="line chunk-replace" data-line="953"><span class="line-num">954</span><span class="line-content">    <span class="inline-diff">if</span> o<span class="inline-diff">rder.coupon_code:</span></span></div>
<div class="line chunk-replace" data-line="954"><span class="line-num">955</span><span class="line-content">        total = apply_coupon(total, order.coupon_code)</span></div>
<div class="line chunk-replace" data-line="955"><span class="line-num">956</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="956"><span class="line-num">957</span><span class="line-content">    <span class="inline-diff"># Log the or</span>de<span class="inline-diff">r</span></span></div>
<div class="line chunk-replace" data-line="957"><span class="line-num">958</span><span class="line-content">    l<span class="inline-diff">ogger</span>.i<span class="inline-diff">nfo(f&quot;Ord</span>e<span class="inline-diff">r</span> <span class="inline-diff">processed:</span> <span class="inline-diff">${total:.2f}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="958"><span class="line-num">959</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="959"><span class="line-num">960</span><span class="line-content">    return total</span></div>
<div class="line chunk-replace" data-line="960"><span class="line-num">961</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="961"><span class="line-num">962</span><span class="line-content">d<span class="inline-diff">ef apply_</span>c<span class="inline-diff">oupon(</span>t<span class="inline-diff">otal</span>, <span class="inline-diff">co</span>u<span class="inline-diff">po</span>n<span class="inline-diff">_code</span>)<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="962"><span class="line-num">963</span><span class="line-content">    <span class="inline-diff">&quot;&quot;&quot;A</span>pp<span class="inline-diff">ly </span>c<span class="inline-diff">oupon d</span>i<span class="inline-diff">scoun</span>t<span class="inline-diff">&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="963"><span class="line-num">964</span><span class="line-content">    # Simple coupon validation</span></div>
<div class="line chunk-replace" data-line="964"><span class="line-num">965</span><span class="line-content">    <span class="inline-diff">i</span>f <span class="inline-diff">c</span>o<span class="inline-diff">u</span>p<span class="inline-diff">on_c</span>od<span class="inline-diff">e == &quot;SAVE10&quot;</span>:</span></div>
<div class="line chunk-replace" data-line="965"><span class="line-num">966</span><span class="line-content">        re<span class="inline-diff">tur</span>n tot<span class="inline-diff">al</span> <span class="inline-diff">*</span> <span class="inline-diff">De</span>ci<span class="inline-diff">mal(&#x27;0.9&#x27;)</span></span></div>
<div class="line " data-line="966"><span class="line-num">967</span><span class="line-content">    return total</span></div>
<div class="line " data-line="967"><span class="line-num">968</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="968"><span class="line-num">969</span><span class="line-content">class ShoppingCart:</span></div>
<div class="line chunk-replace" data-line="969"><span class="line-num">970</span><span class="line-content">    def __init__(self<span class="inline-diff">, customer=None</span>):</span></div>
<div class="line chunk-replace" data-line="970"><span class="line-num">971</span><span class="line-content">        self.items<span class="inline-diff">: List[CartItem]</span> = []</span></div>
<div class="line chunk-replace" data-line="971"><span class="line-num">972</span><span class="line-content">        self.c<span class="inline-diff">us</span>t<span class="inline-diff">om</span>e<span class="inline-diff">r</span> = <span class="inline-diff">cus</span>t<span class="inline-diff">o</span>me<span class="inline-diff">r</span></span></div>
<div class="line " data-line="972"><span class="line-num">973</span><span class="line-content">        self.created_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="973"><span class="line-num">974</span><span class="line-content">        self.updated_at = self.created_at</span></div>
<div class="line " data-line="974"><span class="line-num">975</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="975"><span class="line-num">976</span><span class="line-content">    def add_item(self, product, quantity=1):</span></div>
<div class="line chunk-insert" data-line="976"><span class="line-num">977</span><span class="line-content">        if not product.is_available():</span></div>
<div class="line chunk-insert" data-line="977"><span class="line-num">978</span><span class="line-content">            raise ValueError(&quot;Product not available&quot;)</span></div>
<div class="line chunk-insert" data-line="978"><span class="line-num">979</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="979"><span class="line-num">980</span><span class="line-content">        # Check if product already in cart</span></div>
<div class="line chunk-insert" data-line="980"><span class="line-num">981</span><span class="line-content">        for item in self.items:</span></div>
<div class="line chunk-insert" data-line="981"><span class="line-num">982</span><span class="line-content">            if item.product.id == product.id:</span></div>
<div class="line chunk-insert" data-line="982"><span class="line-num">983</span><span class="line-content">                item.update_quantity(item.quantity + quantity)</span></div>
<div class="line chunk-insert" data-line="983"><span class="line-num">984</span><span class="line-content">                self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="984"><span class="line-num">985</span><span class="line-content">                return</span></div>
<div class="line chunk-insert" data-line="985"><span class="line-num">986</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="986"><span class="line-num">987</span><span class="line-content">        cart_item = CartItem(product, quantity)</span></div>
<div class="line " data-line="987"><span class="line-num">988</span><span class="line-content">        self.items.append(cart_item)</span></div>
<div class="line chunk-insert" data-line="988"><span class="line-num">989</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="989"><span class="line-num">990</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="990"><span class="line-num">991</span><span class="line-content">    def remove_item(self, product):</span></div>
<div class="line " data-line="991"><span class="line-num">992</span><span class="line-content">        self.items = [item for item in self.items if item.product.id != product.id]</span></div>
<div class="line chunk-insert" data-line="992"><span class="line-num">993</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line " data-line="993"><span class="line-num">994</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="994"><span class="line-num">995</span><span class="line-content">    def get_total(self):</span></div>
<div class="line chunk-replace" data-line="995"><span class="line-num">996</span><span class="line-content">        return calculate_total(self.items<span class="inline-diff">, tax_rate=Decimal(&#x27;0.08&#x27;</span>)<span class="inline-diff">)</span></span></div>
<div class="line " data-line="996"><span class="line-num">997</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="997"><span class="line-num">998</span><span class="line-content">    def clear(self):</span></div>
<div class="line " data-line="998"><span class="line-num">999</span><span class="line-content">        self.items = []</span></div>
<div class="line chunk-insert" data-line="999"><span class="line-num">1000</span><span class="line-content">        self.updated_at = datetime.datetime.now()</span></div>
<div class="line chunk-insert" data-line="1000"><span class="line-num">1001</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="1001"><span class="line-num">1002</span><span class="line-content">    def get_item_count(self):</span></div>
<div class="line chunk-insert" data-line="1002"><span class="line-num">1003</span><span class="line-content">        return sum(item.quantity for item in self.items)</span></div>
<div class="line " data-line="1003"><span class="line-num">1004</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="1004"><span class="line-num">1005</span><span class="line-content">class Order:</span></div>
<div class="line " data-line="1005"><span class="line-num">1006</span><span class="line-content">    def __init__(self, cart, customer):</span></div>
<div class="line " data-line="1006"><span class="line-num">1007</span><span class="line-content">        self.cart = cart</span></div>
<div class="line " data-line="1007"><span class="line-num">1008</span><span class="line-content">        self.customer = customer</span></div>
<div class="line " data-line="1008"><span class="line-num">1009</span><span class="line-content">        self.order_date = datetime.datetime.now()</span></div>
<div class="line " data-line="1009"><span class="line-num">1010</span><span class="line-content">        self.status = &quot;pending&quot;</span></div>
<div class="line chunk-insert" data-line="1010"><span class="line-num">1011</span><span class="line-content">        self.coupon_code = None</span></div>
<div class="line chunk-insert" data-line="1011"><span class="line-num">1012</span><span class="line-content">        self.tracking_number = None</span></div>
<div class="line " data-line="1012"><span class="line-num">1013</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="1013"><span class="line-num">1014</span><span class="line-content">    def get_items(self):</span></div>
<div class="line " data-line="1014"><span class="line-num">1015</span><span class="line-content">        return self.cart.items</span></div>
<div class="line " data-line="1015"><span class="line-num">1016</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="1016"><span class="line-num">1017</span><span class="line-content">    def confirm(self):</span></div>
<div class="line " data-line="1017"><span class="line-num">1018</span><span class="line-content">        self.status = &quot;confirmed&quot;</span></div>
<div class="line chunk-replace" data-line="1018"><span class="line-num">1019</span><span class="line-content">        self.t<span class="inline-diff">racking_nu</span>m<span class="inline-diff">b</span>er<span class="inline-diff"> = self._generate_tracking_number(</span>)</span></div>
<div class="line chunk-replace" data-line="1019"><span class="line-num">1020</span><span class="line-content">        logger.info(f&quot;Order confirmed for {self.customer.name}&quot;)</span></div>
<div class="line chunk-replace" data-line="1020"><span class="line-num">1021</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="1021"><span class="line-num">1022</span><span class="line-content">    def _<span class="inline-diff">generate</span>_<span class="inline-diff">track</span>in<span class="inline-diff">g</span>_<span class="inline-diff">number</span>(self):</span></div>
<div class="line chunk-replace" data-line="1022"><span class="line-num">1023</span><span class="line-content">        <span class="inline-diff">return f&quot;TRK{</span>self.<span class="inline-diff">order_d</span>a<span class="inline-diff">te.ti</span>me<span class="inline-diff">st</span>am<span class="inline-diff">p()}&quot;</span></span></div>
<div class="line chunk-replace" data-line="1023"><span class="line-num">1024</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="1024"><span class="line-num">1025</span><span class="line-content">    <span class="inline-diff">def</span> <span class="inline-diff">cancel(</span>self<span class="inline-diff">):</span></span></div>
<div class="line chunk-replace" data-line="1025"><span class="line-num">1026</span><span class="line-content">        if self.status == &quot;shipped&quot;:</span></div>
<div class="line chunk-replace" data-line="1026"><span class="line-num">1027</span><span class="line-content">     <span class="inline-diff">       r</span>a<span class="inline-diff">ise ValueError(&quot;Cannot can</span>ce<span class="inline-diff">l shipped </span>order<span class="inline-diff">&quot;</span>)</span></div>
<div class="line chunk-replace" data-line="1027"><span class="line-num">1028</span><span class="line-content">        self<span class="inline-diff">.status = &quot;cancelled&quot;</span></span></div>
<div class="line " data-line="1028"><span class="line-num">1029</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="1029"><span class="line-num">1030</span><span class="line-content">class Customer:</span></div>
<div class="line chunk-replace" data-line="1030"><span class="line-num">1031</span><span class="line-content">    def __init__(self, name, email<span class="inline-diff">, phone=&quot;&quot;</span>):</span></div>
<div class="line " data-line="1031"><span class="line-num">1032</span><span class="line-content">        self.name = name</span></div>
<div class="line " data-line="1032"><span class="line-num">1033</span><span class="line-content">        self.email = email</span></div>
<div class="line chunk-replace" data-line="1033"><span class="line-num">1034</span><span class="line-content">        self.<span class="inline-diff">ph</span>o<span class="inline-diff">n</span>e = <span class="inline-diff">phone</span></span></div>
<div class="line chunk-replace" data-line="1034"><span class="line-num">1035</span><span class="line-content">        self.orders: List[Order] = []</span></div>
<div class="line chunk-replace" data-line="1035"><span class="line-num">1036</span><span class="line-content">     <span class="inline-diff">   </span>self<span class="inline-diff">.loy</span>a<span class="inline-diff">l</span>t<span class="inline-diff">y_points = 0</span></span></div>
<div class="line " data-line="1036"><span class="line-num">1037</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="1037"><span class="line-num">1038</span><span class="line-content">    def place_order(self, cart):</span></div>
<div class="line chunk-insert" data-line="1038"><span class="line-num">1039</span><span class="line-content">        if not self.email:</span></div>
<div class="line chunk-insert" data-line="1039"><span class="line-num">1040</span><span class="line-content">            raise ValueError(&quot;Customer email required&quot;)</span></div>
<div class="line " data-line="1040"><span class="line-num">1041</span><span class="line-content">        order = Order(cart, self)</span></div>
<div class="line " data-line="1041"><span class="line-num">1042</span><span class="line-content">        self.orders.append(order)</span></div>
<div class="line " data-line="1042"><span class="line-num">1043</span><span class="line-content">        return order</span></div>
<div class="line " data-line="1043"><span class="line-num">1044</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-insert" data-line="1044"><span class="line-num">1045</span><span class="line-content">    def add_loyalty_points(self, points):</span></div>
<div class="line chunk-insert" data-line="1045"><span class="line-num">1046</span><span class="line-content">        self.loyalty_points += points</span></div>
<div class="line chunk-insert" data-line="1046"><span class="line-num">1047</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="1047"><span class="line-num">1048</span><span class="line-content"># Utility functions</span></div>
<div class="line " data-line="1048"><span class="line-num">1049</span><span class="line-content">def format_price(amount):</span></div>
<div class="line " data-line="1049"><span class="line-num">1050</span><span class="line-content">    return f&quot;${amount:.2f}&quot;</span></div>
<div class="line " data-line="1050"><span class="line-num">1051</span><span class="line-content">&nbsp;</span></div>
<div class="line " data-line="1051"><span class="line-num">1052</span><span class="line-content">def validate_email(email):</span></div>
<div class="line chunk-replace" data-line="1052"><span class="line-num">1053</span><span class="line-content">    i<span class="inline-diff">f </span>n<span class="inline-diff">ot</span> email<span class="inline-diff">:</span></span></div>
<div class="line chunk-replace" data-line="1053"><span class="line-num">1054</span><span class="line-content">        return False</span></div>
<div class="line chunk-replace" data-line="1054"><span class="line-num">1055</span><span class="line-content">    r<span class="inline-diff">etur</span>n <span class="inline-diff">&quot;@&quot; in email and &quot;</span>.<span class="inline-diff">&quot; in email and len(email) &gt; 5</span></span></div>
<div class="line chunk-replace" data-line="1055"><span class="line-num">1056</span><span class="line-content">&nbsp;</span></div>
<div class="line chunk-replace" data-line="1056"><span class="line-num">1057</span><span class="line-content">def send_confirmation_email(customer, order):</span></div>
<div class="line chunk-replace" data-line="1057"><span class="line-num">1058</span><span class="line-content"><span class="inline-diff">    &quot;&quot;&quot;Send </span>ord<span class="inline-diff">er confirm</span>ati<span class="inline-diff">on </span>e<span class="inline-diff">mail&quot;&quot;&quot;</span></span></div>
<div class="line chunk-replace" data-line="1058"><span class="line-num">1059</span><span class="line-content"><span class="inline-diff">   </span> logg<span class="inline-diff">er.info(f&quot;Send</span>ing<span class="inline-diff"> confirmation to {customer.email}&quot;)</span></span></div>
<div class="line chunk-replace" data-line="1059"><span class="line-num">1060</span><span class="line-content"> <span class="inline-diff">   # E</span>ma<span class="inline-diff">i</span>l <span class="inline-diff">s</span>e<span class="inline-diff">nd</span>i<span class="inline-diff">ng </span>l<span class="inline-diff">ogic here</span></span></div>
<div class="line chunk-replace" data-line="1060"><span class="line-num">1061</span><span class="line-content">    pass</span></div>
<div class="line chunk-replace" data-line="1061"><span class="line-num">1062</span><span class="line-content">&nbsp;</span></div>
        </div>
    </div>

    <div class="stats" id="stats">
        Chunks: 151 | Scroll to see connections
    </div>

    <script>
        // Chunk data from Python
        const chunks = [{"id": 0, "tag": "replace", "start_a": 0, "end_a": 2, "start_b": 0, "end_b": 2}, {"id": 1, "tag": "insert", "start_a": 6, "end_a": 6, "start_b": 6, "end_b": 7}, {"id": 2, "tag": "replace", "start_a": 10, "end_a": 11, "start_b": 11, "end_b": 12}, {"id": 3, "tag": "insert", "start_a": 15, "end_a": 15, "start_b": 16, "end_b": 17}, {"id": 4, "tag": "insert", "start_a": 16, "end_a": 16, "start_b": 18, "end_b": 19}, {"id": 5, "tag": "insert", "start_a": 18, "end_a": 18, "start_b": 21, "end_b": 23}, {"id": 6, "tag": "replace", "start_a": 22, "end_a": 23, "start_b": 27, "end_b": 31}, {"id": 7, "tag": "insert", "start_a": 26, "end_a": 26, "start_b": 34, "end_b": 36}, {"id": 8, "tag": "replace", "start_a": 32, "end_a": 34, "start_b": 42, "end_b": 50}, {"id": 9, "tag": "replace", "start_a": 35, "end_a": 37, "start_b": 51, "end_b": 59}, {"id": 10, "tag": "replace", "start_a": 40, "end_a": 41, "start_b": 62, "end_b": 63}, {"id": 11, "tag": "replace", "start_a": 43, "end_a": 46, "start_b": 65, "end_b": 81}, {"id": 12, "tag": "replace", "start_a": 49, "end_a": 51, "start_b": 84, "end_b": 87}, {"id": 13, "tag": "insert", "start_a": 52, "end_a": 52, "start_b": 88, "end_b": 89}, {"id": 14, "tag": "insert", "start_a": 54, "end_a": 54, "start_b": 91, "end_b": 101}, {"id": 15, "tag": "insert", "start_a": 56, "end_a": 56, "start_b": 103, "end_b": 104}, {"id": 16, "tag": "insert", "start_a": 59, "end_a": 59, "start_b": 107, "end_b": 108}, {"id": 17, "tag": "replace", "start_a": 61, "end_a": 62, "start_b": 110, "end_b": 111}, {"id": 18, "tag": "insert", "start_a": 65, "end_a": 65, "start_b": 114, "end_b": 118}, {"id": 19, "tag": "insert", "start_a": 72, "end_a": 72, "start_b": 125, "end_b": 127}, {"id": 20, "tag": "replace", "start_a": 78, "end_a": 79, "start_b": 133, "end_b": 143}, {"id": 21, "tag": "replace", "start_a": 81, "end_a": 82, "start_b": 145, "end_b": 146}, {"id": 22, "tag": "replace", "start_a": 84, "end_a": 85, "start_b": 148, "end_b": 151}, {"id": 23, "tag": "insert", "start_a": 87, "end_a": 87, "start_b": 153, "end_b": 155}, {"id": 24, "tag": "insert", "start_a": 91, "end_a": 91, "start_b": 159, "end_b": 162}, {"id": 25, "tag": "replace", "start_a": 96, "end_a": 100, "start_b": 167, "end_b": 179}, {"id": 26, "tag": "insert", "start_a": 104, "end_a": 104, "start_b": 183, "end_b": 184}, {"id": 27, "tag": "replace", "start_a": 108, "end_a": 109, "start_b": 188, "end_b": 189}, {"id": 28, "tag": "insert", "start_a": 113, "end_a": 113, "start_b": 193, "end_b": 194}, {"id": 29, "tag": "insert", "start_a": 114, "end_a": 114, "start_b": 195, "end_b": 196}, {"id": 30, "tag": "insert", "start_a": 116, "end_a": 116, "start_b": 198, "end_b": 200}, {"id": 31, "tag": "replace", "start_a": 120, "end_a": 121, "start_b": 204, "end_b": 208}, {"id": 32, "tag": "insert", "start_a": 124, "end_a": 124, "start_b": 211, "end_b": 213}, {"id": 33, "tag": "replace", "start_a": 130, "end_a": 132, "start_b": 219, "end_b": 227}, {"id": 34, "tag": "replace", "start_a": 133, "end_a": 135, "start_b": 228, "end_b": 236}, {"id": 35, "tag": "replace", "start_a": 138, "end_a": 139, "start_b": 239, "end_b": 240}, {"id": 36, "tag": "replace", "start_a": 141, "end_a": 144, "start_b": 242, "end_b": 258}, {"id": 37, "tag": "replace", "start_a": 147, "end_a": 149, "start_b": 261, "end_b": 264}, {"id": 38, "tag": "insert", "start_a": 150, "end_a": 150, "start_b": 265, "end_b": 266}, {"id": 39, "tag": "insert", "start_a": 152, "end_a": 152, "start_b": 268, "end_b": 278}, {"id": 40, "tag": "insert", "start_a": 154, "end_a": 154, "start_b": 280, "end_b": 281}, {"id": 41, "tag": "insert", "start_a": 157, "end_a": 157, "start_b": 284, "end_b": 285}, {"id": 42, "tag": "replace", "start_a": 159, "end_a": 160, "start_b": 287, "end_b": 288}, {"id": 43, "tag": "insert", "start_a": 163, "end_a": 163, "start_b": 291, "end_b": 295}, {"id": 44, "tag": "insert", "start_a": 170, "end_a": 170, "start_b": 302, "end_b": 304}, {"id": 45, "tag": "replace", "start_a": 176, "end_a": 177, "start_b": 310, "end_b": 320}, {"id": 46, "tag": "replace", "start_a": 179, "end_a": 180, "start_b": 322, "end_b": 323}, {"id": 47, "tag": "replace", "start_a": 182, "end_a": 183, "start_b": 325, "end_b": 328}, {"id": 48, "tag": "insert", "start_a": 185, "end_a": 185, "start_b": 330, "end_b": 332}, {"id": 49, "tag": "insert", "start_a": 189, "end_a": 189, "start_b": 336, "end_b": 339}, {"id": 50, "tag": "replace", "start_a": 194, "end_a": 198, "start_b": 344, "end_b": 356}, {"id": 51, "tag": "insert", "start_a": 202, "end_a": 202, "start_b": 360, "end_b": 361}, {"id": 52, "tag": "replace", "start_a": 206, "end_a": 207, "start_b": 365, "end_b": 366}, {"id": 53, "tag": "insert", "start_a": 211, "end_a": 211, "start_b": 370, "end_b": 371}, {"id": 54, "tag": "insert", "start_a": 212, "end_a": 212, "start_b": 372, "end_b": 373}, {"id": 55, "tag": "insert", "start_a": 214, "end_a": 214, "start_b": 375, "end_b": 377}, {"id": 56, "tag": "replace", "start_a": 218, "end_a": 219, "start_b": 381, "end_b": 385}, {"id": 57, "tag": "insert", "start_a": 222, "end_a": 222, "start_b": 388, "end_b": 390}, {"id": 58, "tag": "replace", "start_a": 228, "end_a": 230, "start_b": 396, "end_b": 404}, {"id": 59, "tag": "replace", "start_a": 231, "end_a": 233, "start_b": 405, "end_b": 413}, {"id": 60, "tag": "replace", "start_a": 236, "end_a": 237, "start_b": 416, "end_b": 417}, {"id": 61, "tag": "replace", "start_a": 239, "end_a": 242, "start_b": 419, "end_b": 435}, {"id": 62, "tag": "replace", "start_a": 245, "end_a": 247, "start_b": 438, "end_b": 441}, {"id": 63, "tag": "insert", "start_a": 248, "end_a": 248, "start_b": 442, "end_b": 443}, {"id": 64, "tag": "insert", "start_a": 250, "end_a": 250, "start_b": 445, "end_b": 455}, {"id": 65, "tag": "insert", "start_a": 252, "end_a": 252, "start_b": 457, "end_b": 458}, {"id": 66, "tag": "insert", "start_a": 255, "end_a": 255, "start_b": 461, "end_b": 462}, {"id": 67, "tag": "replace", "start_a": 257, "end_a": 258, "start_b": 464, "end_b": 465}, {"id": 68, "tag": "insert", "start_a": 261, "end_a": 261, "start_b": 468, "end_b": 472}, {"id": 69, "tag": "insert", "start_a": 268, "end_a": 268, "start_b": 479, "end_b": 481}, {"id": 70, "tag": "replace", "start_a": 274, "end_a": 275, "start_b": 487, "end_b": 497}, {"id": 71, "tag": "replace", "start_a": 277, "end_a": 278, "start_b": 499, "end_b": 500}, {"id": 72, "tag": "replace", "start_a": 280, "end_a": 281, "start_b": 502, "end_b": 505}, {"id": 73, "tag": "insert", "start_a": 283, "end_a": 283, "start_b": 507, "end_b": 509}, {"id": 74, "tag": "insert", "start_a": 287, "end_a": 287, "start_b": 513, "end_b": 516}, {"id": 75, "tag": "replace", "start_a": 292, "end_a": 296, "start_b": 521, "end_b": 533}, {"id": 76, "tag": "insert", "start_a": 300, "end_a": 300, "start_b": 537, "end_b": 538}, {"id": 77, "tag": "replace", "start_a": 304, "end_a": 305, "start_b": 542, "end_b": 543}, {"id": 78, "tag": "insert", "start_a": 309, "end_a": 309, "start_b": 547, "end_b": 548}, {"id": 79, "tag": "insert", "start_a": 310, "end_a": 310, "start_b": 549, "end_b": 550}, {"id": 80, "tag": "insert", "start_a": 312, "end_a": 312, "start_b": 552, "end_b": 554}, {"id": 81, "tag": "replace", "start_a": 316, "end_a": 317, "start_b": 558, "end_b": 562}, {"id": 82, "tag": "insert", "start_a": 320, "end_a": 320, "start_b": 565, "end_b": 567}, {"id": 83, "tag": "replace", "start_a": 326, "end_a": 328, "start_b": 573, "end_b": 581}, {"id": 84, "tag": "replace", "start_a": 329, "end_a": 331, "start_b": 582, "end_b": 590}, {"id": 85, "tag": "replace", "start_a": 334, "end_a": 335, "start_b": 593, "end_b": 594}, {"id": 86, "tag": "replace", "start_a": 337, "end_a": 340, "start_b": 596, "end_b": 612}, {"id": 87, "tag": "replace", "start_a": 343, "end_a": 345, "start_b": 615, "end_b": 618}, {"id": 88, "tag": "insert", "start_a": 346, "end_a": 346, "start_b": 619, "end_b": 620}, {"id": 89, "tag": "insert", "start_a": 348, "end_a": 348, "start_b": 622, "end_b": 632}, {"id": 90, "tag": "insert", "start_a": 350, "end_a": 350, "start_b": 634, "end_b": 635}, {"id": 91, "tag": "insert", "start_a": 353, "end_a": 353, "start_b": 638, "end_b": 639}, {"id": 92, "tag": "replace", "start_a": 355, "end_a": 356, "start_b": 641, "end_b": 642}, {"id": 93, "tag": "insert", "start_a": 359, "end_a": 359, "start_b": 645, "end_b": 649}, {"id": 94, "tag": "insert", "start_a": 366, "end_a": 366, "start_b": 656, "end_b": 658}, {"id": 95, "tag": "replace", "start_a": 372, "end_a": 373, "start_b": 664, "end_b": 674}, {"id": 96, "tag": "replace", "start_a": 375, "end_a": 376, "start_b": 676, "end_b": 677}, {"id": 97, "tag": "replace", "start_a": 378, "end_a": 379, "start_b": 679, "end_b": 682}, {"id": 98, "tag": "insert", "start_a": 381, "end_a": 381, "start_b": 684, "end_b": 686}, {"id": 99, "tag": "insert", "start_a": 385, "end_a": 385, "start_b": 690, "end_b": 693}, {"id": 100, "tag": "replace", "start_a": 390, "end_a": 394, "start_b": 698, "end_b": 710}, {"id": 101, "tag": "insert", "start_a": 398, "end_a": 398, "start_b": 714, "end_b": 715}, {"id": 102, "tag": "replace", "start_a": 402, "end_a": 403, "start_b": 719, "end_b": 720}, {"id": 103, "tag": "insert", "start_a": 407, "end_a": 407, "start_b": 724, "end_b": 725}, {"id": 104, "tag": "insert", "start_a": 408, "end_a": 408, "start_b": 726, "end_b": 727}, {"id": 105, "tag": "insert", "start_a": 410, "end_a": 410, "start_b": 729, "end_b": 731}, {"id": 106, "tag": "replace", "start_a": 414, "end_a": 415, "start_b": 735, "end_b": 739}, {"id": 107, "tag": "insert", "start_a": 418, "end_a": 418, "start_b": 742, "end_b": 744}, {"id": 108, "tag": "replace", "start_a": 424, "end_a": 426, "start_b": 750, "end_b": 758}, {"id": 109, "tag": "replace", "start_a": 427, "end_a": 429, "start_b": 759, "end_b": 767}, {"id": 110, "tag": "replace", "start_a": 432, "end_a": 433, "start_b": 770, "end_b": 771}, {"id": 111, "tag": "replace", "start_a": 435, "end_a": 438, "start_b": 773, "end_b": 789}, {"id": 112, "tag": "replace", "start_a": 441, "end_a": 443, "start_b": 792, "end_b": 795}, {"id": 113, "tag": "insert", "start_a": 444, "end_a": 444, "start_b": 796, "end_b": 797}, {"id": 114, "tag": "insert", "start_a": 446, "end_a": 446, "start_b": 799, "end_b": 809}, {"id": 115, "tag": "insert", "start_a": 448, "end_a": 448, "start_b": 811, "end_b": 812}, {"id": 116, "tag": "insert", "start_a": 451, "end_a": 451, "start_b": 815, "end_b": 816}, {"id": 117, "tag": "replace", "start_a": 453, "end_a": 454, "start_b": 818, "end_b": 819}, {"id": 118, "tag": "insert", "start_a": 457, "end_a": 457, "start_b": 822, "end_b": 826}, {"id": 119, "tag": "insert", "start_a": 464, "end_a": 464, "start_b": 833, "end_b": 835}, {"id": 120, "tag": "replace", "start_a": 470, "end_a": 471, "start_b": 841, "end_b": 851}, {"id": 121, "tag": "replace", "start_a": 473, "end_a": 474, "start_b": 853, "end_b": 854}, {"id": 122, "tag": "replace", "start_a": 476, "end_a": 477, "start_b": 856, "end_b": 859}, {"id": 123, "tag": "insert", "start_a": 479, "end_a": 479, "start_b": 861, "end_b": 863}, {"id": 124, "tag": "insert", "start_a": 483, "end_a": 483, "start_b": 867, "end_b": 870}, {"id": 125, "tag": "replace", "start_a": 488, "end_a": 492, "start_b": 875, "end_b": 887}, {"id": 126, "tag": "insert", "start_a": 496, "end_a": 496, "start_b": 891, "end_b": 892}, {"id": 127, "tag": "replace", "start_a": 500, "end_a": 501, "start_b": 896, "end_b": 897}, {"id": 128, "tag": "insert", "start_a": 505, "end_a": 505, "start_b": 901, "end_b": 902}, {"id": 129, "tag": "insert", "start_a": 506, "end_a": 506, "start_b": 903, "end_b": 904}, {"id": 130, "tag": "insert", "start_a": 508, "end_a": 508, "start_b": 906, "end_b": 908}, {"id": 131, "tag": "replace", "start_a": 512, "end_a": 513, "start_b": 912, "end_b": 916}, {"id": 132, "tag": "insert", "start_a": 516, "end_a": 516, "start_b": 919, "end_b": 921}, {"id": 133, "tag": "replace", "start_a": 522, "end_a": 524, "start_b": 927, "end_b": 935}, {"id": 134, "tag": "replace", "start_a": 525, "end_a": 527, "start_b": 936, "end_b": 944}, {"id": 135, "tag": "replace", "start_a": 530, "end_a": 531, "start_b": 947, "end_b": 948}, {"id": 136, "tag": "replace", "start_a": 533, "end_a": 536, "start_b": 950, "end_b": 966}, {"id": 137, "tag": "replace", "start_a": 539, "end_a": 541, "start_b": 969, "end_b": 972}, {"id": 138, "tag": "insert", "start_a": 542, "end_a": 542, "start_b": 973, "end_b": 974}, {"id": 139, "tag": "insert", "start_a": 544, "end_a": 544, "start_b": 976, "end_b": 986}, {"id": 140, "tag": "insert", "start_a": 546, "end_a": 546, "start_b": 988, "end_b": 989}, {"id": 141, "tag": "insert", "start_a": 549, "end_a": 549, "start_b": 992, "end_b": 993}, {"id": 142, "tag": "replace", "start_a": 551, "end_a": 552, "start_b": 995, "end_b": 996}, {"id": 143, "tag": "insert", "start_a": 555, "end_a": 555, "start_b": 999, "end_b": 1003}, {"id": 144, "tag": "insert", "start_a": 562, "end_a": 562, "start_b": 1010, "end_b": 1012}, {"id": 145, "tag": "replace", "start_a": 568, "end_a": 569, "start_b": 1018, "end_b": 1028}, {"id": 146, "tag": "replace", "start_a": 571, "end_a": 572, "start_b": 1030, "end_b": 1031}, {"id": 147, "tag": "replace", "start_a": 574, "end_a": 575, "start_b": 1033, "end_b": 1036}, {"id": 148, "tag": "insert", "start_a": 577, "end_a": 577, "start_b": 1038, "end_b": 1040}, {"id": 149, "tag": "insert", "start_a": 581, "end_a": 581, "start_b": 1044, "end_b": 1047}, {"id": 150, "tag": "replace", "start_a": 586, "end_a": 686, "start_b": 1052, "end_b": 1062}];

        class DiffRenderer {
            constructor(leftPane, rightPane, svgElement, canvasElement) {
                this.leftPane = leftPane;
                this.rightPane = rightPane;
                this.svg = svgElement;
                this.canvas = canvasElement;
                this.chunks = chunks;
                this.useWebGL = true;
                this.hoveredChunkId = null;
                this.isScrollingProgrammatically = false;

                // Initialize WebGL
                this.initWebGL();

                // Throttle updates for better performance
                this.updatePending = false;
                this.updateLinkMapThrottled = this.throttle(() => this.updateLinkMap(), 16); // ~60fps

                // Setup scroll listeners - panes scroll independently, just update linkmap
                this.leftPane.addEventListener('scroll', () => {
                    if (!this.isScrollingProgrammatically) {
                        this.updateLinkMapThrottled();
                    }
                });
                this.rightPane.addEventListener('scroll', () => {
                    if (!this.isScrollingProgrammatically) {
                        this.updateLinkMapThrottled();
                    }
                });
                window.addEventListener('resize', () => this.updateLinkMapThrottled());

                // Setup ResizeObserver for more reliable updates
                if (typeof ResizeObserver !== 'undefined') {
                    const resizeObserver = new ResizeObserver(() => this.updateLinkMapThrottled());
                    resizeObserver.observe(this.leftPane);
                    resizeObserver.observe(this.rightPane);
                }

                // Canvas hover detection
                this.canvas.addEventListener('mousemove', (e) => this.handleCanvasHover(e));
                this.canvas.addEventListener('mouseleave', () => this.handleCanvasLeave());

                // Rendering mode toggle
                document.getElementById('use-webgl').addEventListener('change', (e) => {
                    this.useWebGL = e.target.checked;
                    this.svg.style.display = this.useWebGL ? 'none' : 'block';
                    this.canvas.style.display = this.useWebGL ? 'block' : 'none';
                    this.updateLinkMap();
                });


                // Initial render
                this.updateLinkMap();
                this.drawMarkers();
            }

            drawMarkers() {
                // Add CSS classes to lines to show insert/delete markers
                this.chunks.forEach((chunk) => {
                    if (chunk.tag === 'insert') {
                        // Insert in right means we need a marker in left pane
                        // Add border-bottom to the line BEFORE the insert position
                        const lineNum = chunk.start_a > 0 ? chunk.start_a - 1 : 0;
                        const lineElement = this.leftPane.querySelector(`[data-line="${lineNum}"]`);
                        if (lineElement) {
                            lineElement.classList.add('insert-marker-after');
                            lineElement.dataset.markerChunkId = chunk.id;
                        }
                    } else if (chunk.tag === 'delete') {
                        // Delete in left means we need a marker in right pane
                        const lineNum = chunk.start_b > 0 ? chunk.start_b - 1 : 0;
                        const lineElement = this.rightPane.querySelector(`[data-line="${lineNum}"]`);
                        if (lineElement) {
                            lineElement.classList.add('delete-marker-after');
                            lineElement.dataset.markerChunkId = chunk.id;
                        }
                    }
                });
            }


            throttle(func, wait) {
                let timeout;
                return function(...args) {
                    if (!timeout) {
                        timeout = setTimeout(() => {
                            timeout = null;
                            func.apply(this, args);
                        }, wait);
                    }
                };
            }

            initWebGL() {
                const gl = this.canvas.getContext('webgl', {
                    alpha: true,
                    antialias: true,
                    preserveDrawingBuffer: true
                });

                if (!gl) {
                    console.warn('WebGL not supported, falling back to SVG');
                    this.useWebGL = false;
                    document.getElementById('use-webgl').checked = false;
                    document.getElementById('use-webgl').disabled = true;
                    return;
                }

                this.gl = gl;

                // Vertex shader - simple pass-through with color
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    attribute vec4 a_color;
                    varying vec4 v_color;
                    uniform vec2 u_resolution;

                    void main() {
                        vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0;
                        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
                        v_color = a_color;
                    }
                `;

                // Fragment shader - simple color
                const fragmentShaderSource = `
                    precision mediump float;
                    varying vec4 v_color;

                    void main() {
                        gl_FragColor = v_color;
                    }
                `;

                // Compile shaders
                const vertexShader = this.compileShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
                const fragmentShader = this.compileShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);

                // Link program
                const program = gl.createProgram();
                gl.attachShader(program, vertexShader);
                gl.attachShader(program, fragmentShader);
                gl.linkProgram(program);

                if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                    console.error('Program link failed:', gl.getProgramInfoLog(program));
                    return;
                }

                this.program = program;
                this.positionLocation = gl.getAttribLocation(program, 'a_position');
                this.colorLocation = gl.getAttribLocation(program, 'a_color');
                this.resolutionLocation = gl.getUniformLocation(program, 'u_resolution');

                // Create buffers
                this.positionBuffer = gl.createBuffer();
                this.colorBuffer = gl.createBuffer();
            }

            compileShader(gl, type, source) {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);

                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    console.error('Shader compile failed:', gl.getShaderInfoLog(shader));
                    gl.deleteShader(shader);
                    return null;
                }

                return shader;
            }

            getLinePosition(pane, lineNum) {
                // Get line element
                const lineElement = pane.querySelector(`[data-line="${lineNum}"]`);
                if (!lineElement) return null;

                const paneRect = pane.getBoundingClientRect();
                const lineRect = lineElement.getBoundingClientRect();

                // Use canvas or SVG as reference depending on current mode
                const referenceRect = this.useWebGL ? this.canvas.getBoundingClientRect() : this.svg.getBoundingClientRect();

                // Position relative to reference element (SVG or Canvas)
                return lineRect.top - referenceRect.top + (lineRect.height / 2);
            }

            getVisibleLines(pane) {
                const rect = pane.getBoundingClientRect();
                const firstLine = pane.querySelector('.line');
                if (!firstLine) return { start: 0, end: 0 };

                const lineHeight = firstLine.offsetHeight;
                const scrollTop = pane.scrollTop;
                const paneHeight = pane.clientHeight;

                const startLine = Math.floor(scrollTop / lineHeight);
                const endLine = Math.ceil((scrollTop + paneHeight) / lineHeight);

                return { start: startLine, end: endLine };
            }

            isChunkVisible(chunk, leftVisible, rightVisible) {
                const leftOverlap = chunk.end_a >= leftVisible.start &&
                                    chunk.start_a <= leftVisible.end;
                const rightOverlap = chunk.end_b >= rightVisible.start &&
                                     chunk.start_b <= rightVisible.end;
                return leftOverlap || rightOverlap;
            }

            updateLinkMap() {
                if (this.useWebGL && this.gl) {
                    this.renderWebGL();
                } else {
                    this.renderSVG();
                }
            }

            renderSVG() {
                // Clear existing paths
                this.svg.innerHTML = '';

                const leftVisible = this.getVisibleLines(this.leftPane);
                const rightVisible = this.getVisibleLines(this.rightPane);

                const svgWidth = this.svg.clientWidth;
                const svgHeight = this.svg.clientHeight;

                // Set SVG viewBox
                this.svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);

                let renderedCount = 0;

                // Draw paths for each chunk
                this.chunks.forEach((chunk, index) => {
                    // Check if chunk is in visible range
                    if (!this.isChunkVisible(chunk, leftVisible, rightVisible)) {
                        return;
                    }

                    const path = this.createChunkPath(chunk, svgWidth);
                    if (path) {
                        // Add chunk ID as data attribute
                        path.setAttribute('data-chunk-id', chunk.id);

                        // Setup hover handlers
                        path.addEventListener('mouseenter', (e) => this.highlightChunk(chunk.id));
                        path.addEventListener('mouseleave', (e) => this.unhighlightChunk(chunk.id));

                        this.svg.appendChild(path);
                        renderedCount++;
                    }
                });

                // Update stats
                document.getElementById('stats').textContent =
                    `Chunks: ${this.chunks.length} | Rendered: ${renderedCount} | Mode: SVG`;
            }

            renderWebGL() {
                const gl = this.gl;
                if (!gl) return;

                const leftVisible = this.getVisibleLines(this.leftPane);
                const rightVisible = this.getVisibleLines(this.rightPane);

                const width = this.canvas.clientWidth;
                const height = this.canvas.clientHeight;

                // Set canvas size accounting for device pixel ratio
                const dpr = window.devicePixelRatio || 1;
                this.canvas.width = width * dpr;
                this.canvas.height = height * dpr;

                gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                gl.clear(gl.COLOR_BUFFER_BIT);

                // Enable blending for transparency
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

                // Use shader program
                gl.useProgram(this.program);
                gl.uniform2f(this.resolutionLocation, this.canvas.width, this.canvas.height);

                let positions = [];
                let colors = [];
                let renderedCount = 0;

                // Generate geometry for visible chunks
                this.visibleChunks = []; // Store for hover detection

                this.chunks.forEach((chunk) => {
                    if (!this.isChunkVisible(chunk, leftVisible, rightVisible)) {
                        return;
                    }

                    // Calculate line positions
                    // For insert/delete chunks, use the marker line position
                    let leftLineStart = chunk.start_a;
                    let leftLineEnd = Math.max(chunk.start_a, chunk.end_a - 1);
                    let rightLineStart = chunk.start_b;
                    let rightLineEnd = Math.max(chunk.start_b, chunk.end_b - 1);

                    // For insert chunks, the marker is on the line BEFORE start_a
                    if (chunk.tag === 'insert' && chunk.start_a > 0) {
                        leftLineStart = chunk.start_a - 1;
                        leftLineEnd = chunk.start_a - 1;
                    }
                    // For delete chunks, the marker is on the line BEFORE start_b
                    if (chunk.tag === 'delete' && chunk.start_b > 0) {
                        rightLineStart = chunk.start_b - 1;
                        rightLineEnd = chunk.start_b - 1;
                    }

                    const leftY0 = this.getLinePosition(this.leftPane, leftLineStart);
                    const leftY1 = this.getLinePosition(this.leftPane, leftLineEnd);
                    const rightY0 = this.getLinePosition(this.rightPane, rightLineStart);
                    const rightY1 = this.getLinePosition(this.rightPane, rightLineEnd);

                    if (leftY0 === null || rightY0 === null) return;

                    // Clamp positions to visible area (with small margin)
                    const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
                    const clampedLeftY0 = clamp(leftY0, -10, height + 10);
                    const clampedLeftY1 = clamp(leftY1 || leftY0, -10, height + 10);
                    const clampedRightY0 = clamp(rightY0, -10, height + 10);
                    const clampedRightY1 = clamp(rightY1 || rightY0, -10, height + 10);

                    let ly0 = clampedLeftY0 * dpr;
                    let ly1 = clampedLeftY1 * dpr;
                    let ry0 = clampedRightY0 * dpr;
                    let ry1 = clampedRightY1 * dpr;

                    // Ensure minimum height for visibility (especially single-line chunks)
                    const MIN_HEIGHT = 3 * dpr; // 3px minimum height
                    if (Math.abs(ly1 - ly0) < MIN_HEIGHT) {
                        // Expand left side slightly for visibility
                        ly0 -= MIN_HEIGHT / 2;
                        ly1 += MIN_HEIGHT / 2;
                    }
                    if (Math.abs(ry1 - ry0) < MIN_HEIGHT) {
                        // Expand right side slightly for visibility
                        ry0 -= MIN_HEIGHT / 2;
                        ry1 += MIN_HEIGHT / 2;
                    }

                    const x0 = 0;
                    const x1 = (width / 2) * dpr; // Middle control point
                    const x2 = width * dpr;

                    // Store chunk bounds for hover detection
                    this.visibleChunks.push({
                        id: chunk.id,
                        x0, x2, ly0, ly1, ry0, ry1,
                        tag: chunk.tag,
                        start_a: chunk.start_a,
                        end_a: chunk.end_a,
                        start_b: chunk.start_b,
                        end_b: chunk.end_b
                    });

                    // Get color
                    const color = this.getColorForTag(chunk.tag, chunk.id === this.hoveredChunkId);

                    // Generate bezier curve approximation using multiple segments
                    const segments = 20; // Number of segments for smooth curve

                    // Create the filled shape exactly like SVG does:
                    // Path: M x0,ly0 C x1,ly0 x1,ry0 x2,ry0 L x2,ry1 C x1,ry1 x1,ly1 x0,ly1 Z

                    // Generate points along the top curve (left to right)
                    const topPoints = [];
                    for (let i = 0; i <= segments; i++) {
                        const t = i / segments;
                        const t2 = t * t;
                        const t3 = t2 * t;
                        const mt = 1 - t;
                        const mt2 = mt * mt;
                        const mt3 = mt2 * mt;

                        // Cubic bezier: (x0,ly0) -> (x1,ly0) -> (x1,ry0) -> (x2,ry0)
                        const x = mt3 * x0 + 3 * mt2 * t * x1 + 3 * mt * t2 * x1 + t3 * x2;
                        const y = mt3 * ly0 + 3 * mt2 * t * ly0 + 3 * mt * t2 * ry0 + t3 * ry0;
                        topPoints.push(x, y);
                    }

                    // Generate points along the bottom curve (left to right, SAME direction as top)
                    // Then we'll traverse it backwards when creating triangles
                    const bottomPoints = [];
                    for (let i = 0; i <= segments; i++) {
                        const t = i / segments;
                        const t2 = t * t;
                        const t3 = t2 * t;
                        const mt = 1 - t;
                        const mt2 = mt * mt;
                        const mt3 = mt2 * mt;

                        // Cubic bezier: (x0,ly1) -> (x1,ly1) -> (x1,ry1) -> (x2,ry1)
                        const x = mt3 * x0 + 3 * mt2 * t * x1 + 3 * mt * t2 * x1 + t3 * x2;
                        const y = mt3 * ly1 + 3 * mt2 * t * ly1 + 3 * mt * t2 * ry1 + t3 * ry1;
                        bottomPoints.push(x, y);
                    }

                    // Create triangle strip between the two curves
                    // This creates a proper filled shape without twisting
                    for (let i = 0; i < segments; i++) {
                        const topX1 = topPoints[i * 2];
                        const topY1 = topPoints[i * 2 + 1];
                        const topX2 = topPoints[(i + 1) * 2];
                        const topY2 = topPoints[(i + 1) * 2 + 1];

                        const bottomX1 = bottomPoints[i * 2];
                        const bottomY1 = bottomPoints[i * 2 + 1];
                        const bottomX2 = bottomPoints[(i + 1) * 2];
                        const bottomY2 = bottomPoints[(i + 1) * 2 + 1];

                        // First triangle
                        positions.push(
                            topX1, topY1,
                            bottomX1, bottomY1,
                            topX2, topY2
                        );
                        for (let j = 0; j < 3; j++) colors.push(...color);

                        // Second triangle
                        positions.push(
                            topX2, topY2,
                            bottomX1, bottomY1,
                            bottomX2, bottomY2
                        );
                        for (let j = 0; j < 3; j++) colors.push(...color);
                    }

                    renderedCount++;
                });

                if (positions.length > 0) {
                    // Upload position data
                    gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);
                    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);
                    gl.enableVertexAttribArray(this.positionLocation);
                    gl.vertexAttribPointer(this.positionLocation, 2, gl.FLOAT, false, 0, 0);

                    // Upload color data
                    gl.bindBuffer(gl.ARRAY_BUFFER, this.colorBuffer);
                    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);
                    gl.enableVertexAttribArray(this.colorLocation);
                    gl.vertexAttribPointer(this.colorLocation, 4, gl.FLOAT, false, 0, 0);

                    // Draw
                    gl.drawArrays(gl.TRIANGLES, 0, positions.length / 2);
                }

                // Update stats
                document.getElementById('stats').textContent =
                    `Chunks: ${this.chunks.length} | Rendered: ${renderedCount} | Mode: WebGL`;
            }


            getColorForTag(tag, isHovered) {
                const alpha = isHovered ? 0.6 : 0.3;
                const colors = {
                    'insert': [0.55, 0.78, 0.55, alpha],
                    'delete': [0.94, 0.55, 0.55, alpha],
                    'replace': [0.55, 0.71, 0.94, alpha]
                };
                return colors[tag] || colors['replace'];
            }

            handleCanvasHover(e) {
                if (!this.useWebGL) return;

                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check which chunk was hovered
                let foundChunk = null;
                for (const chunk of this.visibleChunks || []) {
                    // Simple bounding box check
                    const minY = Math.min(chunk.ly0, chunk.ry0);
                    const maxY = Math.max(chunk.ly1, chunk.ry1);

                    if (y >= minY && y <= maxY) {
                        foundChunk = chunk;
                        break;
                    }
                }

                const newHoveredId = foundChunk ? foundChunk.id : null;

                if (newHoveredId !== this.hoveredChunkId) {
                    if (this.hoveredChunkId !== null) {
                        this.unhighlightChunk(this.hoveredChunkId);
                    }

                    this.hoveredChunkId = newHoveredId;

                    if (this.hoveredChunkId !== null) {
                        this.highlightChunk(this.hoveredChunkId);
                        this.canvas.style.cursor = 'pointer';
                    } else {
                        this.canvas.style.cursor = 'default';
                    }

                    this.renderWebGL(); // Re-render to show hover effect
                }
            }

            handleCanvasLeave() {
                if (this.hoveredChunkId !== null) {
                    this.unhighlightChunk(this.hoveredChunkId);
                    this.hoveredChunkId = null;
                    this.canvas.style.cursor = 'default';
                    this.renderWebGL();
                }
            }

            createChunkPath(chunk, svgWidth) {
                // Calculate Y positions
                // For insert/delete chunks, use the marker line position
                let leftLineStart = chunk.start_a;
                let leftLineEnd = Math.max(chunk.start_a, chunk.end_a - 1);
                let rightLineStart = chunk.start_b;
                let rightLineEnd = Math.max(chunk.start_b, chunk.end_b - 1);

                // For insert chunks, the marker is on the line BEFORE start_a
                if (chunk.tag === 'insert' && chunk.start_a > 0) {
                    leftLineStart = chunk.start_a - 1;
                    leftLineEnd = chunk.start_a - 1;
                }
                // For delete chunks, the marker is on the line BEFORE start_b
                if (chunk.tag === 'delete' && chunk.start_b > 0) {
                    rightLineStart = chunk.start_b - 1;
                    rightLineEnd = chunk.start_b - 1;
                }

                const leftY0 = this.getLinePosition(this.leftPane, leftLineStart);
                const leftY1 = this.getLinePosition(this.leftPane, leftLineEnd);
                const rightY0 = this.getLinePosition(this.rightPane, rightLineStart);
                const rightY1 = this.getLinePosition(this.rightPane, rightLineEnd);

                // Skip if positions couldn't be calculated
                if (leftY0 === null || rightY0 === null) return null;

                const x0 = 0;
                const x1 = svgWidth / 2;
                const x2 = svgWidth;

                // Create bezier curve path (similar to Meld's implementation)
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

                // Handle insert/delete cases where one side has no height
                let ly0 = leftY0 || 0;
                let ly1 = leftY1 || leftY0 || 0;
                let ry0 = rightY0 || 0;
                let ry1 = rightY1 || rightY0 || 0;

                // Pixel-perfect positioning: use -0.5 offsets for crisp rendering
                ly0 -= 0.5;
                ly1 = (ly1 === ly0 + 0.5) ? ly1 : ly1 - 1.5;
                ry0 -= 0.5;
                ry1 = (ry1 === ry0 + 0.5) ? ry1 : ry1 - 1.5;

                const svgHeight = this.svg.clientHeight;
                const RADIUS = 3;

                // Clamp positions to visible area for off-screen chunks
                // This ensures curves to off-screen lines still show a visible connection
                const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
                ly0 = clamp(ly0, -10, svgHeight + 10);
                ly1 = clamp(ly1, -10, svgHeight + 10);
                ry0 = clamp(ry0, -10, svgHeight + 10);
                ry1 = clamp(ry1, -10, svgHeight + 10);

                // Rounded rectangle culling for off-screen chunks (like Meld)
                let pathData;

                // If right side is completely off-screen (top or bottom)
                if ((ry0 < 0 && ry1 < 0) || (ry0 > svgHeight && ry1 > svgHeight)) {
                    if (ly0 === ly1) return null; // Skip if no height

                    // Draw rounded rectangle on left side only
                    pathData = `
                        M ${x0},${ly0 + RADIUS}
                        A ${RADIUS},${RADIUS} 0 0 1 ${x0 + RADIUS},${ly0}
                        L ${x0 + RADIUS},${ly0}
                        A ${RADIUS},${RADIUS} 0 0 1 ${x0},${ly0 + RADIUS}
                        L ${x0},${ly1 - RADIUS}
                        A ${RADIUS},${RADIUS} 0 0 1 ${x0 + RADIUS},${ly1}
                        L ${x0 + RADIUS},${ly1}
                        A ${RADIUS},${RADIUS} 0 0 1 ${x0},${ly1 - RADIUS}
                        Z
                    `.trim().replace(/\s+/g, ' ');
                }
                // If left side is completely off-screen (top or bottom)
                else if ((ly0 < 0 && ly1 < 0) || (ly0 > svgHeight && ly1 > svgHeight)) {
                    if (ry0 === ry1) return null; // Skip if no height

                    // Draw rounded rectangle on right side only
                    pathData = `
                        M ${x2},${ry0 + RADIUS}
                        A ${RADIUS},${RADIUS} 0 0 0 ${x2 - RADIUS},${ry0}
                        L ${x2 - RADIUS},${ry0}
                        A ${RADIUS},${RADIUS} 0 0 0 ${x2},${ry0 + RADIUS}
                        L ${x2},${ry1 - RADIUS}
                        A ${RADIUS},${RADIUS} 0 0 0 ${x2 - RADIUS},${ry1}
                        L ${x2 - RADIUS},${ry1}
                        A ${RADIUS},${RADIUS} 0 0 0 ${x2},${ry1 - RADIUS}
                        Z
                    `.trim().replace(/\s+/g, ' ');
                }
                // Normal case: both sides visible
                else {
                    pathData = `
                        M ${x0},${ly0}
                        C ${x1},${ly0} ${x1},${ry0} ${x2},${ry0}
                        L ${x2},${ry1}
                        C ${x1},${ry1} ${x1},${ly1} ${x0},${ly1}
                        Z
                    `.trim().replace(/\s+/g, ' ');
                }

                path.setAttribute('d', pathData);

                const color = this.getChunkColor(chunk.tag);
                path.setAttribute('fill', color.fill);
                path.setAttribute('stroke', color.stroke);
                path.setAttribute('stroke-width', '1');

                return path;
            }

            getChunkColor(tag) {
                const colors = {
                    'insert': {
                        fill: 'rgba(140, 200, 140, 0.3)',
                        stroke: 'rgba(140, 200, 140, 1)'
                    },
                    'delete': {
                        fill: 'rgba(240, 140, 140, 0.3)',
                        stroke: 'rgba(240, 140, 140, 1)'
                    },
                    'replace': {
                        fill: 'rgba(140, 180, 240, 0.3)',
                        stroke: 'rgba(140, 180, 240, 1)'
                    }
                };
                return colors[tag] || colors['replace'];
            }

            highlightChunk(chunkId) {
                const chunk = this.chunks[chunkId];
                if (!chunk) return;

                // Highlight the SVG path
                const path = this.svg.querySelector(`[data-chunk-id="${chunkId}"]`);
                if (path) {
                    path.classList.add('highlighted');
                }

                // Highlight lines in left pane
                for (let i = chunk.start_a; i < chunk.end_a; i++) {
                    const line = this.leftPane.querySelector(`[data-line="${i}"]`);
                    if (line) line.classList.add('chunk-highlight');
                }

                // Highlight lines in right pane
                for (let i = chunk.start_b; i < chunk.end_b; i++) {
                    const line = this.rightPane.querySelector(`[data-line="${i}"]`);
                    if (line) line.classList.add('chunk-highlight');
                }
            }

            unhighlightChunk(chunkId) {
                const chunk = this.chunks[chunkId];
                if (!chunk) return;

                // Remove highlight from SVG path
                const path = this.svg.querySelector(`[data-chunk-id="${chunkId}"]`);
                if (path) {
                    path.classList.remove('highlighted');
                }

                // Remove highlight from left pane lines
                for (let i = chunk.start_a; i < chunk.end_a; i++) {
                    const line = this.leftPane.querySelector(`[data-line="${i}"]`);
                    if (line) line.classList.remove('chunk-highlight');
                }

                // Remove highlight from right pane lines
                for (let i = chunk.start_b; i < chunk.end_b; i++) {
                    const line = this.rightPane.querySelector(`[data-line="${i}"]`);
                    if (line) line.classList.remove('chunk-highlight');
                }
            }
        }

        // Initialize the diff renderer
        const leftPane = document.getElementById('left-pane');
        const rightPane = document.getElementById('right-pane');
        const linkmap = document.getElementById('linkmap');
        const linkmapCanvas = document.getElementById('linkmap-canvas');

        const renderer = new DiffRenderer(leftPane, rightPane, linkmap, linkmapCanvas);

        // Log initialization
        console.log('Diff renderer initialized with', chunks.length, 'chunks');
    </script>
</body>
</html>